<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Plante: components/curl/lib/vtls/nss.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Plante
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('nss_8c_source.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">nss.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="nss_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/***************************************************************************</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *                                  _   _ ____  _</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *  Project                     ___| | | |  _ \| |</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *                             / __| | | | |_) | |</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *                            | (__| |_| |  _ &lt;| |___</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *                             \___|\___/|_| \_\_____|</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * Copyright (C) 1998 - 2018, Daniel Stenberg, &lt;daniel@haxx.se&gt;, et al.</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * This software is licensed as described in the file COPYING, which</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * you should have received as part of this distribution. The terms</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * are also available at https://curl.haxx.se/docs/copyright.html.</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * You may opt to use, copy, modify, merge, publish, distribute and/or sell</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * copies of the Software, and permit persons to whom the Software is</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * furnished to do so, under the terms of the COPYING file.</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * This software is distributed on an &quot;AS IS&quot; basis, WITHOUT WARRANTY OF ANY</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * KIND, either express or implied.</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> ***************************************************************************/</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * Source file for all NSS-specific code for the TLS/SSL layer. No code</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * but vtls.c should ever call or use these functions.</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="curl__setup_8h.html">curl_setup.h</a>&quot;</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#ifdef USE_NSS</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="urldata_8h.html">urldata.h</a>&quot;</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="sendf_8h.html">sendf.h</a>&quot;</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="formdata_8h.html">formdata.h</a>&quot;</span> <span class="comment">/* for the boundary function */</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="url_8h.html">url.h</a>&quot;</span> <span class="comment">/* for the ssl config check function */</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="connect_8h.html">connect.h</a>&quot;</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="strcase_8h.html">strcase.h</a>&quot;</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="select_8h.html">select.h</a>&quot;</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="vtls_8h.html">vtls.h</a>&quot;</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="llist_8h.html">llist.h</a>&quot;</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="curl__printf_8h.html">curl_printf.h</a>&quot;</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="nssg_8h.html">nssg.h</a>&quot;</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;nspr.h&gt;</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;nss.h&gt;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;ssl.h&gt;</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;sslerr.h&gt;</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &lt;secerr.h&gt;</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &lt;secmod.h&gt;</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &lt;sslproto.h&gt;</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &lt;prtypes.h&gt;</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &lt;pk11pub.h&gt;</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &lt;prio.h&gt;</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &lt;secitem.h&gt;</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &lt;secport.h&gt;</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#include &lt;certdb.h&gt;</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#include &lt;base64.h&gt;</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#include &lt;cert.h&gt;</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor">#include &lt;prerror.h&gt;</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#include &lt;keyhi.h&gt;</span>         <span class="comment">/* for SECKEY_DestroyPublicKey() */</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#include &lt;private/pprio.h&gt;</span> <span class="comment">/* for PR_ImportTCPSocket */</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor">#define NSSVERNUM ((NSS_VMAJOR&lt;&lt;16)|(NSS_VMINOR&lt;&lt;8)|NSS_VPATCH)</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="preprocessor">#if NSSVERNUM &gt;= 0x030f00 </span><span class="comment">/* 3.15.0 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor">#include &lt;ocsp.h&gt;</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="strcase_8h.html">strcase.h</a>&quot;</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="warnless_8h.html">warnless.h</a>&quot;</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="x509asn1_8h.html">x509asn1.h</a>&quot;</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">/* The last #include files should be: */</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="curl__memory_8h.html">curl_memory.h</a>&quot;</span></div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="memdebug_8h.html">memdebug.h</a>&quot;</span></div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="preprocessor">#define SSL_DIR &quot;/etc/pki/nssdb&quot;</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment">/* enough to fit the string &quot;PEM Token #[0|1]&quot; */</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="preprocessor">#define SLOTSIZE 13</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keyword">struct </span>ssl_backend_data {</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  PRFileDesc *handle;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keywordtype">char</span> *client_nickname;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="get_8d.html#a38b0ef81b65f2aee282c8c217a123176">data</a>;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keyword">struct </span><a class="code" href="structcurl__llist.html">curl_llist</a> obj_list;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  PK11GenericObject *obj_clicert;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;};</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="preprocessor">#define BACKEND connssl-&gt;backend</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="keyword">static</span> PRLock *nss_initlock = NULL;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="keyword">static</span> PRLock *nss_crllock = NULL;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="keyword">static</span> PRLock *nss_findslot_lock = NULL;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="keyword">static</span> PRLock *nss_trustload_lock = NULL;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcurl__llist.html">curl_llist</a> nss_crl_list;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="keyword">static</span> NSSInitContext *nss_context = NULL;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="_b_l_e_device_8cpp.html#aedeffc7d23da25d52b9a50045189fe2b">initialized</a> = 0;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">/* type used to wrap pointers as list nodes */</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="keyword">struct </span>ptr_list_wrap {</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordtype">void</span> *<a class="code" href="unit1330_8c.html#a367d241c5c363105ee629417d1dfba75">ptr</a>;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keyword">struct </span><a class="code" href="structcurl__llist__element.html">curl_llist_element</a> node;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;};</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a>;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordtype">int</span> num;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;} cipher_s;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor">#define PK11_SETATTRS(_attr, _idx, _type, _val, _len) do {  \</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor">  CK_ATTRIBUTE *ptr = (_attr) + ((_idx)++);                 \</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor">  ptr-&gt;type = (_type);                                      \</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor">  ptr-&gt;pValue = (_val);                                     \</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="preprocessor">  ptr-&gt;ulValueLen = (_len);                                 \</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="preprocessor">} WHILE_FALSE</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="preprocessor">#define CERT_NewTempCertificate __CERT_NewTempCertificate</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="preprocessor">#define NUM_OF_CIPHERS sizeof(cipherlist)/sizeof(cipherlist[0])</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> cipher_s cipherlist[] = {</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="comment">/* SSL2 cipher suites */</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  {<span class="stringliteral">&quot;rc4&quot;</span>,                        SSL_EN_RC4_128_WITH_MD5},</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  {<span class="stringliteral">&quot;rc4-md5&quot;</span>,                    SSL_EN_RC4_128_WITH_MD5},</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  {<span class="stringliteral">&quot;rc4export&quot;</span>,                  SSL_EN_RC4_128_EXPORT40_WITH_MD5},</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  {<span class="stringliteral">&quot;rc2&quot;</span>,                        SSL_EN_RC2_128_CBC_WITH_MD5},</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  {<span class="stringliteral">&quot;rc2export&quot;</span>,                  SSL_EN_RC2_128_CBC_EXPORT40_WITH_MD5},</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  {<span class="stringliteral">&quot;des&quot;</span>,                        SSL_EN_DES_64_CBC_WITH_MD5},</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  {<span class="stringliteral">&quot;desede3&quot;</span>,                    SSL_EN_DES_192_EDE3_CBC_WITH_MD5},</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="comment">/* SSL3/TLS cipher suites */</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  {<span class="stringliteral">&quot;rsa_rc4_128_md5&quot;</span>,            SSL_RSA_WITH_RC4_128_MD5},</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  {<span class="stringliteral">&quot;rsa_rc4_128_sha&quot;</span>,            SSL_RSA_WITH_RC4_128_SHA},</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  {<span class="stringliteral">&quot;rsa_3des_sha&quot;</span>,               SSL_RSA_WITH_3DES_EDE_CBC_SHA},</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  {<span class="stringliteral">&quot;rsa_des_sha&quot;</span>,                SSL_RSA_WITH_DES_CBC_SHA},</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  {<span class="stringliteral">&quot;rsa_rc4_40_md5&quot;</span>,             SSL_RSA_EXPORT_WITH_RC4_40_MD5},</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  {<span class="stringliteral">&quot;rsa_rc2_40_md5&quot;</span>,             SSL_RSA_EXPORT_WITH_RC2_CBC_40_MD5},</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  {<span class="stringliteral">&quot;rsa_null_md5&quot;</span>,               SSL_RSA_WITH_NULL_MD5},</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  {<span class="stringliteral">&quot;rsa_null_sha&quot;</span>,               SSL_RSA_WITH_NULL_SHA},</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  {<span class="stringliteral">&quot;fips_3des_sha&quot;</span>,              SSL_RSA_FIPS_WITH_3DES_EDE_CBC_SHA},</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  {<span class="stringliteral">&quot;fips_des_sha&quot;</span>,               SSL_RSA_FIPS_WITH_DES_CBC_SHA},</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  {<span class="stringliteral">&quot;fortezza&quot;</span>,                   SSL_FORTEZZA_DMS_WITH_FORTEZZA_CBC_SHA},</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  {<span class="stringliteral">&quot;fortezza_rc4_128_sha&quot;</span>,       SSL_FORTEZZA_DMS_WITH_RC4_128_SHA},</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  {<span class="stringliteral">&quot;fortezza_null&quot;</span>,              SSL_FORTEZZA_DMS_WITH_NULL_SHA},</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  <span class="comment">/* TLS 1.0: Exportable 56-bit Cipher Suites. */</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  {<span class="stringliteral">&quot;rsa_des_56_sha&quot;</span>,             TLS_RSA_EXPORT1024_WITH_DES_CBC_SHA},</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  {<span class="stringliteral">&quot;rsa_rc4_56_sha&quot;</span>,             TLS_RSA_EXPORT1024_WITH_RC4_56_SHA},</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="comment">/* AES ciphers. */</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  {<span class="stringliteral">&quot;dhe_dss_aes_128_cbc_sha&quot;</span>,    TLS_DHE_DSS_WITH_AES_128_CBC_SHA},</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  {<span class="stringliteral">&quot;dhe_dss_aes_256_cbc_sha&quot;</span>,    TLS_DHE_DSS_WITH_AES_256_CBC_SHA},</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  {<span class="stringliteral">&quot;dhe_rsa_aes_128_cbc_sha&quot;</span>,    TLS_DHE_RSA_WITH_AES_128_CBC_SHA},</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  {<span class="stringliteral">&quot;dhe_rsa_aes_256_cbc_sha&quot;</span>,    TLS_DHE_RSA_WITH_AES_256_CBC_SHA},</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  {<span class="stringliteral">&quot;rsa_aes_128_sha&quot;</span>,            TLS_RSA_WITH_AES_128_CBC_SHA},</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  {<span class="stringliteral">&quot;rsa_aes_256_sha&quot;</span>,            TLS_RSA_WITH_AES_256_CBC_SHA},</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="comment">/* ECC ciphers. */</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  {<span class="stringliteral">&quot;ecdh_ecdsa_null_sha&quot;</span>,        TLS_ECDH_ECDSA_WITH_NULL_SHA},</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  {<span class="stringliteral">&quot;ecdh_ecdsa_rc4_128_sha&quot;</span>,     TLS_ECDH_ECDSA_WITH_RC4_128_SHA},</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  {<span class="stringliteral">&quot;ecdh_ecdsa_3des_sha&quot;</span>,        TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA},</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  {<span class="stringliteral">&quot;ecdh_ecdsa_aes_128_sha&quot;</span>,     TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA},</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  {<span class="stringliteral">&quot;ecdh_ecdsa_aes_256_sha&quot;</span>,     TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA},</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_null_sha&quot;</span>,       TLS_ECDHE_ECDSA_WITH_NULL_SHA},</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_rc4_128_sha&quot;</span>,    TLS_ECDHE_ECDSA_WITH_RC4_128_SHA},</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_3des_sha&quot;</span>,       TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA},</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_aes_128_sha&quot;</span>,    TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA},</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_aes_256_sha&quot;</span>,    TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA},</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  {<span class="stringliteral">&quot;ecdh_rsa_null_sha&quot;</span>,          TLS_ECDH_RSA_WITH_NULL_SHA},</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  {<span class="stringliteral">&quot;ecdh_rsa_128_sha&quot;</span>,           TLS_ECDH_RSA_WITH_RC4_128_SHA},</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  {<span class="stringliteral">&quot;ecdh_rsa_3des_sha&quot;</span>,          TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA},</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  {<span class="stringliteral">&quot;ecdh_rsa_aes_128_sha&quot;</span>,       TLS_ECDH_RSA_WITH_AES_128_CBC_SHA},</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  {<span class="stringliteral">&quot;ecdh_rsa_aes_256_sha&quot;</span>,       TLS_ECDH_RSA_WITH_AES_256_CBC_SHA},</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_null&quot;</span>,             TLS_ECDHE_RSA_WITH_NULL_SHA},</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_rc4_128_sha&quot;</span>,      TLS_ECDHE_RSA_WITH_RC4_128_SHA},</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_3des_sha&quot;</span>,         TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA},</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_aes_128_sha&quot;</span>,      TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA},</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_aes_256_sha&quot;</span>,      TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA},</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  {<span class="stringliteral">&quot;ecdh_anon_null_sha&quot;</span>,         TLS_ECDH_anon_WITH_NULL_SHA},</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  {<span class="stringliteral">&quot;ecdh_anon_rc4_128sha&quot;</span>,       TLS_ECDH_anon_WITH_RC4_128_SHA},</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  {<span class="stringliteral">&quot;ecdh_anon_3des_sha&quot;</span>,         TLS_ECDH_anon_WITH_3DES_EDE_CBC_SHA},</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  {<span class="stringliteral">&quot;ecdh_anon_aes_128_sha&quot;</span>,      TLS_ECDH_anon_WITH_AES_128_CBC_SHA},</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  {<span class="stringliteral">&quot;ecdh_anon_aes_256_sha&quot;</span>,      TLS_ECDH_anon_WITH_AES_256_CBC_SHA},</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="preprocessor">#ifdef TLS_RSA_WITH_NULL_SHA256</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;  <span class="comment">/* new HMAC-SHA256 cipher suites specified in RFC */</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  {<span class="stringliteral">&quot;rsa_null_sha_256&quot;</span>,                TLS_RSA_WITH_NULL_SHA256},</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  {<span class="stringliteral">&quot;rsa_aes_128_cbc_sha_256&quot;</span>,         TLS_RSA_WITH_AES_128_CBC_SHA256},</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  {<span class="stringliteral">&quot;rsa_aes_256_cbc_sha_256&quot;</span>,         TLS_RSA_WITH_AES_256_CBC_SHA256},</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  {<span class="stringliteral">&quot;dhe_rsa_aes_128_cbc_sha_256&quot;</span>,     TLS_DHE_RSA_WITH_AES_128_CBC_SHA256},</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  {<span class="stringliteral">&quot;dhe_rsa_aes_256_cbc_sha_256&quot;</span>,     TLS_DHE_RSA_WITH_AES_256_CBC_SHA256},</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_aes_128_cbc_sha_256&quot;</span>, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256},</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_aes_128_cbc_sha_256&quot;</span>,   TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256},</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="preprocessor">#ifdef TLS_RSA_WITH_AES_128_GCM_SHA256</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="comment">/* AES GCM cipher suites in RFC 5288 and RFC 5289 */</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  {<span class="stringliteral">&quot;rsa_aes_128_gcm_sha_256&quot;</span>,         TLS_RSA_WITH_AES_128_GCM_SHA256},</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  {<span class="stringliteral">&quot;dhe_rsa_aes_128_gcm_sha_256&quot;</span>,     TLS_DHE_RSA_WITH_AES_128_GCM_SHA256},</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  {<span class="stringliteral">&quot;dhe_dss_aes_128_gcm_sha_256&quot;</span>,     TLS_DHE_DSS_WITH_AES_128_GCM_SHA256},</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_aes_128_gcm_sha_256&quot;</span>, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256},</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  {<span class="stringliteral">&quot;ecdh_ecdsa_aes_128_gcm_sha_256&quot;</span>,  TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256},</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_aes_128_gcm_sha_256&quot;</span>,   TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256},</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  {<span class="stringliteral">&quot;ecdh_rsa_aes_128_gcm_sha_256&quot;</span>,    TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256},</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="preprocessor">#ifdef TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="comment">/* cipher suites using SHA384 */</span></div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  {<span class="stringliteral">&quot;rsa_aes_256_gcm_sha_384&quot;</span>,         TLS_RSA_WITH_AES_256_GCM_SHA384},</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  {<span class="stringliteral">&quot;dhe_rsa_aes_256_gcm_sha_384&quot;</span>,     TLS_DHE_RSA_WITH_AES_256_GCM_SHA384},</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  {<span class="stringliteral">&quot;dhe_dss_aes_256_gcm_sha_384&quot;</span>,     TLS_DHE_DSS_WITH_AES_256_GCM_SHA384},</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_aes_256_sha_384&quot;</span>,     TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384},</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_aes_256_sha_384&quot;</span>,       TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384},</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  {<span class="stringliteral">&quot;ecdhe_ecdsa_aes_256_gcm_sha_384&quot;</span>, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384},</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  {<span class="stringliteral">&quot;ecdhe_rsa_aes_256_gcm_sha_384&quot;</span>,   TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384},</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="preprocessor">#ifdef TLS_DHE_RSA_WITH_CHACHA20_POLY1305_SHA256</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  <span class="comment">/* chacha20-poly1305 cipher suites */</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160; {<span class="stringliteral">&quot;ecdhe_rsa_chacha20_poly1305_sha_256&quot;</span>,</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;     TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256},</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; {<span class="stringliteral">&quot;ecdhe_ecdsa_chacha20_poly1305_sha_256&quot;</span>,</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;     TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256},</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160; {<span class="stringliteral">&quot;dhe_rsa_chacha20_poly1305_sha_256&quot;</span>,</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;     TLS_DHE_RSA_WITH_CHACHA20_POLY1305_SHA256},</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;};</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor">#ifdef WIN32</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *pem_library = <span class="stringliteral">&quot;nsspem.dll&quot;</span>;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *trust_library = <span class="stringliteral">&quot;nssckbi.dll&quot;</span>;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *pem_library = <span class="stringliteral">&quot;libnsspem.so&quot;</span>;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *trust_library = <span class="stringliteral">&quot;libnssckbi.so&quot;</span>;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="keyword">static</span> SECMODModule *pem_module = NULL;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keyword">static</span> SECMODModule *trust_module = NULL;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">/* NSPR I/O layer we use to detect blocking direction during SSL handshake */</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="keyword">static</span> PRDescIdentity nspr_io_identity = PR_INVALID_IO_LAYER;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="keyword">static</span> PRIOMethods nspr_io_methods;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *nss_error_to_name(PRErrorCode <a class="code" href="unit1608_8c.html#afb9ed1b8a27eb20854efe6e23e297683">code</a>)</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;{</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a> = PR_ErrorToName(<a class="code" href="unit1608_8c.html#afb9ed1b8a27eb20854efe6e23e297683">code</a>);</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a>)</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a>;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown error&quot;</span>;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;}</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> nss_print_error_message(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>, PRUint32 err)</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;{</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;%s&quot;</span>, PR_ErrorToString(err, PR_LANGUAGE_I_DEFAULT));</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;}</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *nss_sslver_to_name(PRUint16 nssver)</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;{</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keywordflow">switch</span>(nssver) {</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  <span class="keywordflow">case</span> SSL_LIBRARY_VERSION_2:</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a>(<span class="stringliteral">&quot;SSLv2&quot;</span>);</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  <span class="keywordflow">case</span> SSL_LIBRARY_VERSION_3_0:</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a>(<span class="stringliteral">&quot;SSLv3&quot;</span>);</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;  <span class="keywordflow">case</span> SSL_LIBRARY_VERSION_TLS_1_0:</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a>(<span class="stringliteral">&quot;TLSv1.0&quot;</span>);</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="preprocessor">#ifdef SSL_LIBRARY_VERSION_TLS_1_1</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="keywordflow">case</span> SSL_LIBRARY_VERSION_TLS_1_1:</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a>(<span class="stringliteral">&quot;TLSv1.1&quot;</span>);</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="preprocessor">#ifdef SSL_LIBRARY_VERSION_TLS_1_2</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="keywordflow">case</span> SSL_LIBRARY_VERSION_TLS_1_2:</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a>(<span class="stringliteral">&quot;TLSv1.2&quot;</span>);</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="preprocessor">#ifdef SSL_LIBRARY_VERSION_TLS_1_3</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;  <span class="keywordflow">case</span> SSL_LIBRARY_VERSION_TLS_1_3:</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a>(<span class="stringliteral">&quot;TLSv1.3&quot;</span>);</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="mprintf_8h.html#a0d5de0d2e86ff46856dc5bc0ae371c2a">curl_maprintf</a>(<span class="stringliteral">&quot;0x%04x&quot;</span>, nssver);</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;  }</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;}</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keyword">static</span> SECStatus set_ciphers(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>, PRFileDesc * model,</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                             <span class="keywordtype">char</span> *cipher_list)</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;{</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  PRBool cipher_state[NUM_OF_CIPHERS];</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  PRBool found;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;  <span class="keywordtype">char</span> *cipher;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;  <span class="comment">/* use accessors to avoid dynamic linking issues after an update of NSS */</span></div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  <span class="keyword">const</span> PRUint16 num_implemented_ciphers = SSL_GetNumImplementedCiphers();</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  <span class="keyword">const</span> PRUint16 *implemented_ciphers = SSL_GetImplementedCiphers();</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="keywordflow">if</span>(!implemented_ciphers)</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="comment">/* First disable all ciphers. This uses a different max value in case</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">   * NSS adds more ciphers later we don&#39;t want them available by</span></div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">   * accident</span></div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">   */</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = 0; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> &lt; num_implemented_ciphers; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++) {</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    SSL_CipherPrefSet(model, implemented_ciphers[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>], PR_FALSE);</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  }</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  <span class="comment">/* Set every entry in our list to false */</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = 0; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> &lt; NUM_OF_CIPHERS; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++) {</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    cipher_state[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>] = PR_FALSE;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  }</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  cipher = cipher_list;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  <span class="keywordflow">while</span>(cipher_list &amp;&amp; (cipher_list[0])) {</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="keywordflow">while</span>((*cipher) &amp;&amp; (<a class="code" href="curl__ctype_8h.html#aad859b17f001ee9fd0b0e49a7deb27b2">ISSPACE</a>(*cipher)))</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;      ++cipher;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    cipher_list = strchr(cipher, <span class="charliteral">&#39;,&#39;</span>);</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="keywordflow">if</span>(cipher_list) {</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      *cipher_list++ = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    }</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    found = PR_FALSE;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    <span class="keywordflow">for</span>(<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = 0; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>&lt;NUM_OF_CIPHERS; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++) {</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;      <span class="keywordflow">if</span>(<a class="code" href="strcase_8h.html#a4b6a8324b9a93ddfa5413308a22bfa44">strcasecompare</a>(cipher, cipherlist[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].<a class="code" href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a>)) {</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        cipher_state[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>] = PR_TRUE;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        found = PR_TRUE;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;      }</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    }</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    <span class="keywordflow">if</span>(found == PR_FALSE) {</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;Unknown cipher in list: %s&quot;</span>, cipher);</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;      <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    }</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordflow">if</span>(cipher_list) {</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;      cipher = cipher_list;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    }</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  }</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="comment">/* Finally actually enable the selected ciphers */</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = 0; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>&lt;NUM_OF_CIPHERS; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++) {</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="keywordflow">if</span>(!cipher_state[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>])</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;      <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordflow">if</span>(SSL_CipherPrefSet(model, cipherlist[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].num, PR_TRUE) != SECSuccess) {</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;cipher-suite not supported by NSS: %s&quot;</span>, cipherlist[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].<a class="code" href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a>);</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    }</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  }</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="keywordflow">return</span> SECSuccess;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;}</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment"> * Return true if at least one cipher-suite is enabled. Used to determine</span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="comment"> * if we need to call NSS_SetDomesticPolicy() to enable the default ciphers.</span></div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> any_cipher_enabled(<span class="keywordtype">void</span>)</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;{</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="keywordflow">for</span>(<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = 0; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>&lt;NUM_OF_CIPHERS; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++) {</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    PRInt32 policy = 0;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    SSL_CipherPolicyGet(cipherlist[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>].num, &amp;policy);</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordflow">if</span>(policy)</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="multi-debugcallback_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  }</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl__setup__once_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;}</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment"> * Determine whether the nickname passed in is a filename that needs to</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment"> * be loaded as a PEM or a regular NSS nickname.</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="comment"> * returns 1 for a file</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="comment"> * returns 0 for not a file (NSS nickname)</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> is_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>)</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;{</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  <a class="code" href="curl__setup_8h.html#a1c6e64692c9b7c6e7dc70adb398b3115">struct_stat</a> st;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a> == NULL)</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="config-win32ce_8h.html#ad4ea824bd0fcae61733c900a5cab1e01">stat</a>(<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, &amp;st) == 0)</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    <span class="keywordflow">if</span>(S_ISREG(st.st_mode))</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;      <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;}</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">/* Check if the given string is filename or nickname of a certificate.  If the</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment"> * given string is recognized as filename, return NULL.  If the given string is</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="comment"> * recognized as nickname, return a duplicated string.  The returned string</span></div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment"> * should be later deallocated using free().  If the OOM failure occurs, we</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="comment"> * return NULL, too.</span></div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *dup_nickname(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="unit1398_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>)</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;{</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="config_8d.html#a9fb4830d0cbef7d3cf48425ce59f580a">n</a>;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  <span class="keywordflow">if</span>(!is_file(<a class="code" href="unit1398_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>))</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="comment">/* no such file exists, use the string as nickname */</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a>(<a class="code" href="unit1398_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>);</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="comment">/* search the first slash; we require at least one slash in a file name */</span></div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <a class="code" href="config_8d.html#a9fb4830d0cbef7d3cf48425ce59f580a">n</a> = strchr(<a class="code" href="unit1398_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>, <span class="charliteral">&#39;/&#39;</span>);</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="config_8d.html#a9fb4830d0cbef7d3cf48425ce59f580a">n</a>) {</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;warning: certificate file name \&quot;%s\&quot; handled as nickname; &quot;</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;          <span class="stringliteral">&quot;please use \&quot;./%s\&quot; to force file name\n&quot;</span>, <a class="code" href="unit1398_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>, <a class="code" href="unit1398_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>);</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a>(<a class="code" href="unit1398_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>);</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  }</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="comment">/* we&#39;ll use the PEM reader to read the certificate from file */</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;}</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">/* Lock/unlock wrapper for PK11_FindSlotByName() to work around race condition</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="comment"> * in nssSlot_IsTokenPresent() causing spurious SEC_ERROR_NO_TOKEN.  For more</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment"> * details, go to &lt;https://bugzilla.mozilla.org/1297397&gt;.</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keyword">static</span> PK11SlotInfo* nss_find_slot_by_name(<span class="keyword">const</span> <span class="keywordtype">char</span> *slot_name)</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;{</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  PK11SlotInfo *slot;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  PR_Lock(nss_findslot_lock);</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  slot = PK11_FindSlotByName(slot_name);</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  PR_Unlock(nss_findslot_lock);</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  <span class="keywordflow">return</span> slot;</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;}</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="comment">/* wrap &#39;ptr&#39; as list node and tail-insert into &#39;list&#39; */</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> insert_wrapped_ptr(<span class="keyword">struct</span> <a class="code" href="structcurl__llist.html">curl_llist</a> *list, <span class="keywordtype">void</span> *<a class="code" href="unit1330_8c.html#a367d241c5c363105ee629417d1dfba75">ptr</a>)</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;{</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keyword">struct </span>ptr_list_wrap *wrap = <a class="code" href="curl__memory_8h.html#a2eb0b03d1a9de9615a291b1205969069">malloc</a>(<span class="keyword">sizeof</span>(*wrap));</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  <span class="keywordflow">if</span>(!wrap)</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a>;</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  wrap-&gt;ptr = <a class="code" href="unit1330_8c.html#a367d241c5c363105ee629417d1dfba75">ptr</a>;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <a class="code" href="llist_8c.html#a9fb691307db5bfd5d29315b96b56ad2b">Curl_llist_insert_next</a>(list, list-&gt;<a class="code" href="structcurl__llist.html#a04c1d20c09bc187d0eb71fbaf463a4b7">tail</a>, wrap, &amp;wrap-&gt;node);</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;}</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="comment">/* Call PK11_CreateGenericObject() with the given obj_class and filename.  If</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment"> * the call succeeds, append the object handle to the list of objects so that</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment"> * the object can be destroyed in Curl_nss_close(). */</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_create_object(<span class="keyword">struct</span> <a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl,</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                                  CK_OBJECT_CLASS obj_class,</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                                  <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, <span class="keywordtype">bool</span> cacert)</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;{</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  PK11SlotInfo *slot;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  PK11GenericObject *obj;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  CK_BBOOL cktrue = CK_TRUE;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  CK_BBOOL ckfalse = CK_FALSE;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  CK_ATTRIBUTE attrs[<span class="comment">/* max count of attributes */</span> 4];</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="keywordtype">int</span> attr_cnt = 0;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = (cacert)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    ? <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8e6bdaad09a5404d9b01acaa93e1a797">CURLE_SSL_CACERT_BADFILE</a></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    : <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a>;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">int</span> slot_id = (cacert) ? 0 : 1;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;  <span class="keywordtype">char</span> *slot_name = <a class="code" href="curl__printf_8h.html#a3e3dfee99c81f563d18ef4626d8886e1">aprintf</a>(<span class="stringliteral">&quot;PEM Token #%d&quot;</span>, slot_id);</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  <span class="keywordflow">if</span>(!slot_name)</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a>;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  slot = nss_find_slot_by_name(slot_name);</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(slot_name);</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="keywordflow">if</span>(!slot)</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  PK11_SETATTRS(attrs, attr_cnt, CKA_CLASS, &amp;obj_class, <span class="keyword">sizeof</span>(obj_class));</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  PK11_SETATTRS(attrs, attr_cnt, CKA_TOKEN, &amp;cktrue, <span class="keyword">sizeof</span>(CK_BBOOL));</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  PK11_SETATTRS(attrs, attr_cnt, CKA_LABEL, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>,</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                (CK_ULONG)strlen(<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>) + 1);</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="keywordflow">if</span>(CKO_CERTIFICATE == obj_class) {</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    CK_BBOOL *pval = (cacert) ? (&amp;cktrue) : (&amp;ckfalse);</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    PK11_SETATTRS(attrs, attr_cnt, CKA_TRUST, pval, <span class="keyword">sizeof</span>(*pval));</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;  }</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  <span class="comment">/* PK11_CreateManagedGenericObject() was introduced in NSS 3.34 because</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="comment">   * PK11_DestroyGenericObject() does not release resources allocated by</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment">   * PK11_CreateGenericObject() early enough.  */</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  obj =</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="preprocessor">#ifdef HAVE_PK11_CREATEMANAGEDGENERICOBJECT</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    PK11_CreateManagedGenericObject</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    PK11_CreateGenericObject</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    (slot, attrs, attr_cnt, PR_FALSE);</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  PK11_FreeSlot(slot);</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  <span class="keywordflow">if</span>(!obj)</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  <span class="keywordflow">if</span>(insert_wrapped_ptr(&amp;BACKEND-&gt;obj_list, obj) != <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>) {</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    PK11_DestroyGenericObject(obj);</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a>;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  }</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  <span class="keywordflow">if</span>(!cacert &amp;&amp; CKO_CERTIFICATE == obj_class)</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="comment">/* store reference to a client certificate */</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    BACKEND-&gt;obj_clicert = obj;</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;}</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="comment">/* Destroy the NSS object whose handle is given by ptr.  This function is</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="comment"> * a callback of Curl_llist_alloc() used by Curl_llist_destroy() to destroy</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment"> * NSS objects in Curl_nss_close() */</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> nss_destroy_object(<span class="keywordtype">void</span> *user, <span class="keywordtype">void</span> *<a class="code" href="unit1330_8c.html#a367d241c5c363105ee629417d1dfba75">ptr</a>)</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;{</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  <span class="keyword">struct </span>ptr_list_wrap *wrap = (<span class="keyword">struct </span>ptr_list_wrap *) <a class="code" href="unit1330_8c.html#a367d241c5c363105ee629417d1dfba75">ptr</a>;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  PK11GenericObject *obj = (PK11GenericObject *) wrap-&gt;ptr;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  (<span class="keywordtype">void</span>) user;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  PK11_DestroyGenericObject(obj);</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;  <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(wrap);</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;}</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">/* same as nss_destroy_object() but for CRL items */</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> nss_destroy_crl_item(<span class="keywordtype">void</span> *user, <span class="keywordtype">void</span> *<a class="code" href="unit1330_8c.html#a367d241c5c363105ee629417d1dfba75">ptr</a>)</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;{</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  <span class="keyword">struct </span>ptr_list_wrap *wrap = (<span class="keyword">struct </span>ptr_list_wrap *) <a class="code" href="unit1330_8c.html#a367d241c5c363105ee629417d1dfba75">ptr</a>;</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;  SECItem *crl_der = (SECItem *) wrap-&gt;ptr;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  (<span class="keywordtype">void</span>) user;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  SECITEM_FreeItem(crl_der, PR_TRUE);</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(wrap);</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;}</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_load_cert(<span class="keyword">struct</span> <a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *ssl,</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;                              <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, PRBool cacert)</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;{</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = (cacert)</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    ? <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8e6bdaad09a5404d9b01acaa93e1a797">CURLE_SSL_CACERT_BADFILE</a></div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    : <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a>;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;  <span class="comment">/* libnsspem.so leaks memory if the requested file does not exist.  For more</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">   * details, go to &lt;https://bugzilla.redhat.com/734760&gt;. */</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  <span class="keywordflow">if</span>(is_file(<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>))</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_create_object(ssl, CKO_CERTIFICATE, <a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, cacert);</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> &amp;&amp; !cacert) {</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="comment">/* we have successfully loaded a client certificate */</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    CERTCertificate *cert;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <span class="keywordtype">char</span> *nickname = NULL;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordtype">char</span> *<a class="code" href="config_8d.html#a9fb4830d0cbef7d3cf48425ce59f580a">n</a> = strrchr(<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, <span class="charliteral">&#39;/&#39;</span>);</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="config_8d.html#a9fb4830d0cbef7d3cf48425ce59f580a">n</a>)</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;      <a class="code" href="config_8d.html#a9fb4830d0cbef7d3cf48425ce59f580a">n</a>++;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="comment">/* The following undocumented magic helps to avoid a SIGSEGV on call</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="comment">     * of PK11_ReadRawAttribute() from SelectClientCert() when using an</span></div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">     * immature version of libnsspem.so.  For more details, go to</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">     * &lt;https://bugzilla.redhat.com/733685&gt;. */</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    nickname = <a class="code" href="curl__printf_8h.html#a3e3dfee99c81f563d18ef4626d8886e1">aprintf</a>(<span class="stringliteral">&quot;PEM Token #1:%s&quot;</span>, <a class="code" href="config_8d.html#a9fb4830d0cbef7d3cf48425ce59f580a">n</a>);</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    <span class="keywordflow">if</span>(nickname) {</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;      cert = PK11_FindCertFromNickname(nickname, NULL);</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      <span class="keywordflow">if</span>(cert)</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        CERT_DestroyCertificate(cert);</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;      <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(nickname);</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    }</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;  }</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;}</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="comment">/* add given CRL to cache if it is not already there */</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_cache_crl(SECItem *crl_der)</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;{</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  CERTCertDBHandle *db = CERT_GetDefaultCertDB();</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  CERTSignedCrl *crl = SEC_FindCrlByDERCert(db, crl_der, 0);</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  <span class="keywordflow">if</span>(crl) {</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <span class="comment">/* CRL already cached */</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    SEC_DestroyCrl(crl);</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    SECITEM_FreeItem(crl_der, PR_TRUE);</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  }</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  <span class="comment">/* acquire lock before call of CERT_CacheCRL() and accessing nss_crl_list */</span></div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  PR_Lock(nss_crllock);</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="comment">/* store the CRL item so that we can free it in Curl_nss_cleanup() */</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="keywordflow">if</span>(insert_wrapped_ptr(&amp;nss_crl_list, crl_der) != <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>) {</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    SECITEM_FreeItem(crl_der, PR_TRUE);</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    PR_Unlock(nss_crllock);</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a>;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;  }</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="keywordflow">if</span>(SECSuccess != CERT_CacheCRL(db, crl_der)) {</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    <span class="comment">/* unable to cache CRL */</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;    PR_Unlock(nss_crllock);</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a241c54474fe64668004fc8d15496085c">CURLE_SSL_CRL_BADFILE</a>;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  }</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  <span class="comment">/* we need to clear session cache, so that the CRL could take effect */</span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  SSL_ClearSessionCache();</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  PR_Unlock(nss_crllock);</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;}</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_load_crl(<span class="keyword">const</span> <span class="keywordtype">char</span> *crlfilename)</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;{</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  PRFileDesc *infile;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  PRFileInfo  info;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  SECItem filedata = { 0, NULL, 0 };</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  SECItem *crl_der = NULL;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;  <span class="keywordtype">char</span> *body;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;  infile = PR_Open(crlfilename, PR_RDONLY, 0);</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;  <span class="keywordflow">if</span>(!infile)</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a241c54474fe64668004fc8d15496085c">CURLE_SSL_CRL_BADFILE</a>;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;  <span class="keywordflow">if</span>(PR_SUCCESS != PR_GetOpenFileInfo(infile, &amp;info))</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    <span class="keywordflow">goto</span> <a class="code" href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a>;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;  <span class="keywordflow">if</span>(!SECITEM_AllocItem(NULL, &amp;filedata, info.size + <span class="comment">/* zero ended */</span> 1))</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="keywordflow">goto</span> <a class="code" href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a>;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  <span class="keywordflow">if</span>(info.size != PR_Read(infile, filedata.data, info.size))</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    <span class="keywordflow">goto</span> <a class="code" href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a>;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  crl_der = SECITEM_AllocItem(NULL, NULL, 0U);</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  <span class="keywordflow">if</span>(!crl_der)</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="keywordflow">goto</span> <a class="code" href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a>;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  <span class="comment">/* place a trailing zero right after the visible data */</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;  body = (<span class="keywordtype">char</span> *)filedata.data;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;  body[--filedata.len] = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  body = strstr(body, <span class="stringliteral">&quot;-----BEGIN&quot;</span>);</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;  <span class="keywordflow">if</span>(body) {</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;    <span class="comment">/* assume ASCII */</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    <span class="keywordtype">char</span> *trailer;</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="keywordtype">char</span> *begin = PORT_Strchr(body, <span class="charliteral">&#39;\n&#39;</span>);</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="keywordflow">if</span>(!begin)</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;      begin = PORT_Strchr(body, <span class="charliteral">&#39;\r&#39;</span>);</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;    <span class="keywordflow">if</span>(!begin)</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a>;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    trailer = strstr(++begin, <span class="stringliteral">&quot;-----END&quot;</span>);</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <span class="keywordflow">if</span>(!trailer)</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a>;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <span class="comment">/* retrieve DER from ASCII */</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    *trailer = <span class="charliteral">&#39;\0&#39;</span>;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keywordflow">if</span>(ATOB_ConvertAsciiToItem(crl_der, begin))</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;      <span class="keywordflow">goto</span> <a class="code" href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a>;</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;    SECITEM_FreeItem(&amp;filedata, PR_FALSE);</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  }</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="comment">/* assume DER */</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    *crl_der = filedata;</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;  PR_Close(infile);</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;  <span class="keywordflow">return</span> nss_cache_crl(crl_der);</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<a class="code" href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a>:</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;  PR_Close(infile);</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  SECITEM_FreeItem(crl_der, PR_TRUE);</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  SECITEM_FreeItem(&amp;filedata, PR_FALSE);</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a241c54474fe64668004fc8d15496085c">CURLE_SSL_CRL_BADFILE</a>;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;}</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_load_key(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, <span class="keywordtype">int</span> sockindex,</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                             <span class="keywordtype">char</span> *key_file)</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;{</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;  PK11SlotInfo *slot, *tmp;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;  SECStatus status;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *ssl = conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>;</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  (void)sockindex; <span class="comment">/* unused */</span></div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_create_object(ssl, CKO_PRIVATE_KEY, key_file, <a class="code" href="curl__setup__once_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    PR_SetError(SEC_ERROR_BAD_KEY, 0);</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  }</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  slot = nss_find_slot_by_name(<span class="stringliteral">&quot;PEM Token #1&quot;</span>);</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;  <span class="keywordflow">if</span>(!slot)</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a>;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  <span class="comment">/* This will force the token to be seen as re-inserted */</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  tmp = SECMOD_WaitForAnyTokenEvent(pem_module, 0, 0);</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  <span class="keywordflow">if</span>(tmp)</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    PK11_FreeSlot(tmp);</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  PK11_IsPresent(slot);</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  status = PK11_Authenticate(slot, PR_TRUE, <a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(key_passwd));</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  PK11_FreeSlot(slot);</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;  <span class="keywordflow">return</span> (SECSuccess == status) ? <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a> : <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a>;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;}</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> display_error(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, PRInt32 err,</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>)</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;{</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <span class="keywordflow">switch</span>(err) {</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  <span class="keywordflow">case</span> SEC_ERROR_BAD_PASSWORD:</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;Unable to load client key: Incorrect password&quot;</span>);</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <span class="keywordflow">case</span> SEC_ERROR_UNKNOWN_CERT:</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;Unable to load certificate %s&quot;</span>, <a class="code" href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>);</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">break</span>;</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;  }</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;  <span class="keywordflow">return</span> 0; <span class="comment">/* The caller will print a generic error */</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;}</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> cert_stuff(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, <span class="keywordtype">int</span> sockindex,</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;                           <span class="keywordtype">char</span> *cert_file, <span class="keywordtype">char</span> *key_file)</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;{</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;  <span class="keywordflow">if</span>(cert_file) {</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_load_cert(&amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex], cert_file, PR_FALSE);</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;      <span class="keyword">const</span> PRErrorCode err = PR_GetError();</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;      <span class="keywordflow">if</span>(!display_error(conn, err, cert_file)) {</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *err_name = nss_error_to_name(err);</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;unable to load client cert: %d (%s)&quot;</span>, err, err_name);</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;      }</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;    }</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  }</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  <span class="keywordflow">if</span>(key_file || (is_file(cert_file))) {</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    <span class="keywordflow">if</span>(key_file)</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_load_key(conn, sockindex, key_file);</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;      <span class="comment">/* In case the cert file also has the key */</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_load_key(conn, sockindex, cert_file);</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;      <span class="keyword">const</span> PRErrorCode err = PR_GetError();</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;      <span class="keywordflow">if</span>(!display_error(conn, err, key_file)) {</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">char</span> *err_name = nss_error_to_name(err);</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;        <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;unable to load client key: %d (%s)&quot;</span>, err, err_name);</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;      }</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    }</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;  }</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;}</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> *nss_get_password(PK11SlotInfo *slot, PRBool retry, <span class="keywordtype">void</span> *arg)</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;{</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;  (void)slot; <span class="comment">/* unused */</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  <span class="keywordflow">if</span>(retry || NULL == arg)</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    <span class="keywordflow">return</span> NULL;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *)PORT_Strdup((<span class="keywordtype">char</span> *)arg);</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;}</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment">/* bypass the default SSL_AuthCertificate() hook in case we do not want to</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="comment"> * verify peer */</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keyword">static</span> SECStatus nss_auth_cert_hook(<span class="keywordtype">void</span> *arg, PRFileDesc *fd, PRBool checksig,</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;                                    PRBool isServer)</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;{</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;  <span class="keyword">struct </span><a class="code" href="structconnectdata.html">connectdata</a> *conn = (<span class="keyword">struct </span><a class="code" href="structconnectdata.html">connectdata</a> *)arg;</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;<span class="preprocessor">#ifdef SSL_ENABLE_OCSP_STAPLING</span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(verifystatus)) {</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    SECStatus cacheResult;</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    <span class="keyword">const</span> SECItemArray *csa = SSL_PeerStapledOCSPResponses(fd);</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    <span class="keywordflow">if</span>(!csa) {</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;Invalid OCSP response&quot;</span>);</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;      <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    }</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="keywordflow">if</span>(csa-&gt;len == 0) {</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;No OCSP response received&quot;</span>);</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;      <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    }</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    cacheResult = CERT_CacheOCSPResponseFromSideChannel(</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;      CERT_GetDefaultCertDB(), SSL_PeerCertificate(fd),</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;      PR_Now(), &amp;csa-&gt;items[0], arg</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    );</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    <span class="keywordflow">if</span>(cacheResult != SECSuccess) {</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;Invalid OCSP response&quot;</span>);</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;      <span class="keywordflow">return</span> cacheResult;</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    }</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;  }</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(verifypeer)) {</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;skipping SSL peer certificate verification\n&quot;</span>);</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="keywordflow">return</span> SECSuccess;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  }</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  <span class="keywordflow">return</span> SSL_AuthCertificate(CERT_GetDefaultCertDB(), fd, checksig, isServer);</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;}</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> HandshakeCallback(PRFileDesc *<a class="code" href="structconnectdata.html#a13cc2123ad38902e8ad44e67f10ed7aa">sock</a>, <span class="keywordtype">void</span> *arg)</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;{</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  <span class="keyword">struct </span><a class="code" href="structconnectdata.html">connectdata</a> *conn = (<span class="keyword">struct </span><a class="code" href="structconnectdata.html">connectdata</a>*) arg;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buflenmax = 50;</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>[50];</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buflen;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  SSLNextProtoState <a class="code" href="ftp_8c.html#a77812d4945cd21094debbd06962f0f01">state</a>;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  <span class="keywordflow">if</span>(!conn-&gt;<a class="code" href="structconnectdata.html#a9312f162d29fe7f59bc2b5dbeda85d9d">bits</a>.<a class="code" href="struct_connect_bits.html#a0a00cd02ce442392e3836545ce356b6a">tls_enable_npn</a> &amp;&amp; !conn-&gt;<a class="code" href="structconnectdata.html#a9312f162d29fe7f59bc2b5dbeda85d9d">bits</a>.<a class="code" href="struct_connect_bits.html#a15d98c2eae880b790963d2b0d15a85dc">tls_enable_alpn</a>) {</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  }</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;  <span class="keywordflow">if</span>(SSL_GetNextProto(<a class="code" href="structconnectdata.html#a13cc2123ad38902e8ad44e67f10ed7aa">sock</a>, &amp;<a class="code" href="ftp_8c.html#a77812d4945cd21094debbd06962f0f01">state</a>, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, &amp;buflen, buflenmax) == SECSuccess) {</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="keywordflow">switch</span>(<a class="code" href="ftp_8c.html#a77812d4945cd21094debbd06962f0f01">state</a>) {</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="preprocessor">#if NSSVERNUM &gt;= 0x031a00 </span><span class="comment">/* 3.26.0 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="comment">/* used by NSS internally to implement 0-RTT */</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="keywordflow">case</span> SSL_NEXT_PROTO_EARLY_VALUE:</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;      <span class="comment">/* fall through! */</span></div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="keywordflow">case</span> SSL_NEXT_PROTO_NO_SUPPORT:</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    <span class="keywordflow">case</span> SSL_NEXT_PROTO_NO_OVERLAP:</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;ALPN/NPN, server did not agree to a protocol\n&quot;</span>);</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;      <span class="keywordflow">return</span>;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;<span class="preprocessor">#ifdef SSL_ENABLE_ALPN</span></div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keywordflow">case</span> SSL_NEXT_PROTO_SELECTED:</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;ALPN, server accepted to use %.*s\n&quot;</span>, buflen, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>);</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordflow">case</span> SSL_NEXT_PROTO_NEGOTIATED:</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;NPN, server accepted to use %.*s\n&quot;</span>, buflen, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>);</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;      <span class="keywordflow">break</span>;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    }</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="preprocessor">#ifdef USE_NGHTTP2</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordflow">if</span>(buflen == NGHTTP2_PROTO_VERSION_ID_LEN &amp;&amp;</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;       !memcmp(NGHTTP2_PROTO_VERSION_ID, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, NGHTTP2_PROTO_VERSION_ID_LEN)) {</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      conn-&gt;<a class="code" href="structconnectdata.html#a0c1824e51ef689efcfddaa09a72c788b">negnpn</a> = <a class="code" href="curl_8h.html#a49d83160803f433b12209ed52aafc05f">CURL_HTTP_VERSION_2</a>;</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    }</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordflow">if</span>(buflen == <a class="code" href="vtls_8h.html#a9043fcf68904db7a0844fb55857bd482">ALPN_HTTP_1_1_LENGTH</a> &amp;&amp;</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;       !memcmp(<a class="code" href="vtls_8h.html#af8e5805a5e7df10119ca90c13a2b1a79">ALPN_HTTP_1_1</a>, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, <a class="code" href="vtls_8h.html#a9043fcf68904db7a0844fb55857bd482">ALPN_HTTP_1_1_LENGTH</a>)) {</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;      conn-&gt;<a class="code" href="structconnectdata.html#a0c1824e51ef689efcfddaa09a72c788b">negnpn</a> = <a class="code" href="curl_8h.html#abc5c98fcc1211af2b80116dd6e0a035da2bdca7ce6479378784212fee3a068c74">CURL_HTTP_VERSION_1_1</a>;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    }</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;  }</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;}</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="preprocessor">#if NSSVERNUM &gt;= 0x030f04 </span><span class="comment">/* 3.15.4 */</span><span class="preprocessor"></span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="keyword">static</span> SECStatus CanFalseStartCallback(PRFileDesc *<a class="code" href="structconnectdata.html#a13cc2123ad38902e8ad44e67f10ed7aa">sock</a>, <span class="keywordtype">void</span> *client_data,</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                                       PRBool *canFalseStart)</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;{</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  <span class="keyword">struct </span><a class="code" href="structconnectdata.html">connectdata</a> *conn = client_data;</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;  SSLChannelInfo channelInfo;</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;  SSLCipherSuiteInfo cipherInfo;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;  SECStatus rv;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;  PRBool negotiatedExtension;</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;  *canFalseStart = PR_FALSE;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;  <span class="keywordflow">if</span>(SSL_GetChannelInfo(sock, &amp;channelInfo, <span class="keyword">sizeof</span>(channelInfo)) != SECSuccess)</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;    <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  <span class="keywordflow">if</span>(SSL_GetCipherSuiteInfo(channelInfo.cipherSuite, &amp;cipherInfo,</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;                            <span class="keyword">sizeof</span>(cipherInfo)) != SECSuccess)</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="comment">/* Prevent version downgrade attacks from TLS 1.2, and avoid False Start for</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;<span class="comment">   * TLS 1.3 and later. See https://bugzilla.mozilla.org/show_bug.cgi?id=861310</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="comment">   */</span></div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;  <span class="keywordflow">if</span>(channelInfo.protocolVersion != SSL_LIBRARY_VERSION_TLS_1_2)</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    <span class="keywordflow">goto</span> end;</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;  <span class="comment">/* Only allow ECDHE key exchange algorithm.</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="comment">   * See https://bugzilla.mozilla.org/show_bug.cgi?id=952863 */</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  <span class="keywordflow">if</span>(cipherInfo.keaType != ssl_kea_ecdh)</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="keywordflow">goto</span> end;</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;  <span class="comment">/* Prevent downgrade attacks on the symmetric cipher. We do not allow CBC</span></div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="comment">   * mode due to BEAST, POODLE, and other attacks on the MAC-then-Encrypt</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="comment">   * design. See https://bugzilla.mozilla.org/show_bug.cgi?id=1109766 */</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;  <span class="keywordflow">if</span>(cipherInfo.symCipher != ssl_calg_aes_gcm)</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    <span class="keywordflow">goto</span> end;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;  <span class="comment">/* Enforce ALPN or NPN to do False Start, as an indicator of server</span></div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="comment">   * compatibility. */</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  rv = SSL_HandshakeNegotiatedExtension(sock, ssl_app_layer_protocol_xtn,</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                                        &amp;negotiatedExtension);</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;  <span class="keywordflow">if</span>(rv != SECSuccess || !negotiatedExtension) {</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    rv = SSL_HandshakeNegotiatedExtension(sock, ssl_next_proto_nego_xtn,</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                                          &amp;negotiatedExtension);</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;  }</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;  <span class="keywordflow">if</span>(rv != SECSuccess || !negotiatedExtension)</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keywordflow">goto</span> end;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;  *canFalseStart = PR_TRUE;</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;Trying TLS False Start\n&quot;</span>);</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;end:</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;  <span class="keywordflow">return</span> SECSuccess;</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;}</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> display_cert_info(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>,</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                              CERTCertificate *cert)</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;{</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="keywordtype">char</span> *subject, *issuer, *common_name;</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;  PRExplodedTime printableTime;</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;  <span class="keywordtype">char</span> timeString[256];</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;  PRTime notBefore, notAfter;</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;  subject = CERT_NameToAscii(&amp;cert-&gt;subject);</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  issuer = CERT_NameToAscii(&amp;cert-&gt;issuer);</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;  common_name = CERT_GetCommonName(&amp;cert-&gt;subject);</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;\tsubject: %s\n&quot;</span>, subject);</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  CERT_GetCertTimes(cert, &amp;notBefore, &amp;notAfter);</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;  PR_ExplodeTime(notBefore, PR_GMTParameters, &amp;printableTime);</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  PR_FormatTime(timeString, 256, <span class="stringliteral">&quot;%b %d %H:%M:%S %Y GMT&quot;</span>, &amp;printableTime);</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;\tstart date: %s\n&quot;</span>, timeString);</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  PR_ExplodeTime(notAfter, PR_GMTParameters, &amp;printableTime);</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  PR_FormatTime(timeString, 256, <span class="stringliteral">&quot;%b %d %H:%M:%S %Y GMT&quot;</span>, &amp;printableTime);</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;\texpire date: %s\n&quot;</span>, timeString);</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;\tcommon name: %s\n&quot;</span>, common_name);</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;\tissuer: %s\n&quot;</span>, issuer);</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  PR_Free(subject);</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;  PR_Free(issuer);</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  PR_Free(common_name);</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;}</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> display_conn_info(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, PRFileDesc *sock)</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;{</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;  SSLChannelInfo channel;</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;  SSLCipherSuiteInfo suite;</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;  CERTCertificate *cert;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;  CERTCertificate *cert2;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;  CERTCertificate *cert3;</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  PRTime <a class="code" href="unit1399_8c.html#acf1e931ffa73126ce876102dc2186895">now</a>;</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  <span class="keywordflow">if</span>(SSL_GetChannelInfo(sock, &amp;channel, <span class="keyword">sizeof</span>(channel)) ==</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;     SECSuccess &amp;&amp; channel.length == <span class="keyword">sizeof</span>(channel) &amp;&amp;</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;     channel.cipherSuite) {</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="keywordflow">if</span>(SSL_GetCipherSuiteInfo(channel.cipherSuite,</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                              &amp;suite, <span class="keyword">sizeof</span>(suite)) == SECSuccess) {</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;SSL connection using %s\n&quot;</span>, suite.cipherSuiteName);</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    }</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;  }</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;  cert = SSL_PeerCertificate(sock);</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  <span class="keywordflow">if</span>(cert) {</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;Server certificate:\n&quot;</span>);</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="keywordflow">if</span>(!conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>-&gt;<a class="code" href="struct_curl__easy.html#abcc5aa61af150adc1388b1a3492c2599">set</a>.<a class="code" href="struct_user_defined.html#a3e98f04627c6f5ca7a9ae8c3edd85bd2">ssl</a>.<a class="code" href="structssl__config__data.html#a0280e8b30467433b1864e5be8060274e">certinfo</a>) {</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;      display_cert_info(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, cert);</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;      CERT_DestroyCertificate(cert);</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    }</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;      <span class="comment">/* Count certificates in chain. */</span></div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;      <a class="code" href="unit1399_8c.html#acf1e931ffa73126ce876102dc2186895">now</a> = PR_Now();</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;      <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = 1;</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;      <span class="keywordflow">if</span>(!cert-&gt;isRoot) {</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;        cert2 = CERT_FindCertIssuer(cert, <a class="code" href="unit1399_8c.html#acf1e931ffa73126ce876102dc2186895">now</a>, certUsageSSLCA);</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="keywordflow">while</span>(cert2) {</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;          <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++;</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;          <span class="keywordflow">if</span>(cert2-&gt;isRoot) {</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            CERT_DestroyCertificate(cert2);</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;          }</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;          cert3 = CERT_FindCertIssuer(cert2, <a class="code" href="unit1399_8c.html#acf1e931ffa73126ce876102dc2186895">now</a>, certUsageSSLCA);</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;          CERT_DestroyCertificate(cert2);</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;          cert2 = cert3;</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        }</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;      }</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = Curl_ssl_init_certinfo(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>);</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;      <span class="keywordflow">if</span>(!<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        <span class="keywordflow">for</span>(<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a> = 0; cert; cert = cert2) {</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;          <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = Curl_extract_certinfo(conn, <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++, (<span class="keywordtype">char</span> *)cert-&gt;derCert.data,</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                                         (<span class="keywordtype">char</span> *)cert-&gt;derCert.data +</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                                                 cert-&gt;derCert.len);</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;          <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;          <span class="keywordflow">if</span>(cert-&gt;isRoot) {</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;            CERT_DestroyCertificate(cert);</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;          }</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;          cert2 = CERT_FindCertIssuer(cert, <a class="code" href="unit1399_8c.html#acf1e931ffa73126ce876102dc2186895">now</a>, certUsageSSLCA);</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;          CERT_DestroyCertificate(cert);</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        }</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;      }</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    }</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;  }</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;}</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;<span class="keyword">static</span> SECStatus BadCertHandler(<span class="keywordtype">void</span> *arg, PRFileDesc *sock)</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;{</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;  <span class="keyword">struct </span><a class="code" href="structconnectdata.html">connectdata</a> *conn = (<span class="keyword">struct </span><a class="code" href="structconnectdata.html">connectdata</a> *)arg;</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;  PRErrorCode err = PR_GetError();</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;  CERTCertificate *cert;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;  <span class="comment">/* remember the cert verification result */</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#ad333981ba88648c413730d21d5418405">SSL_IS_PROXY</a>())</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <a class="code" href="structdata.html">data</a>-&gt;set.proxy_ssl.certverifyresult = err;</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    <a class="code" href="structdata.html">data</a>-&gt;set.ssl.certverifyresult = err;</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;  <span class="keywordflow">if</span>(err == SSL_ERROR_BAD_CERT_DOMAIN &amp;&amp; !<a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(verifyhost))</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;    <span class="comment">/* we are asked not to verify the host name */</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    <span class="keywordflow">return</span> SECSuccess;</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;  <span class="comment">/* print only info about the cert, the error is printed off the callback */</span></div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;  cert = SSL_PeerCertificate(sock);</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;  <span class="keywordflow">if</span>(cert) {</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;Server certificate:\n&quot;</span>);</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    display_cert_info(<a class="code" href="structdata.html">data</a>, cert);</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    CERT_DestroyCertificate(cert);</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;  }</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;  <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;}</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="keyword">static</span> SECStatus check_issuer_cert(PRFileDesc *sock,</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                                   <span class="keywordtype">char</span> *issuer_nickname)</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;{</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;  CERTCertificate *cert, *cert_issuer, *issuer;</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  SECStatus res = SECSuccess;</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;  <span class="keywordtype">void</span> *proto_win = NULL;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;  cert = SSL_PeerCertificate(sock);</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;  cert_issuer = CERT_FindCertIssuer(cert, PR_Now(), certUsageObjectSigner);</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;  proto_win = SSL_RevealPinArg(sock);</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;  issuer = PK11_FindCertFromNickname(issuer_nickname, proto_win);</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;  <span class="keywordflow">if</span>((!cert_issuer) || (!issuer))</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    res = SECFailure;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SECITEM_CompareItem(&amp;cert_issuer-&gt;derCert,</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                              &amp;issuer-&gt;derCert) != SECEqual)</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;    res = SECFailure;</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  CERT_DestroyCertificate(cert);</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  CERT_DestroyCertificate(issuer);</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;  CERT_DestroyCertificate(cert_issuer);</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <span class="keywordflow">return</span> res;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;}</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> cmp_peer_pubkey(<span class="keyword">struct</span> <a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl,</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;                                <span class="keyword">const</span> <span class="keywordtype">char</span> *pinnedpubkey)</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;{</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a785786e70ed591f03e61a7d0175d417f">CURLE_SSL_PINNEDPUBKEYNOTMATCH</a>;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = BACKEND-&gt;data;</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;  CERTCertificate *cert;</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;  <span class="keywordflow">if</span>(!pinnedpubkey)</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    <span class="comment">/* no pinned public key specified */</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;  <span class="comment">/* get peer certificate */</span></div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;  cert = SSL_PeerCertificate(BACKEND-&gt;handle);</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;  <span class="keywordflow">if</span>(cert) {</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="comment">/* extract public key from peer certificate */</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    SECKEYPublicKey *pubkey = CERT_ExtractPublicKey(cert);</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;    <span class="keywordflow">if</span>(pubkey) {</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;      <span class="comment">/* encode the public key as DER */</span></div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;      SECItem *cert_der = PK11_DEREncodePublicKey(pubkey);</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;      <span class="keywordflow">if</span>(cert_der) {</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        <span class="comment">/* compare the public key with the pinned public key */</span></div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = Curl_pin_peer_pubkey(<a class="code" href="structdata.html">data</a>, pinnedpubkey, cert_der-&gt;data,</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;                                      cert_der-&gt;len);</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        SECITEM_FreeItem(cert_der, PR_TRUE);</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;      }</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;      SECKEY_DestroyPublicKey(pubkey);</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    }</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    CERT_DestroyCertificate(cert);</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;  }</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;  <span class="comment">/* report the resulting status */</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;  <span class="keywordflow">switch</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>:</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;pinned public key verified successfully!\n&quot;</span>);</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <span class="keywordflow">break</span>;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a785786e70ed591f03e61a7d0175d417f">CURLE_SSL_PINNEDPUBKEYNOTMATCH</a>:</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;failed to verify pinned public key&quot;</span>);</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    <span class="keywordflow">break</span>;</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    <span class="comment">/* OOM, etc. */</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    <span class="keywordflow">break</span>;</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  }</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;}</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="keyword">static</span> SECStatus SelectClientCert(<span class="keywordtype">void</span> *arg, PRFileDesc *sock,</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;                                  <span class="keyword">struct</span> CERTDistNamesStr *caNames,</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;                                  <span class="keyword">struct</span> CERTCertificateStr **pRetCert,</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;                                  <span class="keyword">struct</span> SECKEYPrivateKeyStr **pRetKey)</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;{</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = (<span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *)arg;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = BACKEND-&gt;data;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> *nickname = BACKEND-&gt;client_nickname;</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> pem_slotname[] = <span class="stringliteral">&quot;PEM Token #1&quot;</span>;</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;  <span class="keywordflow">if</span>(BACKEND-&gt;obj_clicert) {</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <span class="comment">/* use the cert/key provided by PEM reader */</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    SECItem cert_der = { 0, NULL, 0 };</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    <span class="keywordtype">void</span> *proto_win = SSL_RevealPinArg(sock);</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    <span class="keyword">struct </span>CERTCertificateStr *cert;</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="keyword">struct </span>SECKEYPrivateKeyStr *<a class="code" href="unit1602_8c.html#a35af0be900467fedbb610bd6ea65ed78">key</a>;</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    PK11SlotInfo *slot = nss_find_slot_by_name(pem_slotname);</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    <span class="keywordflow">if</span>(NULL == slot) {</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: PK11 slot not found: %s&quot;</span>, pem_slotname);</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;      <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    }</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    <span class="keywordflow">if</span>(PK11_ReadRawAttribute(PK11_TypeGeneric, BACKEND-&gt;obj_clicert, CKA_VALUE,</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;                             &amp;cert_der) != SECSuccess) {</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: CKA_VALUE not found in PK11 generic object&quot;</span>);</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;      PK11_FreeSlot(slot);</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;      <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    }</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    cert = PK11_FindCertFromDERCertItem(slot, &amp;cert_der, proto_win);</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    SECITEM_FreeItem(&amp;cert_der, PR_FALSE);</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    <span class="keywordflow">if</span>(NULL == cert) {</div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: client certificate from file not found&quot;</span>);</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;      PK11_FreeSlot(slot);</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;      <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    }</div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    <a class="code" href="unit1602_8c.html#a35af0be900467fedbb610bd6ea65ed78">key</a> = PK11_FindPrivateKeyFromCert(slot, cert, NULL);</div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;    PK11_FreeSlot(slot);</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    <span class="keywordflow">if</span>(NULL == <a class="code" href="unit1602_8c.html#a35af0be900467fedbb610bd6ea65ed78">key</a>) {</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: private key from file not found&quot;</span>);</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;      CERT_DestroyCertificate(cert);</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;      <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;    }</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: client certificate from file\n&quot;</span>);</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    display_cert_info(<a class="code" href="structdata.html">data</a>, cert);</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;    *pRetCert = cert;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;    *pRetKey = <a class="code" href="unit1602_8c.html#a35af0be900467fedbb610bd6ea65ed78">key</a>;</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    <span class="keywordflow">return</span> SECSuccess;</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  }</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;  <span class="comment">/* use the default NSS hook */</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;  <span class="keywordflow">if</span>(SECSuccess != NSS_GetClientAuthData((<span class="keywordtype">void</span> *)nickname, sock, caNames,</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                                          pRetCert, pRetKey)</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;      || NULL == *pRetCert) {</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    <span class="keywordflow">if</span>(NULL == nickname)</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: client certificate not found (nickname not &quot;</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;            <span class="stringliteral">&quot;specified)&quot;</span>);</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: client certificate not found: %s&quot;</span>, nickname);</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;</div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;    <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;  }</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  <span class="comment">/* get certificate nickname if any */</span></div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;  nickname = (*pRetCert)-&gt;nickname;</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  <span class="keywordflow">if</span>(NULL == nickname)</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    nickname = <span class="stringliteral">&quot;[unknown]&quot;</span>;</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  <span class="keywordflow">if</span>(!strncmp(nickname, pem_slotname, <span class="keyword">sizeof</span>(pem_slotname) - 1U)) {</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: refusing previously loaded certificate from file: %s&quot;</span>,</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;          nickname);</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  }</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;  <span class="keywordflow">if</span>(NULL == *pRetKey) {</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: private key not found for certificate: %s&quot;</span>, nickname);</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    <span class="keywordflow">return</span> SECFailure;</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;  }</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS: using client certificate: %s\n&quot;</span>, nickname);</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;  display_cert_info(<a class="code" href="structdata.html">data</a>, *pRetCert);</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;  <span class="keywordflow">return</span> SECSuccess;</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;}</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="comment">/* update blocking direction in case of PR_WOULD_BLOCK_ERROR */</span></div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> nss_update_connecting_state(<a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1">ssl_connect_state</a> <a class="code" href="ftp_8c.html#a77812d4945cd21094debbd06962f0f01">state</a>, <span class="keywordtype">void</span> *secret)</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;{</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = (<span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *)secret;</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;  <span class="keywordflow">if</span>(PR_GetError() != PR_WOULD_BLOCK_ERROR)</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="comment">/* an unrelated error is passing by */</span></div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;  <span class="keywordflow">switch</span>(connssl-&gt;<a class="code" href="structssl__connect__data.html#a2de0f5a8b43b4e4550e22b1b8f3870e1">connecting_state</a>) {</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a02630bc60f6cd9c202c67e33784ee7a5">ssl_connect_2</a>:</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a83e9e80af0be0e0a560a5c925cc2e216">ssl_connect_2_reading</a>:</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a8c6d961fbef3442f91a0c29191e83256">ssl_connect_2_writing</a>:</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    <span class="keywordflow">break</span>;</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    <span class="comment">/* we are not called from an SSL handshake */</span></div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;  }</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;  <span class="comment">/* update the state accordingly */</span></div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;  connssl-&gt;<a class="code" href="structssl__connect__data.html#a2de0f5a8b43b4e4550e22b1b8f3870e1">connecting_state</a> = <a class="code" href="ftp_8c.html#a77812d4945cd21094debbd06962f0f01">state</a>;</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;}</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;<span class="comment">/* recv() wrapper we use to detect blocking direction during SSL handshake */</span></div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;<span class="keyword">static</span> PRInt32 nspr_io_recv(PRFileDesc *fd, <span class="keywordtype">void</span> *<a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, PRInt32 amount,</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;                            PRIntn flags, PRIntervalTime <a class="code" href="multi-uv_8c.html#afb43b78d9a22f95e721353db4408304c">timeout</a>)</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;{</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;  <span class="keyword">const</span> PRRecvFN recv_fn = fd-&gt;lower-&gt;methods-&gt;recv;</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;  <span class="keyword">const</span> PRInt32 rv = recv_fn(fd-&gt;lower, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, amount, flags, <a class="code" href="multi-uv_8c.html#afb43b78d9a22f95e721353db4408304c">timeout</a>);</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;  <span class="keywordflow">if</span>(rv &lt; 0)</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    <span class="comment">/* check for PR_WOULD_BLOCK_ERROR and update blocking direction */</span></div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    nss_update_connecting_state(<a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a83e9e80af0be0e0a560a5c925cc2e216">ssl_connect_2_reading</a>, fd-&gt;secret);</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;  <span class="keywordflow">return</span> rv;</div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;}</div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;</div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="comment">/* send() wrapper we use to detect blocking direction during SSL handshake */</span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;<span class="keyword">static</span> PRInt32 nspr_io_send(PRFileDesc *fd, <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, PRInt32 amount,</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;                            PRIntn flags, PRIntervalTime <a class="code" href="multi-uv_8c.html#afb43b78d9a22f95e721353db4408304c">timeout</a>)</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;{</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;  <span class="keyword">const</span> PRSendFN send_fn = fd-&gt;lower-&gt;methods-&gt;send;</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;  <span class="keyword">const</span> PRInt32 rv = send_fn(fd-&gt;lower, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, amount, flags, <a class="code" href="multi-uv_8c.html#afb43b78d9a22f95e721353db4408304c">timeout</a>);</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;  <span class="keywordflow">if</span>(rv &lt; 0)</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    <span class="comment">/* check for PR_WOULD_BLOCK_ERROR and update blocking direction */</span></div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    nss_update_connecting_state(<a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a8c6d961fbef3442f91a0c29191e83256">ssl_connect_2_writing</a>, fd-&gt;secret);</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;  <span class="keywordflow">return</span> rv;</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;}</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;<span class="comment">/* close() wrapper to avoid assertion failure due to fd-&gt;secret != NULL */</span></div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="keyword">static</span> PRStatus nspr_io_close(PRFileDesc *fd)</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;{</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;  <span class="keyword">const</span> PRCloseFN close_fn = PR_GetDefaultIOMethods()-&gt;close;</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;  fd-&gt;secret = NULL;</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;  <span class="keywordflow">return</span> close_fn(fd);</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;}</div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;<span class="comment">/* load a PKCS #11 module */</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_load_module(SECMODModule **pmod, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cacert_8d.html#a967730876ca750551ce7a18429320343">library</a>,</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;                                <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a>)</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;{</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  <span class="keywordtype">char</span> *config_string;</div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;  SECMODModule *module = *pmod;</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;  <span class="keywordflow">if</span>(module)</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;    <span class="comment">/* already loaded */</span></div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;  config_string = <a class="code" href="curl__printf_8h.html#a3e3dfee99c81f563d18ef4626d8886e1">aprintf</a>(<span class="stringliteral">&quot;library=%s name=%s&quot;</span>, <a class="code" href="cacert_8d.html#a967730876ca750551ce7a18429320343">library</a>, <a class="code" href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a>);</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  <span class="keywordflow">if</span>(!config_string)</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a>;</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;  module = SECMOD_LoadUserModule(config_string, NULL, PR_FALSE);</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;  <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(config_string);</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;  <span class="keywordflow">if</span>(module &amp;&amp; module-&gt;loaded) {</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;    <span class="comment">/* loaded successfully */</span></div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;    *pmod = module;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;  }</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;  <span class="keywordflow">if</span>(module)</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;    SECMOD_DestroyModule(module);</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a7c5e621b8f31e5f941e6044519b4c9c9">CURLE_FAILED_INIT</a>;</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;}</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;<span class="comment">/* unload a PKCS #11 module */</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> nss_unload_module(SECMODModule **pmod)</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;{</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;  SECMODModule *module = *pmod;</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;  <span class="keywordflow">if</span>(!module)</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;    <span class="comment">/* not loaded */</span></div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;  <span class="keywordflow">if</span>(SECMOD_UnloadUserModule(module) != SECSuccess)</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;    <span class="comment">/* unload failed */</span></div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;    <span class="keywordflow">return</span>;</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;  SECMOD_DestroyModule(module);</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;  *pmod = NULL;</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;}</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;<span class="comment">/* data might be NULL */</span></div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_init_core(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cert_dir)</div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;{</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;  NSSInitParameters initparams;</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;  <span class="keywordflow">if</span>(nss_context != NULL)</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;</div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;  <a class="code" href="unit1652_8c.html#a1d19b0eef3b3acd31be88886a0277c2e">memset</a>((<span class="keywordtype">void</span> *) &amp;initparams, <span class="charliteral">&#39;\0&#39;</span>, <span class="keyword">sizeof</span>(initparams));</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;  initparams.length = <span class="keyword">sizeof</span>(initparams);</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;  <span class="keywordflow">if</span>(cert_dir) {</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;    <span class="keywordtype">char</span> *certpath = <a class="code" href="curl__printf_8h.html#a3e3dfee99c81f563d18ef4626d8886e1">aprintf</a>(<span class="stringliteral">&quot;sql:%s&quot;</span>, cert_dir);</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;    <span class="keywordflow">if</span>(!certpath)</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a>;</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;Initializing NSS with certpath: %s\n&quot;</span>, certpath);</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    nss_context = NSS_InitContext(certpath, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, &amp;initparams,</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;            NSS_INIT_READONLY | NSS_INIT_PK11RELOAD);</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(certpath);</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="keywordflow">if</span>(nss_context != NULL)</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;Unable to initialize NSS database\n&quot;</span>);</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  }</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;Initializing NSS with certpath: none\n&quot;</span>);</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  nss_context = NSS_InitContext(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, &amp;initparams, NSS_INIT_READONLY</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;         | NSS_INIT_NOCERTDB   | NSS_INIT_NOMODDB       | NSS_INIT_FORCEOPEN</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;         | NSS_INIT_NOROOTINIT | NSS_INIT_OPTIMIZESPACE | NSS_INIT_PK11RELOAD);</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  <span class="keywordflow">if</span>(nss_context != NULL)</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;Unable to initialize NSS\n&quot;</span>);</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8e6bdaad09a5404d9b01acaa93e1a797">CURLE_SSL_CACERT_BADFILE</a>;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;}</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;<span class="comment">/* data might be NULL */</span></div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_init(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>)</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;{</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;  <span class="keywordtype">char</span> *cert_dir;</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;  <a class="code" href="curl__setup_8h.html#a1c6e64692c9b7c6e7dc70adb398b3115">struct_stat</a> st;</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="_b_l_e_device_8cpp.html#aedeffc7d23da25d52b9a50045189fe2b">initialized</a>)</div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;  <span class="comment">/* list of all CRL items we need to destroy in Curl_nss_cleanup() */</span></div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;  <a class="code" href="llist_8c.html#adf86d38f256b25809632d659a545c75d">Curl_llist_init</a>(&amp;nss_crl_list, nss_destroy_crl_item);</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;  <span class="comment">/* First we check if $SSL_DIR points to a valid dir */</span></div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;  cert_dir = <a class="code" href="setup-vms_8h.html#aafc8c101dfb6313ab0416a6c5903ce66">getenv</a>(<span class="stringliteral">&quot;SSL_DIR&quot;</span>);</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;  <span class="keywordflow">if</span>(cert_dir) {</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    <span class="keywordflow">if</span>((<a class="code" href="config-win32ce_8h.html#ad4ea824bd0fcae61733c900a5cab1e01">stat</a>(cert_dir, &amp;st) != 0) ||</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        (!S_ISDIR(st.st_mode))) {</div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;      cert_dir = NULL;</div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    }</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;  }</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;  <span class="comment">/* Now we check if the default location is a valid dir */</span></div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;  <span class="keywordflow">if</span>(!cert_dir) {</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    <span class="keywordflow">if</span>((<a class="code" href="config-win32ce_8h.html#ad4ea824bd0fcae61733c900a5cab1e01">stat</a>(SSL_DIR, &amp;st) == 0) &amp;&amp;</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        (S_ISDIR(st.st_mode))) {</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;      cert_dir = (<span class="keywordtype">char</span> *)SSL_DIR;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;    }</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;  }</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;  <span class="keywordflow">if</span>(nspr_io_identity == PR_INVALID_IO_LAYER) {</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="comment">/* allocate an identity for our own NSPR I/O layer */</span></div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    nspr_io_identity = PR_GetUniqueIdentity(<span class="stringliteral">&quot;libcurl&quot;</span>);</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    <span class="keywordflow">if</span>(nspr_io_identity == PR_INVALID_IO_LAYER)</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a>;</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;    <span class="comment">/* the default methods just call down to the lower I/O layer */</span></div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;    <a class="code" href="unit1304_8c.html#a82a69fcfe92d9db6dd585ccc532a2ab7">memcpy</a>(&amp;nspr_io_methods, PR_GetDefaultIOMethods(),</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;           <span class="keyword">sizeof</span>(nspr_io_methods));</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    <span class="comment">/* override certain methods in the table by our wrappers */</span></div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    nspr_io_methods.recv  = nspr_io_recv;</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;    nspr_io_methods.send  = nspr_io_send;</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    nspr_io_methods.close = nspr_io_close;</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;  }</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;</div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_init_core(<a class="code" href="structdata.html">data</a>, cert_dir);</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;  <span class="keywordflow">if</span>(!any_cipher_enabled())</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    NSS_SetDomesticPolicy();</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  <a class="code" href="_b_l_e_device_8cpp.html#aedeffc7d23da25d52b9a50045189fe2b">initialized</a> = 1;</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;}</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> Curl_nss_init(<span class="keywordtype">void</span>)</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;{</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;  <span class="comment">/* curl_global_init() is not thread-safe so this test is ok */</span></div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;  <span class="keywordflow">if</span>(nss_initlock == NULL) {</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    PR_Init(PR_USER_THREAD, PR_PRIORITY_NORMAL, 256);</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;    nss_initlock = PR_NewLock();</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    nss_crllock = PR_NewLock();</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    nss_findslot_lock = PR_NewLock();</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;    nss_trustload_lock = PR_NewLock();</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;  }</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;  <span class="comment">/* We will actually initialize NSS later */</span></div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;  <span class="keywordflow">return</span> 1;</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;}</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;<span class="comment">/* data might be NULL */</span></div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;<a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> Curl_nss_force_init(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>)</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;{</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;  <span class="keywordflow">if</span>(!nss_initlock) {</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="structdata.html">data</a>)</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;unable to initialize NSS, curl_global_init() should have &quot;</span></div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;                  <span class="stringliteral">&quot;been called with CURL_GLOBAL_SSL or CURL_GLOBAL_ALL&quot;</span>);</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a7c5e621b8f31e5f941e6044519b4c9c9">CURLE_FAILED_INIT</a>;</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;  }</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;  PR_Lock(nss_initlock);</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_init(<a class="code" href="structdata.html">data</a>);</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;  PR_Unlock(nss_initlock);</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;}</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;<span class="comment">/* Global cleanup */</span></div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> Curl_nss_cleanup(<span class="keywordtype">void</span>)</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;{</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;  <span class="comment">/* This function isn&#39;t required to be threadsafe and this is only done</span></div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;<span class="comment">   * as a safety feature.</span></div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;<span class="comment">   */</span></div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;  PR_Lock(nss_initlock);</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="_b_l_e_device_8cpp.html#aedeffc7d23da25d52b9a50045189fe2b">initialized</a>) {</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;    <span class="comment">/* Free references to client certificates held in the SSL session cache.</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;<span class="comment">     * Omitting this hampers destruction of the security module owning</span></div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;<span class="comment">     * the certificates. */</span></div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    SSL_ClearSessionCache();</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;    nss_unload_module(&amp;pem_module);</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    nss_unload_module(&amp;trust_module);</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;    NSS_ShutdownContext(nss_context);</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    nss_context = NULL;</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;  }</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;  <span class="comment">/* destroy all CRL items */</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;  <a class="code" href="llist_8c.html#a8ea7dbefac355279ad19f3dfe345a45a">Curl_llist_destroy</a>(&amp;nss_crl_list, NULL);</div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;  PR_Unlock(nss_initlock);</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;</div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;  PR_DestroyLock(nss_initlock);</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;  PR_DestroyLock(nss_crllock);</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  PR_DestroyLock(nss_findslot_lock);</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;  PR_DestroyLock(nss_trustload_lock);</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;  nss_initlock = NULL;</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;  <a class="code" href="_b_l_e_device_8cpp.html#aedeffc7d23da25d52b9a50045189fe2b">initialized</a> = 0;</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;}</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="comment"> * This function uses SSL_peek to determine connection status.</span></div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="comment"> * Return codes:</span></div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;<span class="comment"> *     1 means the connection is still in place</span></div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;<span class="comment"> *     0 means the connection has been closed</span></div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="comment"> *    -1 means the connection status is unknown</span></div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> Curl_nss_check_cxn(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn)</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;{</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = &amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[<a class="code" href="urldata_8h.html#a56b23efdd8d04b0179b52224a251bcb7">FIRSTSOCKET</a>];</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">rc</a>;</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;  <span class="keywordtype">char</span> <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>;</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;  <a class="code" href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">rc</a> =</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;    PR_Recv(BACKEND-&gt;handle, (<span class="keywordtype">void</span> *)&amp;<a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, 1, PR_MSG_PEEK,</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;            PR_SecondsToInterval(1));</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">rc</a> &gt; 0)</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    <span class="keywordflow">return</span> 1; <span class="comment">/* connection still in place */</span></div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">rc</a> == 0)</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;    <span class="keywordflow">return</span> 0; <span class="comment">/* connection has been closed */</span></div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;</div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;  <span class="keywordflow">return</span> -1;  <span class="comment">/* connection status unknown */</span></div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;}</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> nss_close(<span class="keyword">struct</span> <a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl)</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;{</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;  <span class="comment">/* before the cleanup, check whether we are using a client certificate */</span></div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">bool</span> client_cert = (BACKEND-&gt;client_nickname != NULL)</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;    || (BACKEND-&gt;obj_clicert != NULL);</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;  <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(BACKEND-&gt;client_nickname);</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  BACKEND-&gt;client_nickname = NULL;</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;  <span class="comment">/* destroy all NSS objects in order to avoid failure of NSS shutdown */</span></div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;  <a class="code" href="llist_8c.html#a8ea7dbefac355279ad19f3dfe345a45a">Curl_llist_destroy</a>(&amp;BACKEND-&gt;obj_list, NULL);</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;  BACKEND-&gt;obj_clicert = NULL;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;  <span class="keywordflow">if</span>(BACKEND-&gt;handle) {</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;    <span class="keywordflow">if</span>(client_cert)</div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;      <span class="comment">/* A server might require different authentication based on the</span></div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;<span class="comment">       * particular path being requested by the client.  To support this</span></div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;<span class="comment">       * scenario, we must ensure that a connection will never reuse the</span></div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;<span class="comment">       * authentication data from a previous connection. */</span></div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;      SSL_InvalidateSession(BACKEND-&gt;handle);</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;    PR_Close(BACKEND-&gt;handle);</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;    BACKEND-&gt;handle = NULL;</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  }</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;}</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;<span class="comment"> * This function is called when an SSL connection is closed.</span></div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> Curl_nss_close(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, <span class="keywordtype">int</span> sockindex)</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;{</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = &amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex];</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl_proxy = &amp;conn-&gt;<a class="code" href="structconnectdata.html#a57fed5d378439f0b8cbad7cc9e916604">proxy_ssl</a>[sockindex];</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;  <span class="keywordflow">if</span>(BACKEND-&gt;handle || connssl_proxy-&gt;backend-&gt;handle) {</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    <span class="comment">/* NSS closes the socket we previously handed to it, so we must mark it</span></div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;<span class="comment">       as closed to avoid double close */</span></div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;    <a class="code" href="memdebug_8h.html#a1c013eb828d138f0445cbf4f9aca2ed8">fake_sclose</a>(conn-&gt;<a class="code" href="structconnectdata.html#a13cc2123ad38902e8ad44e67f10ed7aa">sock</a>[sockindex]);</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    conn-&gt;<a class="code" href="structconnectdata.html#a13cc2123ad38902e8ad44e67f10ed7aa">sock</a>[sockindex] = <a class="code" href="curl_8h.html#ada0bbe252b7b370ef4e135b93b2fe71e">CURL_SOCKET_BAD</a>;</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;  }</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;</div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;  <span class="keywordflow">if</span>(BACKEND-&gt;handle)</div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    <span class="comment">/* nss_close(connssl) will transitively close also</span></div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;<span class="comment">       connssl_proxy-&gt;backend-&gt;handle if both are used. Clear it to avoid</span></div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;<span class="comment">       a double close leading to crash. */</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;    connssl_proxy-&gt;backend-&gt;handle = NULL;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;  nss_close(connssl);</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;  nss_close(connssl_proxy);</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;}</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;<span class="comment">/* return true if NSS can provide error code (and possibly msg) for the</span></div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;<span class="comment">   error */</span></div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> is_nss_error(<a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> err)</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;{</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;  <span class="keywordflow">switch</span>(err) {</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a746b63c8123f5bdc10a916f720f2c9e5">CURLE_PEER_FAILED_VERIFICATION</a>:</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a>:</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>:</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a567c864875b56a6fed90ca22bc89a5a2">CURLE_SSL_ISSUER_ERROR</a>:</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;  }</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;}</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;<span class="comment">/* return true if the given error code is related to a client certificate */</span></div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> is_cc_error(PRInt32 err)</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;{</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;  <span class="keywordflow">switch</span>(err) {</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;  <span class="keywordflow">case</span> SSL_ERROR_BAD_CERT_ALERT:</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;  <span class="keywordflow">case</span> SSL_ERROR_EXPIRED_CERT_ALERT:</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;  <span class="keywordflow">case</span> SSL_ERROR_REVOKED_CERT_ALERT:</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;  }</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;}</div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;<span class="keyword">static</span> <a class="code" href="urldata_8h.html#ad073adb2b5b8a2f9ab8eb0dcae415efc">Curl_recv</a> nss_recv;</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;<span class="keyword">static</span> <a class="code" href="urldata_8h.html#a9f02ef6c16f171ef6fd36b7903e91b41">Curl_send</a> nss_send;</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_load_ca_certificates(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn,</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;                                         <span class="keywordtype">int</span> sockindex)</div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;{</div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> *cafile = <a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(CAfile);</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> *capath = <a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(CApath);</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;  <span class="keywordtype">bool</span> use_trust_module;</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;  <span class="comment">/* treat empty string as unset */</span></div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;  <span class="keywordflow">if</span>(cafile &amp;&amp; !cafile[0])</div><div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;    cafile = NULL;</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;  <span class="keywordflow">if</span>(capath &amp;&amp; !capath[0])</div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;    capath = NULL;</div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;</div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;  <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;  CAfile: %s\n  CApath: %s\n&quot;</span>,</div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;      cafile ? cafile : <span class="stringliteral">&quot;none&quot;</span>,</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;      capath ? capath : <span class="stringliteral">&quot;none&quot;</span>);</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;  <span class="comment">/* load libnssckbi.so if no other trust roots were specified */</span></div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;  use_trust_module = !cafile &amp;&amp; !capath;</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;  PR_Lock(nss_trustload_lock);</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;  <span class="keywordflow">if</span>(use_trust_module &amp;&amp; !trust_module) {</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;    <span class="comment">/* libnssckbi.so needed but not yet loaded --&gt; load it! */</span></div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_load_module(&amp;trust_module, trust_library, <span class="stringliteral">&quot;trust&quot;</span>);</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;%s %s\n&quot;</span>, (<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) ? <span class="stringliteral">&quot;failed to load&quot;</span> : <span class="stringliteral">&quot;loaded&quot;</span>,</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;          trust_library);</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> == <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a7c5e621b8f31e5f941e6044519b4c9c9">CURLE_FAILED_INIT</a>)</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;      <span class="comment">/* If libnssckbi.so is not available (or fails to load), one can still</span></div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;<span class="comment">         use CA certificates stored in NSS database.  Ignore the failure. */</span></div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;  }</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!use_trust_module &amp;&amp; trust_module) {</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;    <span class="comment">/* libnssckbi.so not needed but already loaded --&gt; unload it! */</span></div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;unloading %s\n&quot;</span>, trust_library);</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;    nss_unload_module(&amp;trust_module);</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;  }</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;  PR_Unlock(nss_trustload_lock);</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;</div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;  <span class="keywordflow">if</span>(cafile)</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_load_cert(&amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex], cafile, PR_TRUE);</div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;  <span class="keywordflow">if</span>(capath) {</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;    <a class="code" href="curl__setup_8h.html#a1c6e64692c9b7c6e7dc70adb398b3115">struct_stat</a> st;</div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="config-win32ce_8h.html#ad4ea824bd0fcae61733c900a5cab1e01">stat</a>(capath, &amp;st) == -1)</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8e6bdaad09a5404d9b01acaa93e1a797">CURLE_SSL_CACERT_BADFILE</a>;</div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;</div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;    <span class="keywordflow">if</span>(S_ISDIR(st.st_mode)) {</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;      PRDirEntry *entry;</div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;      PRDir *dir = PR_OpenDir(capath);</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;      <span class="keywordflow">if</span>(!dir)</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8e6bdaad09a5404d9b01acaa93e1a797">CURLE_SSL_CACERT_BADFILE</a>;</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;      <span class="keywordflow">while</span>((entry = PR_ReadDir(dir, PR_SKIP_BOTH | PR_SKIP_HIDDEN))) {</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;        <span class="keywordtype">char</span> *fullpath = <a class="code" href="curl__printf_8h.html#a3e3dfee99c81f563d18ef4626d8886e1">aprintf</a>(<span class="stringliteral">&quot;%s/%s&quot;</span>, capath, entry-&gt;name);</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;        <span class="keywordflow">if</span>(!fullpath) {</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;          PR_CloseDir(dir);</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;          <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a>;</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;        }</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;        <span class="keywordflow">if</span>(<a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a> != nss_load_cert(&amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex], fullpath, PR_TRUE))</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;          <span class="comment">/* This is purposefully tolerant of errors so non-PEM files can</span></div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;<span class="comment">           * be in the same directory */</span></div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;          <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;failed to load &#39;%s&#39; from CURLOPT_CAPATH\n&quot;</span>, fullpath);</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;        <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(fullpath);</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;      }</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;      PR_CloseDir(dir);</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    }</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;warning: CURLOPT_CAPATH not a directory (%s)\n&quot;</span>, capath);</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;  }</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;</div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;}</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_sslver_from_curl(PRUint16 *nssver, <span class="keywordtype">long</span> <a class="code" href="_b_l_e_eddystone_t_l_m_8h.html#ab22abc2906422da61885ac6c8e6a1a59">version</a>)</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;{</div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;  <span class="keywordflow">switch</span>(<a class="code" href="_b_l_e_eddystone_t_l_m_8h.html#ab22abc2906422da61885ac6c8e6a1a59">version</a>) {</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea0f8174e66c2e7084ab2aa414509110ce">CURL_SSLVERSION_SSLv2</a>:</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;    *nssver = SSL_LIBRARY_VERSION_2;</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea196e49e6628c0360cbe00852964fa906">CURL_SSLVERSION_SSLv3</a>:</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;    *nssver = SSL_LIBRARY_VERSION_3_0;</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea769044d53450fd19575f12b2838f54d0">CURL_SSLVERSION_TLSv1_0</a>:</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;    *nssver = SSL_LIBRARY_VERSION_TLS_1_0;</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;</div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea3659f18972112848e04fec39daf19985">CURL_SSLVERSION_TLSv1_1</a>:</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;<span class="preprocessor">#ifdef SSL_LIBRARY_VERSION_TLS_1_1</span></div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;    *nssver = SSL_LIBRARY_VERSION_TLS_1_1;</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>;</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;</div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9eae9b72f6323430c824c44182b7649d0d8">CURL_SSLVERSION_TLSv1_2</a>:</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;<span class="preprocessor">#ifdef SSL_LIBRARY_VERSION_TLS_1_2</span></div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;    *nssver = SSL_LIBRARY_VERSION_TLS_1_2;</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>;</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea3a20a62139a18a0577154835dc642c0d">CURL_SSLVERSION_TLSv1_3</a>:</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;<span class="preprocessor">#ifdef SSL_LIBRARY_VERSION_TLS_1_3</span></div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;    *nssver = SSL_LIBRARY_VERSION_TLS_1_3;</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>;</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>;</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;  }</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;}</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_init_sslver(SSLVersionRange *sslver,</div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;                                <span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>,</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;                                <span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn)</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;{</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">long</span> <a class="code" href="_adafruit___g_f_x_8cpp.html#ac6afabdc09a49a433ee19d8a9486056d">min</a> = <a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(<a class="code" href="_b_l_e_eddystone_t_l_m_8h.html#ab22abc2906422da61885ac6c8e6a1a59">version</a>);</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">long</span> max = <a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(version_max);</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;  <span class="comment">/* map CURL_SSLVERSION_DEFAULT to NSS default */</span></div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="_adafruit___g_f_x_8cpp.html#ac6afabdc09a49a433ee19d8a9486056d">min</a> == <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea0227d3edc8c1ee5f0bb41831912ce756">CURL_SSLVERSION_DEFAULT</a> || max == <a class="code" href="curl_8h.html#a16af7b253440dadd46a80a4b9fddba4da724f1960f9dd1cfe462c0eca7f4e7da0">CURL_SSLVERSION_MAX_DEFAULT</a>) {</div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;    <span class="comment">/* map CURL_SSLVERSION_DEFAULT to NSS default */</span></div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;    <span class="keywordflow">if</span>(SSL_VersionRangeGetDefault(ssl_variant_stream, sslver) != SECSuccess)</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>;</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;    <span class="comment">/* ... but make sure we use at least TLSv1.0 according to libcurl API */</span></div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;    <span class="keywordflow">if</span>(sslver-&gt;min &lt; SSL_LIBRARY_VERSION_TLS_1_0)</div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;      sslver-&gt;min = SSL_LIBRARY_VERSION_TLS_1_0;</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;  }</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;  <span class="keywordflow">switch</span>(<a class="code" href="_adafruit___g_f_x_8cpp.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>) {</div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9eaf516898239e1f4a335ab3c0d019de40e">CURL_SSLVERSION_TLSv1</a>:</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea0227d3edc8c1ee5f0bb41831912ce756">CURL_SSLVERSION_DEFAULT</a>:</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;    <span class="keywordflow">break</span>;</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_sslver_from_curl(&amp;sslver-&gt;min, <a class="code" href="_adafruit___g_f_x_8cpp.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>);</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;unsupported min version passed via CURLOPT_SSLVERSION&quot;</span>);</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;    }</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;  }</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;  <span class="keywordflow">switch</span>(max) {</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a16af7b253440dadd46a80a4b9fddba4dadd0b0bf93854f50974d52f324d3259df">CURL_SSLVERSION_MAX_NONE</a>:</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#a16af7b253440dadd46a80a4b9fddba4da724f1960f9dd1cfe462c0eca7f4e7da0">CURL_SSLVERSION_MAX_DEFAULT</a>:</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;    <span class="keywordflow">break</span>;</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_sslver_from_curl(&amp;sslver-&gt;max, max &gt;&gt; 16);</div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;      <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;unsupported max version passed via CURLOPT_SSLVERSION&quot;</span>);</div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;    }</div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;  }</div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;</div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;}</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_fail_connect(<span class="keyword">struct</span> <a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl,</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;                                 <span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>,</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;                                 <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> curlerr)</div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;{</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;  PRErrorCode err = 0;</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;</div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;  <span class="keywordflow">if</span>(is_nss_error(curlerr)) {</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;    <span class="comment">/* read NSPR error code */</span></div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;    err = PR_GetError();</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;    <span class="keywordflow">if</span>(is_cc_error(err))</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;      curlerr = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a>;</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;</div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;    <span class="comment">/* print the error number and error string */</span></div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;NSS error %d (%s)\n&quot;</span>, err, nss_error_to_name(err));</div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;</div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;    <span class="comment">/* print a human-readable message describing the error if available */</span></div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;    nss_print_error_message(<a class="code" href="structdata.html">data</a>, err);</div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;  }</div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;</div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;  <span class="comment">/* cleanup on connection failure */</span></div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;  <a class="code" href="llist_8c.html#a8ea7dbefac355279ad19f3dfe345a45a">Curl_llist_destroy</a>(&amp;BACKEND-&gt;obj_list, NULL);</div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;</div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;  <span class="keywordflow">return</span> curlerr;</div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;}</div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;</div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="comment">/* Switch the SSL socket into blocking or non-blocking mode. */</span></div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_set_blocking(<span class="keyword">struct</span> <a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl,</div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;                                 <span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>,</div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;                                 <span class="keywordtype">bool</span> blocking)</div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;{</div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;  <span class="keyword">static</span> PRSocketOptionData sock_opt;</div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;  sock_opt.option = PR_SockOpt_Nonblocking;</div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;  sock_opt.value.non_blocking = !blocking;</div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;</div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;  <span class="keywordflow">if</span>(PR_SetSocketOption(BACKEND-&gt;handle, &amp;sock_opt) != PR_SUCCESS)</div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;    <span class="keywordflow">return</span> nss_fail_connect(connssl, <a class="code" href="structdata.html">data</a>, <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>);</div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;</div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;}</div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;</div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_setup_connect(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, <span class="keywordtype">int</span> sockindex)</div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;{</div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;  PRFileDesc *model = NULL;</div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;  PRFileDesc *nspr_io = NULL;</div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;  PRFileDesc *nspr_io_stub = NULL;</div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;  PRBool ssl_no_cache;</div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;  PRBool ssl_cbc_random_iv;</div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;  <a class="code" href="curl_8h.html#adb5a46d02359d2379dc7e0904c987828">curl_socket_t</a> sockfd = conn-&gt;<a class="code" href="structconnectdata.html#a13cc2123ad38902e8ad44e67f10ed7aa">sock</a>[sockindex];</div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = &amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex];</div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;  <span class="keywordtype">bool</span> second_layer = <a class="code" href="curl__setup__once_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;  SSLVersionRange sslver_supported;</div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;</div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;  SSLVersionRange sslver = {</div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;    SSL_LIBRARY_VERSION_TLS_1_0,  <span class="comment">/* min */</span></div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<span class="preprocessor">#ifdef SSL_LIBRARY_VERSION_TLS_1_3</span></div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;    SSL_LIBRARY_VERSION_TLS_1_3   <span class="comment">/* max */</span></div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="preprocessor">#elif defined SSL_LIBRARY_VERSION_TLS_1_2</span></div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    SSL_LIBRARY_VERSION_TLS_1_2</div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;<span class="preprocessor">#elif defined SSL_LIBRARY_VERSION_TLS_1_1</span></div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    SSL_LIBRARY_VERSION_TLS_1_1</div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;    SSL_LIBRARY_VERSION_TLS_1_0</div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;  };</div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;</div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;  BACKEND-&gt;data = <a class="code" href="get_8d.html#a38b0ef81b65f2aee282c8c217a123176">data</a>;</div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;</div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;  <span class="comment">/* list of all NSS objects we need to destroy in Curl_nss_close() */</span></div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;  <a class="code" href="llist_8c.html#adf86d38f256b25809632d659a545c75d">Curl_llist_init</a>(&amp;BACKEND-&gt;obj_list, nss_destroy_object);</div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;</div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;  <span class="comment">/* FIXME. NSS doesn&#39;t support multiple databases open at the same time. */</span></div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;  PR_Lock(nss_initlock);</div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_init(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>);</div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    PR_Unlock(nss_initlock);</div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;  }</div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;</div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;  PK11_SetPasswordFunc(nss_get_password);</div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;</div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_load_module(&amp;pem_module, pem_library, <span class="stringliteral">&quot;PEM&quot;</span>);</div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;  PR_Unlock(nss_initlock);</div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> == <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a7c5e621b8f31e5f941e6044519b4c9c9">CURLE_FAILED_INIT</a>)</div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;WARNING: failed to load NSS PEM library %s. Using &quot;</span></div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;                <span class="stringliteral">&quot;OpenSSL PEM certificates will not work.\n&quot;</span>, pem_library);</div><div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;</div><div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>;</div><div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;  model = PR_NewTCPSocket();</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;  <span class="keywordflow">if</span>(!model)</div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;  model = SSL_ImportFD(NULL, model);</div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;</div><div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;  <span class="keywordflow">if</span>(SSL_OptionSet(model, SSL_SECURITY, PR_TRUE) != SECSuccess)</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;  <span class="keywordflow">if</span>(SSL_OptionSet(model, SSL_HANDSHAKE_AS_SERVER, PR_FALSE) != SECSuccess)</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;  <span class="keywordflow">if</span>(SSL_OptionSet(model, SSL_HANDSHAKE_AS_CLIENT, PR_TRUE) != SECSuccess)</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;</div><div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;  <span class="comment">/* do not use SSL cache if disabled or we are not going to verify peer */</span></div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;  ssl_no_cache = (<a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(primary.sessionid)</div><div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;                  &amp;&amp; <a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(verifypeer)) ? PR_FALSE : PR_TRUE;</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;  <span class="keywordflow">if</span>(SSL_OptionSet(model, SSL_NO_CACHE, ssl_no_cache) != SECSuccess)</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;  <span class="comment">/* enable/disable the requested SSL version(s) */</span></div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;  <span class="keywordflow">if</span>(nss_init_sslver(&amp;sslver, <a class="code" href="structdata.html">data</a>, conn) != <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>)</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;  <span class="keywordflow">if</span>(SSL_VersionRangeGetSupported(ssl_variant_stream,</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;                                  &amp;sslver_supported) != SECSuccess)</div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;  <span class="keywordflow">if</span>(sslver_supported.max &lt; sslver.max &amp;&amp; sslver_supported.max &gt;= sslver.min) {</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;    <span class="keywordtype">char</span> *sslver_req_str, *sslver_supp_str;</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    sslver_req_str = nss_sslver_to_name(sslver.max);</div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;    sslver_supp_str = nss_sslver_to_name(sslver_supported.max);</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    <span class="keywordflow">if</span>(sslver_req_str &amp;&amp; sslver_supp_str)</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;Falling back from %s to max supported SSL version (%s)\n&quot;</span>,</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;                  sslver_req_str, sslver_supp_str);</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;    <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(sslver_req_str);</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(sslver_supp_str);</div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    sslver.max = sslver_supported.max;</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;  }</div><div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;  <span class="keywordflow">if</span>(SSL_VersionRangeSet(model, &amp;sslver) != SECSuccess)</div><div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;  ssl_cbc_random_iv = !<a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(enable_beast);</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;<span class="preprocessor">#ifdef SSL_CBC_RANDOM_IV</span></div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;  <span class="comment">/* unless the user explicitly asks to allow the protocol vulnerability, we</span></div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;<span class="comment">     use the work-around */</span></div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;  <span class="keywordflow">if</span>(SSL_OptionSet(model, SSL_CBC_RANDOM_IV, ssl_cbc_random_iv) != SECSuccess)</div><div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;warning: failed to set SSL_CBC_RANDOM_IV = %d\n&quot;</span>,</div><div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160;          ssl_cbc_random_iv);</div><div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;  <span class="keywordflow">if</span>(ssl_cbc_random_iv)</div><div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;warning: support for SSL_CBC_RANDOM_IV not compiled in\n&quot;</span>);</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;</div><div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(cipher_list)) {</div><div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;    <span class="keywordflow">if</span>(set_ciphers(<a class="code" href="structdata.html">data</a>, model, <a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(cipher_list)) != SECSuccess) {</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a3d136f81a9d7bf281f4a050099438683">CURLE_SSL_CIPHER</a>;</div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    }</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;  }</div><div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;  <span class="keywordflow">if</span>(!<a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(verifypeer) &amp;&amp; <a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(verifyhost))</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;warning: ignoring value of ssl.verifyhost\n&quot;</span>);</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;  <span class="comment">/* bypass the default SSL_AuthCertificate() hook in case we do not want to</span></div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;<span class="comment">   * verify peer */</span></div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;  <span class="keywordflow">if</span>(SSL_AuthCertificateHook(model, nss_auth_cert_hook, conn) != SECSuccess)</div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;  <span class="comment">/* not checked yet */</span></div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#ad333981ba88648c413730d21d5418405">SSL_IS_PROXY</a>())</div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;    <a class="code" href="structdata.html">data</a>-&gt;set.proxy_ssl.certverifyresult = 0;</div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;    <a class="code" href="structdata.html">data</a>-&gt;set.ssl.certverifyresult = 0;</div><div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;</div><div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;  <span class="keywordflow">if</span>(SSL_BadCertHook(model, BadCertHandler, conn) != SECSuccess)</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;  <span class="keywordflow">if</span>(SSL_HandshakeCallback(model, HandshakeCallback, conn) != SECSuccess)</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;  {</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;    <span class="keyword">const</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> rv = nss_load_ca_certificates(conn, sockindex);</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;    <span class="keywordflow">if</span>((rv == <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8e6bdaad09a5404d9b01acaa93e1a797">CURLE_SSL_CACERT_BADFILE</a>) &amp;&amp; !<a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(verifypeer))</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;      <span class="comment">/* not a fatal error because we are not going to verify the peer */</span></div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;warning: CA certificates failed to load\n&quot;</span>);</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rv) {</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = rv;</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;    }</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;  }</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(CRLfile)) {</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    <span class="keyword">const</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> rv = nss_load_crl(<a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(CRLfile));</div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    <span class="keywordflow">if</span>(rv) {</div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = rv;</div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;    }</div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;    <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;  CRLfile: %s\n&quot;</span>, <a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(CRLfile));</div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;  }</div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;</div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(cert)) {</div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;    <span class="keywordtype">char</span> *nickname = dup_nickname(<a class="code" href="structdata.html">data</a>, <a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(cert));</div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;    <span class="keywordflow">if</span>(nickname) {</div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;      <span class="comment">/* we are not going to use libnsspem.so to read the client cert */</span></div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;      BACKEND-&gt;obj_clicert = NULL;</div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;    }</div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;      <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> rv = cert_stuff(conn, sockindex, <a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(cert),</div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;                               <a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(<a class="code" href="unit1602_8c.html#a35af0be900467fedbb610bd6ea65ed78">key</a>));</div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;      <span class="keywordflow">if</span>(rv) {</div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;        <span class="comment">/* failf() is already done in cert_stuff() */</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;        <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = rv;</div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;        <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;      }</div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;    }</div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;</div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    <span class="comment">/* store the nickname for SelectClientCert() called during handshake */</span></div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    BACKEND-&gt;client_nickname = nickname;</div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;  }</div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    BACKEND-&gt;client_nickname = NULL;</div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;</div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;  <span class="keywordflow">if</span>(SSL_GetClientAuthDataHook(model, SelectClientCert,</div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;                               (<span class="keywordtype">void</span> *)connssl) != SECSuccess) {</div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a>;</div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;  }</div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;</div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;  <span class="keywordflow">if</span>(conn-&gt;<a class="code" href="structconnectdata.html#a57fed5d378439f0b8cbad7cc9e916604">proxy_ssl</a>[sockindex].<a class="code" href="structssl__connect__data.html#ad63d8e461921062845bbf07dfc0007c5">use</a>) {</div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;    <a class="code" href="curl__setup__once_8h.html#a23d7b88872d6ead46c978b567908d587">DEBUGASSERT</a>(<a class="code" href="urldata_8h.html#a2ea01ebd139c38e2285c7d2e17a2683fa88a671c415a487b02dbfd68cea24f98c">ssl_connection_complete</a> == conn-&gt;<a class="code" href="structconnectdata.html#a57fed5d378439f0b8cbad7cc9e916604">proxy_ssl</a>[sockindex].<a class="code" href="structssl__connect__data.html#a46d3839ea70923be1efa7f85aba7f6a8">state</a>);</div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;    <a class="code" href="curl__setup__once_8h.html#a23d7b88872d6ead46c978b567908d587">DEBUGASSERT</a>(conn-&gt;<a class="code" href="structconnectdata.html#a57fed5d378439f0b8cbad7cc9e916604">proxy_ssl</a>[sockindex].backend-&gt;handle != NULL);</div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;    nspr_io = conn-&gt;<a class="code" href="structconnectdata.html#a57fed5d378439f0b8cbad7cc9e916604">proxy_ssl</a>[sockindex].backend-&gt;handle;</div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;    second_layer = <a class="code" href="multi-debugcallback_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;  }</div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;  <span class="keywordflow">else</span> {</div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;    <span class="comment">/* wrap OS file descriptor by NSPR&#39;s file descriptor abstraction */</span></div><div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;    nspr_io = PR_ImportTCPSocket(sockfd);</div><div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;    <span class="keywordflow">if</span>(!nspr_io)</div><div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;  }</div><div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;</div><div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;  <span class="comment">/* create our own NSPR I/O layer */</span></div><div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;  nspr_io_stub = PR_CreateIOLayerStub(nspr_io_identity, &amp;nspr_io_methods);</div><div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;  <span class="keywordflow">if</span>(!nspr_io_stub) {</div><div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;    <span class="keywordflow">if</span>(!second_layer)</div><div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;      PR_Close(nspr_io);</div><div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;  }</div><div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;</div><div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;  <span class="comment">/* make the per-connection data accessible from NSPR I/O callbacks */</span></div><div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;  nspr_io_stub-&gt;secret = (<span class="keywordtype">void</span> *)connssl;</div><div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;</div><div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;  <span class="comment">/* push our new layer to the NSPR I/O stack */</span></div><div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;  <span class="keywordflow">if</span>(PR_PushIOLayer(nspr_io, PR_TOP_IO_LAYER, nspr_io_stub) != PR_SUCCESS) {</div><div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    <span class="keywordflow">if</span>(!second_layer)</div><div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;      PR_Close(nspr_io);</div><div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;    PR_Close(nspr_io_stub);</div><div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;  }</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;  <span class="comment">/* import our model socket onto the current I/O stack */</span></div><div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;  BACKEND-&gt;handle = SSL_ImportFD(model, nspr_io);</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;  <span class="keywordflow">if</span>(!BACKEND-&gt;handle) {</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;    <span class="keywordflow">if</span>(!second_layer)</div><div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;      PR_Close(nspr_io);</div><div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;  }</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;  PR_Close(model); <span class="comment">/* We don&#39;t need this any more */</span></div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;  model = NULL;</div><div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;  <span class="comment">/* This is the password associated with the cert that we&#39;re using */</span></div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(key_passwd)) {</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;    SSL_SetPKCS11PinArg(BACKEND-&gt;handle, <a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(key_passwd));</div><div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;  }</div><div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;</div><div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;<span class="preprocessor">#ifdef SSL_ENABLE_OCSP_STAPLING</span></div><div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a>(verifystatus)) {</div><div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;    <span class="keywordflow">if</span>(SSL_OptionSet(BACKEND-&gt;handle, SSL_ENABLE_OCSP_STAPLING, PR_TRUE)</div><div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;        != SECSuccess)</div><div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;  }</div><div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;</div><div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;<span class="preprocessor">#ifdef SSL_ENABLE_NPN</span></div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;  <span class="keywordflow">if</span>(SSL_OptionSet(BACKEND-&gt;handle, SSL_ENABLE_NPN, conn-&gt;<a class="code" href="structconnectdata.html#a9312f162d29fe7f59bc2b5dbeda85d9d">bits</a>.<a class="code" href="struct_connect_bits.html#a0a00cd02ce442392e3836545ce356b6a">tls_enable_npn</a></div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;                   ? PR_TRUE : PR_FALSE) != SECSuccess)</div><div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;</div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;<span class="preprocessor">#ifdef SSL_ENABLE_ALPN</span></div><div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;  <span class="keywordflow">if</span>(SSL_OptionSet(BACKEND-&gt;handle, SSL_ENABLE_ALPN, conn-&gt;<a class="code" href="structconnectdata.html#a9312f162d29fe7f59bc2b5dbeda85d9d">bits</a>.<a class="code" href="struct_connect_bits.html#a15d98c2eae880b790963d2b0d15a85dc">tls_enable_alpn</a></div><div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;                   ? PR_TRUE : PR_FALSE) != SECSuccess)</div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;<span class="preprocessor">#if NSSVERNUM &gt;= 0x030f04 </span><span class="comment">/* 3.15.4 */</span><span class="preprocessor"></span></div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="structdata.html">data</a>-&gt;set.ssl.falsestart) {</div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;    <span class="keywordflow">if</span>(SSL_OptionSet(BACKEND-&gt;handle, SSL_ENABLE_FALSE_START, PR_TRUE)</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;        != SECSuccess)</div><div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;    <span class="keywordflow">if</span>(SSL_SetCanFalseStartCallback(BACKEND-&gt;handle, CanFalseStartCallback,</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;        conn) != SECSuccess)</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;  }</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;<span class="preprocessor">#if defined(SSL_ENABLE_NPN) || defined(SSL_ENABLE_ALPN)</span></div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;  <span class="keywordflow">if</span>(conn-&gt;<a class="code" href="structconnectdata.html#a9312f162d29fe7f59bc2b5dbeda85d9d">bits</a>.<a class="code" href="struct_connect_bits.html#a0a00cd02ce442392e3836545ce356b6a">tls_enable_npn</a> || conn-&gt;<a class="code" href="structconnectdata.html#a9312f162d29fe7f59bc2b5dbeda85d9d">bits</a>.<a class="code" href="struct_connect_bits.html#a15d98c2eae880b790963d2b0d15a85dc">tls_enable_alpn</a>) {</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;    <span class="keywordtype">int</span> cur = 0;</div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="proto_8d.html#a454d355bda85162423424da4a79fd517">protocols</a>[128];</div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;</div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;<span class="preprocessor">#ifdef USE_NGHTTP2</span></div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="structdata.html">data</a>-&gt;set.httpversion &gt;= <a class="code" href="curl_8h.html#a49d83160803f433b12209ed52aafc05f">CURL_HTTP_VERSION_2</a> &amp;&amp;</div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;       (!<a class="code" href="vtls_8h.html#ad333981ba88648c413730d21d5418405">SSL_IS_PROXY</a>() || !conn-&gt;<a class="code" href="structconnectdata.html#a9312f162d29fe7f59bc2b5dbeda85d9d">bits</a>.<a class="code" href="struct_connect_bits.html#af764c68e6af921d2073c498f80741ea4">tunnel_proxy</a>)) {</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;      <a class="code" href="proto_8d.html#a454d355bda85162423424da4a79fd517">protocols</a>[cur++] = NGHTTP2_PROTO_VERSION_ID_LEN;</div><div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;      <a class="code" href="unit1304_8c.html#a82a69fcfe92d9db6dd585ccc532a2ab7">memcpy</a>(&amp;<a class="code" href="proto_8d.html#a454d355bda85162423424da4a79fd517">protocols</a>[cur], NGHTTP2_PROTO_VERSION_ID,</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;          NGHTTP2_PROTO_VERSION_ID_LEN);</div><div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;      cur += NGHTTP2_PROTO_VERSION_ID_LEN;</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;    }</div><div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;    <a class="code" href="proto_8d.html#a454d355bda85162423424da4a79fd517">protocols</a>[cur++] = <a class="code" href="vtls_8h.html#a9043fcf68904db7a0844fb55857bd482">ALPN_HTTP_1_1_LENGTH</a>;</div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;    <a class="code" href="unit1304_8c.html#a82a69fcfe92d9db6dd585ccc532a2ab7">memcpy</a>(&amp;<a class="code" href="proto_8d.html#a454d355bda85162423424da4a79fd517">protocols</a>[cur], <a class="code" href="vtls_8h.html#af8e5805a5e7df10119ca90c13a2b1a79">ALPN_HTTP_1_1</a>, <a class="code" href="vtls_8h.html#a9043fcf68904db7a0844fb55857bd482">ALPN_HTTP_1_1_LENGTH</a>);</div><div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;    cur += <a class="code" href="vtls_8h.html#a9043fcf68904db7a0844fb55857bd482">ALPN_HTTP_1_1_LENGTH</a>;</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;    <span class="keywordflow">if</span>(SSL_SetNextProtoNego(BACKEND-&gt;handle, <a class="code" href="proto_8d.html#a454d355bda85162423424da4a79fd517">protocols</a>, cur) != SECSuccess)</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;  }</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;  <span class="comment">/* Force handshake on next I/O */</span></div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;  <span class="keywordflow">if</span>(SSL_ResetHandshake(BACKEND-&gt;handle, <span class="comment">/* asServer */</span> PR_FALSE)</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;      != SECSuccess)</div><div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;  <span class="comment">/* propagate hostname to the TLS layer */</span></div><div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;  <span class="keywordflow">if</span>(SSL_SetURL(BACKEND-&gt;handle, <a class="code" href="vtls_8h.html#ad333981ba88648c413730d21d5418405">SSL_IS_PROXY</a>() ? conn-&gt;<a class="code" href="structconnectdata.html#a4df63a4042ad767671bb3bfd74aa68fc">http_proxy</a>.<a class="code" href="structproxy__info.html#ae2cc9c2eb5c4ea0c4b92bf067e391bdc">host</a>.<a class="code" href="structhostname.html#a9c9ce90bfcab1734f9376c6539d92cdd">name</a> :</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;                conn-&gt;<a class="code" href="structconnectdata.html#a91d94af5dfef86510940d658476b61cf">host</a>.<a class="code" href="structhostname.html#a9c9ce90bfcab1734f9376c6539d92cdd">name</a>) != SECSuccess)</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;  <span class="comment">/* prevent NSS from re-using the session for a different hostname */</span></div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;  <span class="keywordflow">if</span>(SSL_SetSockPeerID(BACKEND-&gt;handle, <a class="code" href="vtls_8h.html#ad333981ba88648c413730d21d5418405">SSL_IS_PROXY</a>() ?</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;                       conn-&gt;<a class="code" href="structconnectdata.html#a4df63a4042ad767671bb3bfd74aa68fc">http_proxy</a>.<a class="code" href="structproxy__info.html#ae2cc9c2eb5c4ea0c4b92bf067e391bdc">host</a>.<a class="code" href="structhostname.html#a9c9ce90bfcab1734f9376c6539d92cdd">name</a> : conn-&gt;<a class="code" href="structconnectdata.html#a91d94af5dfef86510940d658476b61cf">host</a>.<a class="code" href="structhostname.html#a9c9ce90bfcab1734f9376c6539d92cdd">name</a>)</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;     != SECSuccess)</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;</div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;</div><div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;error:</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;  <span class="keywordflow">if</span>(model)</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;    PR_Close(model);</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;  <span class="keywordflow">return</span> nss_fail_connect(connssl, <a class="code" href="structdata.html">data</a>, <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>);</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;}</div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;</div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_do_connect(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, <span class="keywordtype">int</span> sockindex)</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;{</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = &amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex];</div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a>;</div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;  PRUint32 <a class="code" href="multi-uv_8c.html#afb43b78d9a22f95e721353db4408304c">timeout</a>;</div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;  <span class="keywordtype">long</span> * <span class="keyword">const</span> certverifyresult = <a class="code" href="vtls_8h.html#ad333981ba88648c413730d21d5418405">SSL_IS_PROXY</a>() ?</div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;    &amp;<a class="code" href="structdata.html">data</a>-&gt;set.proxy_ssl.certverifyresult : &amp;<a class="code" href="structdata.html">data</a>-&gt;set.ssl.certverifyresult;</div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> * <span class="keyword">const</span> pinnedpubkey = <a class="code" href="vtls_8h.html#ad333981ba88648c413730d21d5418405">SSL_IS_PROXY</a>() ?</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;              <a class="code" href="structdata.html">data</a>-&gt;set.str[<a class="code" href="urldata_8h.html#a9607658ec977f6ca435daf26b82f6b3fa85af043a41434c1b4f439fb89d5c9047">STRING_SSL_PINNEDPUBLICKEY_PROXY</a>] :</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;              <a class="code" href="structdata.html">data</a>-&gt;set.str[<a class="code" href="urldata_8h.html#a9607658ec977f6ca435daf26b82f6b3fa83729aeebf5f0a20b00829bc3a6a1e9f">STRING_SSL_PINNEDPUBLICKEY_ORIG</a>];</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;  <span class="comment">/* check timeout situation */</span></div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;  <span class="keyword">const</span> time_t time_left = <a class="code" href="connect_8c.html#aed32c0fb99c80a40c097c98a3eb03c74">Curl_timeleft</a>(<a class="code" href="structdata.html">data</a>, NULL, <a class="code" href="multi-debugcallback_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;  <span class="keywordflow">if</span>(time_left &lt; 0) {</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;    <a class="code" href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;timed out before SSL handshake&quot;</span>);</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951aaa7a948caaac0addf8754794663f48b1">CURLE_OPERATION_TIMEDOUT</a>;</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;  }</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;</div><div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;  <span class="comment">/* Force the handshake now */</span></div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;  <a class="code" href="multi-uv_8c.html#afb43b78d9a22f95e721353db4408304c">timeout</a> = PR_MillisecondsToInterval((PRUint32) time_left);</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;  <span class="keywordflow">if</span>(SSL_ForceHandshakeWithTimeout(BACKEND-&gt;handle, <a class="code" href="multi-uv_8c.html#afb43b78d9a22f95e721353db4408304c">timeout</a>) != SECSuccess) {</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;    <span class="keywordflow">if</span>(PR_GetError() == PR_WOULD_BLOCK_ERROR)</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;      <span class="comment">/* blocking direction is updated by nss_update_connecting_state() */</span></div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8527394a7d1a590228373b95f55a61a7">CURLE_AGAIN</a>;</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*certverifyresult == SSL_ERROR_BAD_CERT_DOMAIN)</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a746b63c8123f5bdc10a916f720f2c9e5">CURLE_PEER_FAILED_VERIFICATION</a>;</div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(*certverifyresult != 0)</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a746b63c8123f5bdc10a916f720f2c9e5">CURLE_PEER_FAILED_VERIFICATION</a>;</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;  }</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = display_conn_info(conn, BACKEND-&gt;handle);</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;</div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(issuercert)) {</div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;    SECStatus ret = SECFailure;</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;    <span class="keywordtype">char</span> *nickname = dup_nickname(<a class="code" href="structdata.html">data</a>, <a class="code" href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a>(issuercert));</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;    <span class="keywordflow">if</span>(nickname) {</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;      <span class="comment">/* we support only nicknames in case of issuercert for now */</span></div><div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;      ret = check_issuer_cert(BACKEND-&gt;handle, nickname);</div><div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;      <a class="code" href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a>(nickname);</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;    }</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    <span class="keywordflow">if</span>(SECFailure == ret) {</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;SSL certificate issuer check failed\n&quot;</span>);</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;      <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a567c864875b56a6fed90ca22bc89a5a2">CURLE_SSL_ISSUER_ERROR</a>;</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;      <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    }</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(<a class="code" href="structdata.html">data</a>, <span class="stringliteral">&quot;SSL certificate issuer check ok\n&quot;</span>);</div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    }</div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;  }</div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;</div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = cmp_peer_pubkey(connssl, pinnedpubkey);</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;    <span class="comment">/* status already printed */</span></div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;    <span class="keywordflow">goto</span> error;</div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;</div><div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;error:</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;  <span class="keywordflow">return</span> nss_fail_connect(connssl, <a class="code" href="structdata.html">data</a>, <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>);</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;}</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;</div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> nss_connect_common(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, <span class="keywordtype">int</span> sockindex,</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;                                   <span class="keywordtype">bool</span> *done)</div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;{</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = &amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex];</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;  <span class="keyword">struct </span><a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a> = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">bool</span> blocking = (done == NULL);</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;  <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;</div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;  <span class="keywordflow">if</span>(connssl-&gt;<a class="code" href="structssl__connect__data.html#a46d3839ea70923be1efa7f85aba7f6a8">state</a> == <a class="code" href="urldata_8h.html#a2ea01ebd139c38e2285c7d2e17a2683fa88a671c415a487b02dbfd68cea24f98c">ssl_connection_complete</a>) {</div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;    <span class="keywordflow">if</span>(!blocking)</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;      *done = <a class="code" href="multi-debugcallback_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;  }</div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;  <span class="keywordflow">if</span>(connssl-&gt;<a class="code" href="structssl__connect__data.html#a2de0f5a8b43b4e4550e22b1b8f3870e1">connecting_state</a> == <a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1aff18b454b42fb95d95e3fd93130a5508">ssl_connect_1</a>) {</div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_setup_connect(conn, sockindex);</div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;      <span class="comment">/* we do not expect CURLE_AGAIN from nss_setup_connect() */</span></div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    connssl-&gt;<a class="code" href="structssl__connect__data.html#a2de0f5a8b43b4e4550e22b1b8f3870e1">connecting_state</a> = <a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a02630bc60f6cd9c202c67e33784ee7a5">ssl_connect_2</a>;</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;  }</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;  <span class="comment">/* enable/disable blocking mode before handshake */</span></div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_set_blocking(connssl, <a class="code" href="structdata.html">data</a>, blocking);</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;  <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_do_connect(conn, sockindex);</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;  <span class="keywordflow">switch</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>) {</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>:</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;    <span class="keywordflow">break</span>;</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;  <span class="keywordflow">case</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8527394a7d1a590228373b95f55a61a7">CURLE_AGAIN</a>:</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;    <span class="keywordflow">if</span>(!blocking)</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;      <span class="comment">/* CURLE_AGAIN in non-blocking mode is not an error */</span></div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;    <span class="comment">/* FALLTHROUGH */</span></div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;  <span class="keywordflow">default</span>:</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;  }</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;  <span class="keywordflow">if</span>(blocking) {</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;    <span class="comment">/* in blocking mode, set NSS non-blocking mode _after_ SSL handshake */</span></div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;    <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a> = nss_set_blocking(connssl, <a class="code" href="structdata.html">data</a>, <span class="comment">/* blocking */</span> <a class="code" href="curl__setup__once_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>)</div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a>;</div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;  }</div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;    <span class="comment">/* signal completed SSL handshake */</span></div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;    *done = <a class="code" href="multi-debugcallback_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;  connssl-&gt;<a class="code" href="structssl__connect__data.html#a46d3839ea70923be1efa7f85aba7f6a8">state</a> = <a class="code" href="urldata_8h.html#a2ea01ebd139c38e2285c7d2e17a2683fa88a671c415a487b02dbfd68cea24f98c">ssl_connection_complete</a>;</div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;  conn-&gt;<a class="code" href="structconnectdata.html#aec2de2220c36ec447f6101e85bf0a52b">recv</a>[sockindex] = nss_recv;</div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;  conn-&gt;<a class="code" href="structconnectdata.html#ada83cbd7d295b87033b7ea635c0a5dd5">send</a>[sockindex] = nss_send;</div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;</div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;  <span class="comment">/* ssl_connect_done is never used outside, go back to the initial state */</span></div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;  connssl-&gt;<a class="code" href="structssl__connect__data.html#a2de0f5a8b43b4e4550e22b1b8f3870e1">connecting_state</a> = <a class="code" href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1aff18b454b42fb95d95e3fd93130a5508">ssl_connect_1</a>;</div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;</div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;}</div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;</div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> Curl_nss_connect(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn, <span class="keywordtype">int</span> sockindex)</div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;{</div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;  <span class="keywordflow">return</span> nss_connect_common(conn, sockindex, <span class="comment">/* blocking */</span> NULL);</div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;}</div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;</div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> Curl_nss_connect_nonblocking(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn,</div><div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;                                             <span class="keywordtype">int</span> sockindex, <span class="keywordtype">bool</span> *done)</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;{</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;  <span class="keywordflow">return</span> nss_connect_common(conn, sockindex, done);</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;}</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;</div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;<span class="keyword">static</span> <a class="code" href="config-win32_8h.html#a8af93bbb66534e14d651bbb0638ee796">ssize_t</a> nss_send(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn,  <span class="comment">/* connection data */</span></div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;                        <span class="keywordtype">int</span> sockindex,             <span class="comment">/* socketindex */</span></div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;                        <span class="keyword">const</span> <span class="keywordtype">void</span> *mem,           <span class="comment">/* send this data */</span></div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;                        <span class="keywordtype">size_t</span> <a class="code" href="curl__sasl_8c.html#a7360b55975153b822efc5217b7734e6a">len</a>,                <span class="comment">/* amount to write */</span></div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;                        <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> *curlcode)</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;{</div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = &amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex];</div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;  <a class="code" href="config-win32_8h.html#a8af93bbb66534e14d651bbb0638ee796">ssize_t</a> <a class="code" href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">rc</a>;</div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;</div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;  <span class="comment">/* The SelectClientCert() hook uses this for infof() and failf() but the</span></div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="comment">     handle stored in nss_setup_connect() could have already been freed. */</span></div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;  BACKEND-&gt;data = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;</div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;  <a class="code" href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">rc</a> = PR_Send(BACKEND-&gt;handle, mem, (<span class="keywordtype">int</span>)<a class="code" href="curl__sasl_8c.html#a7360b55975153b822efc5217b7734e6a">len</a>, 0, PR_INTERVAL_NO_WAIT);</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;  <span class="keywordflow">if</span>(<a class="code" href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">rc</a> &lt; 0) {</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;    PRInt32 err = PR_GetError();</div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;    <span class="keywordflow">if</span>(err == PR_WOULD_BLOCK_ERROR)</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;      *curlcode = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8527394a7d1a590228373b95f55a61a7">CURLE_AGAIN</a>;</div><div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;      <span class="comment">/* print the error number and error string */</span></div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *err_name = nss_error_to_name(err);</div><div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;SSL write: error %d (%s)\n&quot;</span>, err, err_name);</div><div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;</div><div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;      <span class="comment">/* print a human-readable message describing the error if available */</span></div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;      nss_print_error_message(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, err);</div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;      *curlcode = (is_cc_error(err))</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;        ? <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a></div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;        : <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a9e0c77963cb42831dba8d5ee1840e80b">CURLE_SEND_ERROR</a>;</div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;    }</div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;</div><div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;  }</div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">rc</a>; <span class="comment">/* number of bytes */</span></div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;}</div><div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;</div><div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;<span class="keyword">static</span> <a class="code" href="config-win32_8h.html#a8af93bbb66534e14d651bbb0638ee796">ssize_t</a> nss_recv(<span class="keyword">struct</span> <a class="code" href="structconnectdata.html">connectdata</a> *conn,  <span class="comment">/* connection data */</span></div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;                        <span class="keywordtype">int</span> sockindex,             <span class="comment">/* socketindex */</span></div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;                        <span class="keywordtype">char</span> *<a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>,                 <span class="comment">/* store read data here */</span></div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;                        <span class="keywordtype">size_t</span> buffersize,         <span class="comment">/* max amount to read */</span></div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;                        <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> *curlcode)</div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;{</div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;  <span class="keyword">struct </span><a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl = &amp;conn-&gt;<a class="code" href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">ssl</a>[sockindex];</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;  <a class="code" href="config-win32_8h.html#a8af93bbb66534e14d651bbb0638ee796">ssize_t</a> nread;</div><div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;</div><div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;  <span class="comment">/* The SelectClientCert() hook uses this for infof() and failf() but the</span></div><div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;<span class="comment">     handle stored in nss_setup_connect() could have already been freed. */</span></div><div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;  BACKEND-&gt;data = conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>;</div><div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;  nread = PR_Recv(BACKEND-&gt;handle, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>, (<span class="keywordtype">int</span>)buffersize, 0,</div><div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;                  PR_INTERVAL_NO_WAIT);</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;  <span class="keywordflow">if</span>(nread &lt; 0) {</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    <span class="comment">/* failed SSL read */</span></div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;    PRInt32 err = PR_GetError();</div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;</div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;    <span class="keywordflow">if</span>(err == PR_WOULD_BLOCK_ERROR)</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;      *curlcode = <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a8527394a7d1a590228373b95f55a61a7">CURLE_AGAIN</a>;</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    <span class="keywordflow">else</span> {</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;      <span class="comment">/* print the error number and error string */</span></div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">char</span> *err_name = nss_error_to_name(err);</div><div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;      <a class="code" href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a>(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, <span class="stringliteral">&quot;SSL read: errno %d (%s)\n&quot;</span>, err, err_name);</div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;      <span class="comment">/* print a human-readable message describing the error if available */</span></div><div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;      nss_print_error_message(conn-&gt;<a class="code" href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">data</a>, err);</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;      *curlcode = (is_cc_error(err))</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;        ? <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a></div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;        : <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951ae6d701fdcc9728db65dadb0ec7d1eec1">CURLE_RECV_ERROR</a>;</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;    }</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;    <span class="keywordflow">return</span> -1;</div><div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;  }</div><div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;  <span class="keywordflow">return</span> nread;</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;}</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> Curl_nss_version(<span class="keywordtype">char</span> *<a class="code" href="unit1308_8c.html#a70a830d3039f37216dde9bcf2460aec2">buffer</a>, <span class="keywordtype">size_t</span> <a class="code" href="progress-bar_8d.html#ab8db689d5132c4523a63d67bedf23c8a">size</a>)</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;{</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="unit1652_8c.html#a348cae967f89c4bad8fb37e45a469d1a">msnprintf</a>(<a class="code" href="unit1308_8c.html#a70a830d3039f37216dde9bcf2460aec2">buffer</a>, <a class="code" href="progress-bar_8d.html#ab8db689d5132c4523a63d67bedf23c8a">size</a>, <span class="stringliteral">&quot;NSS/%s&quot;</span>, NSS_VERSION);</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;}</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;<span class="comment">/* data might be NULL */</span></div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> Curl_nss_seed(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>)</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;{</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;  <span class="comment">/* make sure that NSS is initialized */</span></div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;  <span class="keywordflow">return</span> !!Curl_nss_force_init(<a class="code" href="structdata.html">data</a>);</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;}</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;<span class="comment">/* data might be NULL */</span></div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> Curl_nss_random(<span class="keyword">struct</span> <a class="code" href="struct_curl__easy.html">Curl_easy</a> *<a class="code" href="structdata.html">data</a>,</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;                                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *entropy,</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;                                <span class="keywordtype">size_t</span> length)</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;{</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;  Curl_nss_seed(<a class="code" href="structdata.html">data</a>);  <span class="comment">/* Initiate the seed if not already done */</span></div><div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;</div><div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;  <span class="keywordflow">if</span>(SECSuccess != PK11_GenerateRandom(entropy, <a class="code" href="warnless_8c.html#a02468fae1f563370c5e18045d5bc2ecb">curlx_uztosi</a>(length)))</div><div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;    <span class="comment">/* signal a failure */</span></div><div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951a7c5e621b8f31e5f941e6044519b4c9c9">CURLE_FAILED_INIT</a>;</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;</div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;}</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;</div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> Curl_nss_md5sum(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *tmp, <span class="comment">/* input */</span></div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;                                <span class="keywordtype">size_t</span> tmplen,</div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;                                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *md5sum, <span class="comment">/* output */</span></div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;                                <span class="keywordtype">size_t</span> md5len)</div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;{</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;  PK11Context *MD5pw = PK11_CreateDigestContext(SEC_OID_MD5);</div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> MD5out;</div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;  PK11_DigestOp(MD5pw, tmp, <a class="code" href="warnless_8c.html#a20955df32ae739bf660266410d9e6526">curlx_uztoui</a>(tmplen));</div><div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;  PK11_DigestFinal(MD5pw, md5sum, &amp;MD5out, <a class="code" href="warnless_8c.html#a20955df32ae739bf660266410d9e6526">curlx_uztoui</a>(md5len));</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;  PK11_DestroyContext(MD5pw, PR_TRUE);</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;}</div><div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;</div><div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;<span class="keyword">static</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a> Curl_nss_sha256sum(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *tmp, <span class="comment">/* input */</span></div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;                               <span class="keywordtype">size_t</span> tmplen,</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;                               <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *sha256sum, <span class="comment">/* output */</span></div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;                               <span class="keywordtype">size_t</span> sha256len)</div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;{</div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;  PK11Context *SHA256pw = PK11_CreateDigestContext(SEC_OID_SHA256);</div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> SHA256out;</div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;</div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;  PK11_DigestOp(SHA256pw, tmp, <a class="code" href="warnless_8c.html#a20955df32ae739bf660266410d9e6526">curlx_uztoui</a>(tmplen));</div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;  PK11_DigestFinal(SHA256pw, sha256sum, &amp;SHA256out, <a class="code" href="warnless_8c.html#a20955df32ae739bf660266410d9e6526">curlx_uztoui</a>(sha256len));</div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;  PK11_DestroyContext(SHA256pw, PR_TRUE);</div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;</div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a>;</div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;}</div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> Curl_nss_cert_status_request(<span class="keywordtype">void</span>)</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;{</div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;<span class="preprocessor">#ifdef SSL_ENABLE_OCSP_STAPLING</span></div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="multi-debugcallback_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl__setup__once_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;}</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;</div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> Curl_nss_false_start(<span class="keywordtype">void</span>)</div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;{</div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;<span class="preprocessor">#if NSSVERNUM &gt;= 0x030f04 </span><span class="comment">/* 3.15.4 */</span><span class="preprocessor"></span></div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="multi-debugcallback_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;<span class="preprocessor">#else</span></div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="curl__setup__once_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;}</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;</div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> *Curl_nss_get_internals(<span class="keyword">struct</span> <a class="code" href="structssl__connect__data.html">ssl_connect_data</a> *connssl,</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;                                    <a class="code" href="curl_8h.html#aabc03ec968a2fdccde5c6709f712dd7b">CURLINFO</a> info <a class="code" href="curl__setup_8h.html#a32dce3380228f1a23cdc1f784263762b">UNUSED_PARAM</a>)</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;{</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;  (void)info;</div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;  <span class="keywordflow">return</span> BACKEND-&gt;handle;</div><div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;}</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;</div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;<span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="struct_curl__ssl.html">Curl_ssl</a> Curl_ssl_nss = {</div><div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;  { <a class="code" href="curl_8h.html#a908c5b707ac681212b8f8688cf76689da567f220081489bae5752a35182b4676d">CURLSSLBACKEND_NSS</a>, <span class="stringliteral">&quot;nss&quot;</span> }, <span class="comment">/* info */</span></div><div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;  <a class="code" href="vtls_8h.html#a25c48ad233afd4831acb0b0b699ed109">SSLSUPP_CA_PATH</a> |</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;  <a class="code" href="vtls_8h.html#af964d3e85b565ae20b4f85444b9b1619">SSLSUPP_CERTINFO</a> |</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;  <a class="code" href="vtls_8h.html#a932726d4856765a766c86e3a3ed29a8f">SSLSUPP_PINNEDPUBKEY</a> |</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;  <a class="code" href="vtls_8h.html#aa47defd1c2f78f3225dfc06c638c8689">SSLSUPP_HTTPS_PROXY</a>,</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;  <span class="keyword">sizeof</span>(<span class="keyword">struct </span>ssl_backend_data),</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;  Curl_nss_init,                <span class="comment">/* init */</span></div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;  Curl_nss_cleanup,             <span class="comment">/* cleanup */</span></div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;  Curl_nss_version,             <span class="comment">/* version */</span></div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;  Curl_nss_check_cxn,           <span class="comment">/* check_cxn */</span></div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;  <span class="comment">/* NSS has no shutdown function provided and thus always fail */</span></div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;  <a class="code" href="vtls_8h.html#a3c3bb919efb77b74d92b862902071389">Curl_none_shutdown</a>,           <span class="comment">/* shutdown */</span></div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;  <a class="code" href="vtls_8h.html#aba5f776941608a9d5c44fd0b422b1862">Curl_none_data_pending</a>,       <span class="comment">/* data_pending */</span></div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;  Curl_nss_random,              <span class="comment">/* random */</span></div><div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;  Curl_nss_cert_status_request, <span class="comment">/* cert_status_request */</span></div><div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;  Curl_nss_connect,             <span class="comment">/* connect */</span></div><div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;  Curl_nss_connect_nonblocking, <span class="comment">/* connect_nonblocking */</span></div><div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160;  Curl_nss_get_internals,       <span class="comment">/* get_internals */</span></div><div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;  Curl_nss_close,               <span class="comment">/* close_one */</span></div><div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;  <a class="code" href="vtls_8h.html#a054a6a646a0108d8f91a503d31a21671">Curl_none_close_all</a>,          <span class="comment">/* close_all */</span></div><div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;  <span class="comment">/* NSS has its own session ID cache */</span></div><div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;  <a class="code" href="vtls_8h.html#abd2be2ec8895660c6eb7e124cfac438e">Curl_none_session_free</a>,       <span class="comment">/* session_free */</span></div><div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;  <a class="code" href="vtls_8h.html#a7ccc438dc80065afa61534a12f49716b">Curl_none_set_engine</a>,         <span class="comment">/* set_engine */</span></div><div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;  <a class="code" href="vtls_8h.html#a06f0fb1d7887e2395f579c430c55e9da">Curl_none_set_engine_default</a>, <span class="comment">/* set_engine_default */</span></div><div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;  <a class="code" href="vtls_8h.html#a93de8d8215f8110779b3e2ab9d77dbd3">Curl_none_engines_list</a>,       <span class="comment">/* engines_list */</span></div><div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;  Curl_nss_false_start,         <span class="comment">/* false_start */</span></div><div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;  Curl_nss_md5sum,              <span class="comment">/* md5sum */</span></div><div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;  Curl_nss_sha256sum            <span class="comment">/* sha256sum */</span></div><div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;};</div><div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;</div><div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;<span class="preprocessor">#endif </span><span class="comment">/* USE_NSS */</span><span class="preprocessor"></span></div><div class="ttc" id="curl__memory_8h_html_a9cc854374299a1dd933bf62029761768"><div class="ttname"><a href="curl__memory_8h.html#a9cc854374299a1dd933bf62029761768">free</a></div><div class="ttdeci">#define free(ptr)</div><div class="ttdef"><b>Definition:</b> <a href="curl__memory_8h_source.html#l00130">curl_memory.h:130</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951aaa7a948caaac0addf8754794663f48b1"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951aaa7a948caaac0addf8754794663f48b1">CURLE_OPERATION_TIMEDOUT</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00498">curl.h:498</a></div></div>
<div class="ttc" id="structconnectdata_html_ab6f11cf5c5bc549e9f9af12fc65e2e23"><div class="ttname"><a href="structconnectdata.html#ab6f11cf5c5bc549e9f9af12fc65e2e23">connectdata::ssl</a></div><div class="ttdeci">struct ssl_connect_data ssl[2]</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00885">urldata.h:885</a></div></div>
<div class="ttc" id="curl__setup_8h_html_a32dce3380228f1a23cdc1f784263762b"><div class="ttname"><a href="curl__setup_8h.html#a32dce3380228f1a23cdc1f784263762b">UNUSED_PARAM</a></div><div class="ttdeci">#define UNUSED_PARAM</div><div class="ttdef"><b>Definition:</b> <a href="curl__setup_8h_source.html#l00699">curl_setup.h:699</a></div></div>
<div class="ttc" id="ftp_8c_html_a77812d4945cd21094debbd06962f0f01"><div class="ttname"><a href="ftp_8c.html#a77812d4945cd21094debbd06962f0f01">state</a></div><div class="ttdeci">#define state(x, y)</div><div class="ttdef"><b>Definition:</b> <a href="ftp_8c_source.html#l00101">ftp.c:101</a></div></div>
<div class="ttc" id="formdata_8h_html"><div class="ttname"><a href="formdata_8h.html">formdata.h</a></div></div>
<div class="ttc" id="cacert_8d_html_a967730876ca750551ce7a18429320343"><div class="ttname"><a href="cacert_8d.html#a967730876ca750551ce7a18429320343">library</a></div><div class="ttdeci">Long so this option is typically used to alter that default file.curl recognizes the environment variable named CURL_CA_BUNDLE if it is and uses the given path as a path to a CA cert bundle.This option overrides that variable.The windows version of curl will automatically look for a CA certs file named curl ca bundle.either in the same directory as curl.or in the Current Working or in any folder along your PATH.If curl is built against the NSS SSL library</div><div class="ttdef"><b>Definition:</b> <a href="cacert_8d_source.html#l00008">cacert.d:8</a></div></div>
<div class="ttc" id="structconnectdata_html_a9312f162d29fe7f59bc2b5dbeda85d9d"><div class="ttname"><a href="structconnectdata.html#a9312f162d29fe7f59bc2b5dbeda85d9d">connectdata::bits</a></div><div class="ttdeci">struct ConnectBits bits</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00894">urldata.h:894</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951ae6d701fdcc9728db65dadb0ec7d1eec1"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951ae6d701fdcc9728db65dadb0ec7d1eec1">CURLE_RECV_ERROR</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00527">curl.h:527</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a3d136f81a9d7bf281f4a050099438683"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a3d136f81a9d7bf281f4a050099438683">CURLE_SSL_CIPHER</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00530">curl.h:530</a></div></div>
<div class="ttc" id="proto_8d_html_a454d355bda85162423424da4a79fd517"><div class="ttname"><a href="proto_8d.html#a454d355bda85162423424da4a79fd517">protocols</a></div><div class="ttdeci">Long are comma and are each a protocol name or optionally prefixed by zero or more modifiers.Available modifiers removing it from the list of protocols already permitted..TP.though subject to later modification by subsequent entries in the comma separated list..RE.IP For but disables ftps.TP.B proto http only enables http and https.TP.B https also only enables http and https.RE Unknown protocols produce a warning.This allows scripts to safely rely on being able to disable potentially dangerous protocols</div><div class="ttdef"><b>Definition:</b> <a href="proto_8d_source.html#l00034">proto.d:34</a></div></div>
<div class="ttc" id="setup-vms_8h_html_aafc8c101dfb6313ab0416a6c5903ce66"><div class="ttname"><a href="setup-vms_8h.html#aafc8c101dfb6313ab0416a6c5903ce66">getenv</a></div><div class="ttdeci">#define getenv</div><div class="ttdef"><b>Definition:</b> <a href="setup-vms_8h_source.html#l00052">setup-vms.h:52</a></div></div>
<div class="ttc" id="struct_curl__easy_html"><div class="ttname"><a href="struct_curl__easy.html">Curl_easy</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l01755">urldata.h:1755</a></div></div>
<div class="ttc" id="curl_8h_html_a16af7b253440dadd46a80a4b9fddba4dadd0b0bf93854f50974d52f324d3259df"><div class="ttname"><a href="curl_8h.html#a16af7b253440dadd46a80a4b9fddba4dadd0b0bf93854f50974d52f324d3259df">CURL_SSLVERSION_MAX_NONE</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01985">curl.h:1985</a></div></div>
<div class="ttc" id="strcase_8h_html"><div class="ttname"><a href="strcase_8h.html">strcase.h</a></div></div>
<div class="ttc" id="structconnectdata_html_aec2de2220c36ec447f6101e85bf0a52b"><div class="ttname"><a href="structconnectdata.html#aec2de2220c36ec447f6101e85bf0a52b">connectdata::recv</a></div><div class="ttdeci">Curl_recv * recv[2]</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00879">urldata.h:879</a></div></div>
<div class="ttc" id="vtls_8h_html_a594e132ba0c0e860b62140083ead1c0d"><div class="ttname"><a href="vtls_8h.html#a594e132ba0c0e860b62140083ead1c0d">SSL_CONN_CONFIG</a></div><div class="ttdeci">#define SSL_CONN_CONFIG(var)</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00138">vtls.h:138</a></div></div>
<div class="ttc" id="struct_curl__ssl_html"><div class="ttname"><a href="struct_curl__ssl.html">Curl_ssl</a></div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00036">vtls.h:36</a></div></div>
<div class="ttc" id="structconnectdata_html_a0c1824e51ef689efcfddaa09a72c788b"><div class="ttname"><a href="structconnectdata.html#a0c1824e51ef689efcfddaa09a72c788b">connectdata::negnpn</a></div><div class="ttdeci">int negnpn</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l01032">urldata.h:1032</a></div></div>
<div class="ttc" id="vtls_8h_html_a25c48ad233afd4831acb0b0b699ed109"><div class="ttname"><a href="vtls_8h.html#a25c48ad233afd4831acb0b0b699ed109">SSLSUPP_CA_PATH</a></div><div class="ttdeci">#define SSLSUPP_CA_PATH</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00029">vtls.h:29</a></div></div>
<div class="ttc" id="structproxy__info_html_ae2cc9c2eb5c4ea0c4b92bf067e391bdc"><div class="ttname"><a href="structproxy__info.html#ae2cc9c2eb5c4ea0c4b92bf067e391bdc">proxy_info::host</a></div><div class="ttdeci">struct hostname host</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00752">urldata.h:752</a></div></div>
<div class="ttc" id="urldata_8h_html_a56b23efdd8d04b0179b52224a251bcb7"><div class="ttname"><a href="urldata_8h.html#a56b23efdd8d04b0179b52224a251bcb7">FIRSTSOCKET</a></div><div class="ttdeci">#define FIRSTSOCKET</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00480">urldata.h:480</a></div></div>
<div class="ttc" id="config-win32ce_8h_html_ad4ea824bd0fcae61733c900a5cab1e01"><div class="ttname"><a href="config-win32ce_8h.html#ad4ea824bd0fcae61733c900a5cab1e01">stat</a></div><div class="ttdeci">int stat(const char *path, struct stat *buffer)</div></div>
<div class="ttc" id="vtls_8h_html_af8e5805a5e7df10119ca90c13a2b1a79"><div class="ttname"><a href="vtls_8h.html#af8e5805a5e7df10119ca90c13a2b1a79">ALPN_HTTP_1_1</a></div><div class="ttdeci">#define ALPN_HTTP_1_1</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00128">vtls.h:128</a></div></div>
<div class="ttc" id="struct_user_defined_html_a3e98f04627c6f5ca7a9ae8c3edd85bd2"><div class="ttname"><a href="struct_user_defined.html#a3e98f04627c6f5ca7a9ae8c3edd85bd2">UserDefined::ssl</a></div><div class="ttdeci">struct ssl_config_data ssl</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l01594">urldata.h:1594</a></div></div>
<div class="ttc" id="curl_8h_html_ada0bbe252b7b370ef4e135b93b2fe71e"><div class="ttname"><a href="curl_8h.html#ada0bbe252b7b370ef4e135b93b2fe71e">CURL_SOCKET_BAD</a></div><div class="ttdeci">#define CURL_SOCKET_BAD</div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00131">curl.h:131</a></div></div>
<div class="ttc" id="vtls_8h_html_abd2be2ec8895660c6eb7e124cfac438e"><div class="ttname"><a href="vtls_8h.html#abd2be2ec8895660c6eb7e124cfac438e">Curl_none_session_free</a></div><div class="ttdeci">void Curl_none_session_free(void *ptr)</div></div>
<div class="ttc" id="connect_8h_html"><div class="ttname"><a href="connect_8h.html">connect.h</a></div></div>
<div class="ttc" id="sendf_8h_html_ae8e06000059e436c9c404603126718d6"><div class="ttname"><a href="sendf_8h.html#ae8e06000059e436c9c404603126718d6">failf</a></div><div class="ttdeci">#define failf</div><div class="ttdef"><b>Definition:</b> <a href="sendf_8h_source.html#l00048">sendf.h:48</a></div></div>
<div class="ttc" id="unit1608_8c_html_afb9ed1b8a27eb20854efe6e23e297683"><div class="ttname"><a href="unit1608_8c.html#afb9ed1b8a27eb20854efe6e23e297683">code</a></div><div class="ttdeci">CURLcode code</div><div class="ttdef"><b>Definition:</b> <a href="unit1608_8c_source.html#l00047">unit1608.c:47</a></div></div>
<div class="ttc" id="vtls_8h_html_a6d4d2d806ff1ab1428629b690f02e964"><div class="ttname"><a href="vtls_8h.html#a6d4d2d806ff1ab1428629b690f02e964">SSL_SET_OPTION</a></div><div class="ttdeci">#define SSL_SET_OPTION(var)</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00136">vtls.h:136</a></div></div>
<div class="ttc" id="curl_8h_html_a05589fbab0657f08285ebdfe93f5ec9eae9b72f6323430c824c44182b7649d0d8"><div class="ttname"><a href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9eae9b72f6323430c824c44182b7649d0d8">CURL_SSLVERSION_TLSv1_2</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01978">curl.h:1978</a></div></div>
<div class="ttc" id="sendf_8h_html"><div class="ttname"><a href="sendf_8h.html">sendf.h</a></div></div>
<div class="ttc" id="structssl__connect__data_html_a2de0f5a8b43b4e4550e22b1b8f3870e1"><div class="ttname"><a href="structssl__connect__data.html#a2de0f5a8b43b4e4550e22b1b8f3870e1">ssl_connect_data::connecting_state</a></div><div class="ttdeci">ssl_connect_state connecting_state</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00203">urldata.h:203</a></div></div>
<div class="ttc" id="curl__memory_8h_html_aa3f578f8f1eaebf25b2e2313db31cb40"><div class="ttname"><a href="curl__memory_8h.html#aa3f578f8f1eaebf25b2e2313db31cb40">strdup</a></div><div class="ttdeci">#define strdup(ptr)</div><div class="ttdef"><b>Definition:</b> <a href="curl__memory_8h_source.html#l00122">curl_memory.h:122</a></div></div>
<div class="ttc" id="curl_8h_html_a908c5b707ac681212b8f8688cf76689da567f220081489bae5752a35182b4676d"><div class="ttname"><a href="curl_8h.html#a908c5b707ac681212b8f8688cf76689da567f220081489bae5752a35182b4676d">CURLSSLBACKEND_NSS</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00141">curl.h:141</a></div></div>
<div class="ttc" id="curl_8h_html_a05589fbab0657f08285ebdfe93f5ec9ea0f8174e66c2e7084ab2aa414509110ce"><div class="ttname"><a href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea0f8174e66c2e7084ab2aa414509110ce">CURL_SSLVERSION_SSLv2</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01974">curl.h:1974</a></div></div>
<div class="ttc" id="curl__setup__once_8h_html_a23d7b88872d6ead46c978b567908d587"><div class="ttname"><a href="curl__setup__once_8h.html#a23d7b88872d6ead46c978b567908d587">DEBUGASSERT</a></div><div class="ttdeci">#define DEBUGASSERT(x)</div><div class="ttdef"><b>Definition:</b> <a href="curl__setup__once_8h_source.html#l00401">curl_setup_once.h:401</a></div></div>
<div class="ttc" id="urldata_8h_html_a9607658ec977f6ca435daf26b82f6b3fa83729aeebf5f0a20b00829bc3a6a1e9f"><div class="ttname"><a href="urldata_8h.html#a9607658ec977f6ca435daf26b82f6b3fa83729aeebf5f0a20b00829bc3a6a1e9f">STRING_SSL_PINNEDPUBLICKEY_ORIG</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l01429">urldata.h:1429</a></div></div>
<div class="ttc" id="multi-uv_8c_html_afb43b78d9a22f95e721353db4408304c"><div class="ttname"><a href="multi-uv_8c.html#afb43b78d9a22f95e721353db4408304c">timeout</a></div><div class="ttdeci">uv_timer_t timeout</div><div class="ttdef"><b>Definition:</b> <a href="multi-uv_8c_source.html#l00042">multi-uv.c:42</a></div></div>
<div class="ttc" id="structcurl__llist_html_a04c1d20c09bc187d0eb71fbaf463a4b7"><div class="ttname"><a href="structcurl__llist.html#a04c1d20c09bc187d0eb71fbaf463a4b7">curl_llist::tail</a></div><div class="ttdeci">struct curl_llist_element * tail</div><div class="ttdef"><b>Definition:</b> <a href="llist_8h_source.html#l00038">llist.h:38</a></div></div>
<div class="ttc" id="unit1330_8c_html_a367d241c5c363105ee629417d1dfba75"><div class="ttname"><a href="unit1330_8c.html#a367d241c5c363105ee629417d1dfba75">ptr</a></div><div class="ttdeci">UNITTEST_START char * ptr</div><div class="ttdef"><b>Definition:</b> <a href="unit1330_8c_source.html#l00038">unit1330.c:38</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951">CURLcode</a></div><div class="ttdeci">CURLcode</div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00457">curl.h:457</a></div></div>
<div class="ttc" id="structssl__config__data_html_a0280e8b30467433b1864e5be8060274e"><div class="ttname"><a href="structssl__config__data.html#a0280e8b30467433b1864e5be8060274e">ssl_config_data::certinfo</a></div><div class="ttdeci">bool certinfo</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00235">urldata.h:235</a></div></div>
<div class="ttc" id="curl_8h_html_aabc03ec968a2fdccde5c6709f712dd7b"><div class="ttname"><a href="curl_8h.html#aabc03ec968a2fdccde5c6709f712dd7b">CURLINFO</a></div><div class="ttdeci">CURLINFO</div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l02498">curl.h:2498</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a9e0c77963cb42831dba8d5ee1840e80b"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a9e0c77963cb42831dba8d5ee1840e80b">CURLE_SEND_ERROR</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00526">curl.h:526</a></div></div>
<div class="ttc" id="vtls_8h_html_a3c3bb919efb77b74d92b862902071389"><div class="ttname"><a href="vtls_8h.html#a3c3bb919efb77b74d92b862902071389">Curl_none_shutdown</a></div><div class="ttdeci">int Curl_none_shutdown(struct connectdata *conn, int sockindex)</div></div>
<div class="ttc" id="llist_8c_html_adf86d38f256b25809632d659a545c75d"><div class="ttname"><a href="llist_8c.html#adf86d38f256b25809632d659a545c75d">Curl_llist_init</a></div><div class="ttdeci">void Curl_llist_init(struct curl_llist *l, curl_llist_dtor dtor)</div><div class="ttdef"><b>Definition:</b> <a href="llist_8c_source.html#l00037">llist.c:37</a></div></div>
<div class="ttc" id="namespacedictserver_html_aeb700c49a1a229869c3b36509a6c6c32"><div class="ttname"><a href="namespacedictserver.html#aeb700c49a1a229869c3b36509a6c6c32">dictserver.rc</a></div><div class="ttdeci">def rc</div><div class="ttdef"><b>Definition:</b> <a href="dictserver_8py_source.html#l00153">dictserver.py:153</a></div></div>
<div class="ttc" id="unit1399_8c_html_acf1e931ffa73126ce876102dc2186895"><div class="ttname"><a href="unit1399_8c.html#acf1e931ffa73126ce876102dc2186895">now</a></div><div class="ttdeci">struct curltime now</div><div class="ttdef"><b>Definition:</b> <a href="unit1399_8c_source.html#l00083">unit1399.c:83</a></div></div>
<div class="ttc" id="vtls_8h_html_aba5f776941608a9d5c44fd0b422b1862"><div class="ttname"><a href="vtls_8h.html#aba5f776941608a9d5c44fd0b422b1862">Curl_none_data_pending</a></div><div class="ttdeci">bool Curl_none_data_pending(const struct connectdata *conn, int connindex)</div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a785786e70ed591f03e61a7d0175d417f"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a785786e70ed591f03e61a7d0175d417f">CURLE_SSL_PINNEDPUBKEYNOTMATCH</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00578">curl.h:578</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a8527394a7d1a590228373b95f55a61a7"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a8527394a7d1a590228373b95f55a61a7">CURLE_AGAIN</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00564">curl.h:564</a></div></div>
<div class="ttc" id="vtls_8h_html_af964d3e85b565ae20b4f85444b9b1619"><div class="ttname"><a href="vtls_8h.html#af964d3e85b565ae20b4f85444b9b1619">SSLSUPP_CERTINFO</a></div><div class="ttdeci">#define SSLSUPP_CERTINFO</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00030">vtls.h:30</a></div></div>
<div class="ttc" id="structconnectdata_html_a91d94af5dfef86510940d658476b61cf"><div class="ttname"><a href="structconnectdata.html#a91d94af5dfef86510940d658476b61cf">connectdata::host</a></div><div class="ttdeci">struct hostname host</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00830">urldata.h:830</a></div></div>
<div class="ttc" id="struct_connect_bits_html_a15d98c2eae880b790963d2b0d15a85dc"><div class="ttname"><a href="struct_connect_bits.html#a15d98c2eae880b790963d2b0d15a85dc">ConnectBits::tls_enable_alpn</a></div><div class="ttdeci">bool tls_enable_alpn</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00440">urldata.h:440</a></div></div>
<div class="ttc" id="urldata_8h_html_a2ea01ebd139c38e2285c7d2e17a2683fa88a671c415a487b02dbfd68cea24f98c"><div class="ttname"><a href="urldata_8h.html#a2ea01ebd139c38e2285c7d2e17a2683fa88a671c415a487b02dbfd68cea24f98c">ssl_connection_complete</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00190">urldata.h:190</a></div></div>
<div class="ttc" id="vtls_8h_html_aa47defd1c2f78f3225dfc06c638c8689"><div class="ttname"><a href="vtls_8h.html#aa47defd1c2f78f3225dfc06c638c8689">SSLSUPP_HTTPS_PROXY</a></div><div class="ttdeci">#define SSLSUPP_HTTPS_PROXY</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00033">vtls.h:33</a></div></div>
<div class="ttc" id="strcase_8h_html_a4b6a8324b9a93ddfa5413308a22bfa44"><div class="ttname"><a href="strcase_8h.html#a4b6a8324b9a93ddfa5413308a22bfa44">strcasecompare</a></div><div class="ttdeci">#define strcasecompare(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="strcase_8h_source.html#l00035">strcase.h:35</a></div></div>
<div class="ttc" id="warnless_8c_html_a02468fae1f563370c5e18045d5bc2ecb"><div class="ttname"><a href="warnless_8c.html#a02468fae1f563370c5e18045d5bc2ecb">curlx_uztosi</a></div><div class="ttdeci">int curlx_uztosi(size_t uznum)</div><div class="ttdef"><b>Definition:</b> <a href="warnless_8c_source.html#l00203">warnless.c:203</a></div></div>
<div class="ttc" id="curl__memory_8h_html_a2eb0b03d1a9de9615a291b1205969069"><div class="ttname"><a href="curl__memory_8h.html#a2eb0b03d1a9de9615a291b1205969069">malloc</a></div><div class="ttdeci">#define malloc(size)</div><div class="ttdef"><b>Definition:</b> <a href="curl__memory_8h_source.html#l00124">curl_memory.h:124</a></div></div>
<div class="ttc" id="curl__ctype_8h_html_aad859b17f001ee9fd0b0e49a7deb27b2"><div class="ttname"><a href="curl__ctype_8h.html#aad859b17f001ee9fd0b0e49a7deb27b2">ISSPACE</a></div><div class="ttdeci">#define ISSPACE(x)</div><div class="ttdef"><b>Definition:</b> <a href="curl__ctype_8h_source.html#l00064">curl_ctype.h:64</a></div></div>
<div class="ttc" id="structhostname_html_a9c9ce90bfcab1734f9376c6539d92cdd"><div class="ttname"><a href="structhostname.html#a9c9ce90bfcab1734f9376c6539d92cdd">hostname::name</a></div><div class="ttdeci">char * name</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00449">urldata.h:449</a></div></div>
<div class="ttc" id="unit1304_8c_html_a937d4dd628a8858b443a399410d2600b"><div class="ttname"><a href="unit1304_8c.html#a937d4dd628a8858b443a399410d2600b">result</a></div><div class="ttdeci">UNITTEST_START int result</div><div class="ttdef"><b>Definition:</b> <a href="unit1304_8c_source.html#l00049">unit1304.c:49</a></div></div>
<div class="ttc" id="unit1308_8c_html_a70a830d3039f37216dde9bcf2460aec2"><div class="ttname"><a href="unit1308_8c.html#a70a830d3039f37216dde9bcf2460aec2">buffer</a></div><div class="ttdeci">char buffer[]</div><div class="ttdef"><b>Definition:</b> <a href="unit1308_8c_source.html#l00048">unit1308.c:48</a></div></div>
<div class="ttc" id="unit1303_8c_html_ac8936188af0c1d2f8b9d0cd25fde43b2"><div class="ttname"><a href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a></div><div class="ttdeci">unsigned int i</div><div class="ttdef"><b>Definition:</b> <a href="unit1303_8c_source.html#l00078">unit1303.c:78</a></div></div>
<div class="ttc" id="curl_8h_html_a05589fbab0657f08285ebdfe93f5ec9ea196e49e6628c0360cbe00852964fa906"><div class="ttname"><a href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea196e49e6628c0360cbe00852964fa906">CURL_SSLVERSION_SSLv3</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01975">curl.h:1975</a></div></div>
<div class="ttc" id="curl_8h_html_abc5c98fcc1211af2b80116dd6e0a035da2bdca7ce6479378784212fee3a068c74"><div class="ttname"><a href="curl_8h.html#abc5c98fcc1211af2b80116dd6e0a035da2bdca7ce6479378784212fee3a068c74">CURL_HTTP_VERSION_1_1</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01926">curl.h:1926</a></div></div>
<div class="ttc" id="form_8d_html_a2ff994e16bf9521154de4cf659a3b689"><div class="ttname"><a href="form_8d.html#a2ff994e16bf9521154de4cf659a3b689">filename</a></div><div class="ttdeci">filename</div><div class="ttdef"><b>Definition:</b> <a href="form_8d_source.html#l00057">form.d:57</a></div></div>
<div class="ttc" id="curl__sasl_8c_html_a7360b55975153b822efc5217b7734e6a"><div class="ttname"><a href="curl__sasl_8c.html#a7360b55975153b822efc5217b7734e6a">len</a></div><div class="ttdeci">size_t len</div><div class="ttdef"><b>Definition:</b> <a href="curl__sasl_8c_source.html#l00055">curl_sasl.c:55</a></div></div>
<div class="ttc" id="structconnectdata_html_a4df63a4042ad767671bb3bfd74aa68fc"><div class="ttname"><a href="structconnectdata.html#a4df63a4042ad767671bb3bfd74aa68fc">connectdata::http_proxy</a></div><div class="ttdeci">struct proxy_info http_proxy</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00837">urldata.h:837</a></div></div>
<div class="ttc" id="struct_connect_bits_html_af764c68e6af921d2073c498f80741ea4"><div class="ttname"><a href="struct_connect_bits.html#af764c68e6af921d2073c498f80741ea4">ConnectBits::tunnel_proxy</a></div><div class="ttdeci">bool tunnel_proxy</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00405">urldata.h:405</a></div></div>
<div class="ttc" id="curl__printf_8h_html"><div class="ttname"><a href="curl__printf_8h.html">curl_printf.h</a></div></div>
<div class="ttc" id="structssl__connect__data_html_a46d3839ea70923be1efa7f85aba7f6a8"><div class="ttname"><a href="structssl__connect__data.html#a46d3839ea70923be1efa7f85aba7f6a8">ssl_connect_data::state</a></div><div class="ttdeci">ssl_connection_state state</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00202">urldata.h:202</a></div></div>
<div class="ttc" id="curl_8h_html_a05589fbab0657f08285ebdfe93f5ec9eaf516898239e1f4a335ab3c0d019de40e"><div class="ttname"><a href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9eaf516898239e1f4a335ab3c0d019de40e">CURL_SSLVERSION_TLSv1</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01973">curl.h:1973</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a8e6bdaad09a5404d9b01acaa93e1a797"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a8e6bdaad09a5404d9b01acaa93e1a797">CURLE_SSL_CACERT_BADFILE</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00555">curl.h:555</a></div></div>
<div class="ttc" id="vtls_8h_html"><div class="ttname"><a href="vtls_8h.html">vtls.h</a></div></div>
<div class="ttc" id="unit1304_8c_html_a82a69fcfe92d9db6dd585ccc532a2ab7"><div class="ttname"><a href="unit1304_8c.html#a82a69fcfe92d9db6dd585ccc532a2ab7">memcpy</a></div><div class="ttdeci">memcpy(filename, filename1, strlen(filename1))</div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951aba5a22c9f705ed27933344be221fe937">CURLE_OUT_OF_MEMORY</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00493">curl.h:493</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a5ffb4b97de06318ffbd19405b18494f9">CURLE_SSL_CERTPROBLEM</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00529">curl.h:529</a></div></div>
<div class="ttc" id="vtls_8h_html_a9043fcf68904db7a0844fb55857bd482"><div class="ttname"><a href="vtls_8h.html#a9043fcf68904db7a0844fb55857bd482">ALPN_HTTP_1_1_LENGTH</a></div><div class="ttdeci">#define ALPN_HTTP_1_1_LENGTH</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00127">vtls.h:127</a></div></div>
<div class="ttc" id="structssl__connect__data_html_ad63d8e461921062845bbf07dfc0007c5"><div class="ttname"><a href="structssl__connect__data.html#ad63d8e461921062845bbf07dfc0007c5">ssl_connect_data::use</a></div><div class="ttdeci">bool use</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00201">urldata.h:201</a></div></div>
<div class="ttc" id="unit1398_8c_html_af25d6dc49269fa2003ac7c7fa6f13915"><div class="ttname"><a href="unit1398_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a></div><div class="ttdeci">const char * str</div><div class="ttdef"><b>Definition:</b> <a href="unit1398_8c_source.html#l00033">unit1398.c:33</a></div></div>
<div class="ttc" id="curl__setup__once_8h_html_aa93f0eb578d23995850d61f7d61c55c1"><div class="ttname"><a href="curl__setup__once_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a></div><div class="ttdeci">#define FALSE</div><div class="ttdef"><b>Definition:</b> <a href="curl__setup__once_8h_source.html#l00327">curl_setup_once.h:327</a></div></div>
<div class="ttc" id="config_8d_html_a9fb4830d0cbef7d3cf48425ce59f580a"><div class="ttname"><a href="config_8d.html#a9fb4830d0cbef7d3cf48425ce59f580a">n</a></div><div class="ttdeci">Long separated by or the equals sign.Long option names can optionally be given in the config file without the initial double dashes and if the colon or equals characters can be used as separators.If the option is specified with one or two there can be no colon or equals character between the option and its parameter.If the parameter is to contain the parameter must be enclosed within quotes.Within double the following escape sequences are n</div><div class="ttdef"><b>Definition:</b> <a href="config_8d_source.html#l00011">config.d:11</a></div></div>
<div class="ttc" id="vtls_8h_html_a932726d4856765a766c86e3a3ed29a8f"><div class="ttname"><a href="vtls_8h.html#a932726d4856765a766c86e3a3ed29a8f">SSLSUPP_PINNEDPUBKEY</a></div><div class="ttdeci">#define SSLSUPP_PINNEDPUBKEY</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00031">vtls.h:31</a></div></div>
<div class="ttc" id="connect_8c_html_aed32c0fb99c80a40c097c98a3eb03c74"><div class="ttname"><a href="connect_8c.html#aed32c0fb99c80a40c097c98a3eb03c74">Curl_timeleft</a></div><div class="ttdeci">timediff_t Curl_timeleft(struct Curl_easy *data, struct curltime *nowp, bool duringconnect)</div><div class="ttdef"><b>Definition:</b> <a href="connect_8c_source.html#l00184">connect.c:184</a></div></div>
<div class="ttc" id="select_8h_html"><div class="ttname"><a href="select_8h.html">select.h</a></div></div>
<div class="ttc" id="remote-name_8d_html_aa335f8bb20424b03700f57b150bf0aa6"><div class="ttname"><a href="remote-name_8d.html#aa335f8bb20424b03700f57b150bf0aa6">name</a></div><div class="ttdeci">Long the path is cut off.The file will be saved in the current working directory.If you want the file saved in a different make sure you change the current working directory before invoking curl with this option.The remote file name to use for saving is extracted from the given nothing and if it already exists it will be overwritten.If you want the server to be able to choose the file name refer to remote header name which can be used in addition to this option.If the server chooses a file name and that name already exists it will not be overwritten.There is no URL decoding done on the file name.If it has or other URL encoded parts of the name</div><div class="ttdef"><b>Definition:</b> <a href="remote-name_8d_source.html#l00006">remote-name.d:6</a></div></div>
<div class="ttc" id="structssl__connect__data_html"><div class="ttname"><a href="structssl__connect__data.html">ssl_connect_data</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00197">urldata.h:197</a></div></div>
<div class="ttc" id="urldata_8h_html_ace0075850efad1d17ded7b56129fb3d1a8c6d961fbef3442f91a0c29191e83256"><div class="ttname"><a href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a8c6d961fbef3442f91a0c29191e83256">ssl_connect_2_writing</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00182">urldata.h:182</a></div></div>
<div class="ttc" id="_b_l_e_device_8cpp_html_aedeffc7d23da25d52b9a50045189fe2b"><div class="ttname"><a href="_b_l_e_device_8cpp.html#aedeffc7d23da25d52b9a50045189fe2b">initialized</a></div><div class="ttdeci">bool initialized</div><div class="ttdef"><b>Definition:</b> <a href="_b_l_e_device_8cpp_source.html#l00044">BLEDevice.cpp:44</a></div></div>
<div class="ttc" id="curl_8h_html_a05589fbab0657f08285ebdfe93f5ec9ea0227d3edc8c1ee5f0bb41831912ce756"><div class="ttname"><a href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea0227d3edc8c1ee5f0bb41831912ce756">CURL_SSLVERSION_DEFAULT</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01972">curl.h:1972</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951af47b7606f9b1ac9d655fe959fdefbd7d">CURLE_SSL_CONNECT_ERROR</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00505">curl.h:505</a></div></div>
<div class="ttc" id="structconnectdata_html_ada83cbd7d295b87033b7ea635c0a5dd5"><div class="ttname"><a href="structconnectdata.html#ada83cbd7d295b87033b7ea635c0a5dd5">connectdata::send</a></div><div class="ttdeci">Curl_send * send[2]</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00880">urldata.h:880</a></div></div>
<div class="ttc" id="warnless_8c_html_a20955df32ae739bf660266410d9e6526"><div class="ttname"><a href="warnless_8c.html#a20955df32ae739bf660266410d9e6526">curlx_uztoui</a></div><div class="ttdeci">unsigned int curlx_uztoui(size_t uznum)</div><div class="ttdef"><b>Definition:</b> <a href="warnless_8c_source.html#l00243">warnless.c:243</a></div></div>
<div class="ttc" id="fail-early_8d_html_a2b978ebca1e6cb7fcbcb9a6b51701ce3"><div class="ttname"><a href="fail-early_8d.html#a2b978ebca1e6cb7fcbcb9a6b51701ce3">fail</a></div><div class="ttdeci">Long do not continue it will attempt to operate on each given one by one.By it will ignore errors if there are more URLs given and the last URL s success will determine the error code curl returns.So early failures will be hidden by subsequent successful transfers.Using this curl will instead return an error on the first transfer that independent of the amount of URLs that are given on the command line.This no transfer failures go undetected by scripts and similar.This option is global and does not need to be specified for each use of next.This option does not imply fail</div><div class="ttdef"><b>Definition:</b> <a href="fail-early_8d_source.html#l00002">fail-early.d:2</a></div></div>
<div class="ttc" id="urldata_8h_html_ace0075850efad1d17ded7b56129fb3d1a83e9e80af0be0e0a560a5c925cc2e216"><div class="ttname"><a href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a83e9e80af0be0e0a560a5c925cc2e216">ssl_connect_2_reading</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00181">urldata.h:181</a></div></div>
<div class="ttc" id="curl__memory_8h_html"><div class="ttname"><a href="curl__memory_8h.html">curl_memory.h</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951af2fb280cf805aa199f6b63a2a27c318b">CURLE_OK</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00458">curl.h:458</a></div></div>
<div class="ttc" id="struct_curl__easy_html_abcc5aa61af150adc1388b1a3492c2599"><div class="ttname"><a href="struct_curl__easy.html#abcc5aa61af150adc1388b1a3492c2599">Curl_easy::set</a></div><div class="ttdeci">struct UserDefined set</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l01788">urldata.h:1788</a></div></div>
<div class="ttc" id="memdebug_8h_html_a1c013eb828d138f0445cbf4f9aca2ed8"><div class="ttname"><a href="memdebug_8h.html#a1c013eb828d138f0445cbf4f9aca2ed8">fake_sclose</a></div><div class="ttdeci">#define fake_sclose(x)</div><div class="ttdef"><b>Definition:</b> <a href="memdebug_8h_source.html#l00167">memdebug.h:167</a></div></div>
<div class="ttc" id="curl__setup_8h_html"><div class="ttname"><a href="curl__setup_8h.html">curl_setup.h</a></div></div>
<div class="ttc" id="curl__printf_8h_html_a3e3dfee99c81f563d18ef4626d8886e1"><div class="ttname"><a href="curl__printf_8h.html#a3e3dfee99c81f563d18ef4626d8886e1">aprintf</a></div><div class="ttdeci">#define aprintf</div><div class="ttdef"><b>Definition:</b> <a href="curl__printf_8h_source.html#l00046">curl_printf.h:46</a></div></div>
<div class="ttc" id="unit1652_8c_html_a1d19b0eef3b3acd31be88886a0277c2e"><div class="ttname"><a href="unit1652_8c.html#a1d19b0eef3b3acd31be88886a0277c2e">memset</a></div><div class="ttdeci">memset(input, '\0', sizeof(input))</div></div>
<div class="ttc" id="structcurl__llist__element_html"><div class="ttname"><a href="structcurl__llist__element.html">curl_llist_element</a></div><div class="ttdef"><b>Definition:</b> <a href="llist_8h_source.html#l00030">llist.h:30</a></div></div>
<div class="ttc" id="vtls_8h_html_a7ccc438dc80065afa61534a12f49716b"><div class="ttname"><a href="vtls_8h.html#a7ccc438dc80065afa61534a12f49716b">Curl_none_set_engine</a></div><div class="ttdeci">CURLcode Curl_none_set_engine(struct Curl_easy *data, const char *engine)</div></div>
<div class="ttc" id="progress-bar_8d_html_ab8db689d5132c4523a63d67bedf23c8a"><div class="ttname"><a href="progress-bar_8d.html#ab8db689d5132c4523a63d67bedf23c8a">size</a></div><div class="ttdeci">Short more meter.This progress bar draws a single line of shows a percentage if the transfer size is known.For transfers without a known size</div><div class="ttdef"><b>Definition:</b> <a href="progress-bar_8d_source.html#l00006">progress-bar.d:6</a></div></div>
<div class="ttc" id="llist_8h_html"><div class="ttname"><a href="llist_8h.html">llist.h</a></div></div>
<div class="ttc" id="config-win32_8h_html_a8af93bbb66534e14d651bbb0638ee796"><div class="ttname"><a href="config-win32_8h.html#a8af93bbb66534e14d651bbb0638ee796">ssize_t</a></div><div class="ttdeci">#define ssize_t</div><div class="ttdef"><b>Definition:</b> <a href="config-win32_8h_source.html#l00379">config-win32.h:379</a></div></div>
<div class="ttc" id="_adafruit___g_f_x_8cpp_html_ac6afabdc09a49a433ee19d8a9486056d"><div class="ttname"><a href="_adafruit___g_f_x_8cpp.html#ac6afabdc09a49a433ee19d8a9486056d">min</a></div><div class="ttdeci">#define min(a, b)</div><div class="ttdef"><b>Definition:</b> <a href="_adafruit___g_f_x_8cpp_source.html#l00040">Adafruit_GFX.cpp:40</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a7c5e621b8f31e5f941e6044519b4c9c9"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a7c5e621b8f31e5f941e6044519b4c9c9">CURLE_FAILED_INIT</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00460">curl.h:460</a></div></div>
<div class="ttc" id="structconnectdata_html_a13cc2123ad38902e8ad44e67f10ed7aa"><div class="ttname"><a href="structconnectdata.html#a13cc2123ad38902e8ad44e67f10ed7aa">connectdata::sock</a></div><div class="ttdeci">curl_socket_t sock[2]</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00874">urldata.h:874</a></div></div>
<div class="ttc" id="_b_l_e_eddystone_t_l_m_8h_html_ab22abc2906422da61885ac6c8e6a1a59"><div class="ttname"><a href="_b_l_e_eddystone_t_l_m_8h.html#ab22abc2906422da61885ac6c8e6a1a59">version</a></div><div class="ttdeci">uint8_t version</div><div class="ttdef"><b>Definition:</b> <a href="_b_l_e_eddystone_t_l_m_8h_source.html#l00041">BLEEddystoneTLM.h:41</a></div></div>
<div class="ttc" id="urldata_8h_html_ad073adb2b5b8a2f9ab8eb0dcae415efc"><div class="ttname"><a href="urldata_8h.html#ad073adb2b5b8a2f9ab8eb0dcae415efc">Curl_recv</a></div><div class="ttdeci">ssize_t() Curl_recv(struct connectdata *conn, int sockindex, char *buf, size_t len, CURLcode *err)</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00110">urldata.h:110</a></div></div>
<div class="ttc" id="curl_8h_html_a05589fbab0657f08285ebdfe93f5ec9ea769044d53450fd19575f12b2838f54d0"><div class="ttname"><a href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea769044d53450fd19575f12b2838f54d0">CURL_SSLVERSION_TLSv1_0</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01976">curl.h:1976</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a746b63c8123f5bdc10a916f720f2c9e5"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a746b63c8123f5bdc10a916f720f2c9e5">CURLE_PEER_FAILED_VERIFICATION</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00531">curl.h:531</a></div></div>
<div class="ttc" id="vtls_8h_html_a93de8d8215f8110779b3e2ab9d77dbd3"><div class="ttname"><a href="vtls_8h.html#a93de8d8215f8110779b3e2ab9d77dbd3">Curl_none_engines_list</a></div><div class="ttdeci">struct curl_slist * Curl_none_engines_list(struct Curl_easy *data)</div></div>
<div class="ttc" id="urldata_8h_html_a9f02ef6c16f171ef6fd36b7903e91b41"><div class="ttname"><a href="urldata_8h.html#a9f02ef6c16f171ef6fd36b7903e91b41">Curl_send</a></div><div class="ttdeci">ssize_t() Curl_send(struct connectdata *conn, int sockindex, const void *buf, size_t len, CURLcode *err)</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00103">urldata.h:103</a></div></div>
<div class="ttc" id="unit1652_8c_html_a348cae967f89c4bad8fb37e45a469d1a"><div class="ttname"><a href="unit1652_8c.html#a348cae967f89c4bad8fb37e45a469d1a">msnprintf</a></div><div class="ttdeci">UNITTEST_START msnprintf(input, sizeof(input), &quot;Simple Test&quot;)</div></div>
<div class="ttc" id="unit1398_8c_html_aee5a1edd73e85934dcbe27ccbb1ef1ad"><div class="ttname"><a href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a></div><div class="ttdeci">char buf[3]</div><div class="ttdef"><b>Definition:</b> <a href="unit1398_8c_source.html#l00032">unit1398.c:32</a></div></div>
<div class="ttc" id="llist_8c_html_a8ea7dbefac355279ad19f3dfe345a45a"><div class="ttname"><a href="llist_8c.html#a8ea7dbefac355279ad19f3dfe345a45a">Curl_llist_destroy</a></div><div class="ttdeci">void Curl_llist_destroy(struct curl_llist *list, void *user)</div><div class="ttdef"><b>Definition:</b> <a href="llist_8c_source.html#l00134">llist.c:134</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a241c54474fe64668004fc8d15496085c"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a241c54474fe64668004fc8d15496085c">CURLE_SSL_CRL_BADFILE</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00567">curl.h:567</a></div></div>
<div class="ttc" id="urldata_8h_html_a9607658ec977f6ca435daf26b82f6b3fa85af043a41434c1b4f439fb89d5c9047"><div class="ttname"><a href="urldata_8h.html#a9607658ec977f6ca435daf26b82f6b3fa85af043a41434c1b4f439fb89d5c9047">STRING_SSL_PINNEDPUBLICKEY_PROXY</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l01430">urldata.h:1430</a></div></div>
<div class="ttc" id="sendf_8h_html_a0056494e05c065643a400059b9318270"><div class="ttname"><a href="sendf_8h.html#a0056494e05c065643a400059b9318270">infof</a></div><div class="ttdeci">#define infof</div><div class="ttdef"><b>Definition:</b> <a href="sendf_8h_source.html#l00044">sendf.h:44</a></div></div>
<div class="ttc" id="urldata_8h_html_ace0075850efad1d17ded7b56129fb3d1a02630bc60f6cd9c202c67e33784ee7a5"><div class="ttname"><a href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1a02630bc60f6cd9c202c67e33784ee7a5">ssl_connect_2</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00180">urldata.h:180</a></div></div>
<div class="ttc" id="curl_8h_html_a05589fbab0657f08285ebdfe93f5ec9ea3659f18972112848e04fec39daf19985"><div class="ttname"><a href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea3659f18972112848e04fec39daf19985">CURL_SSLVERSION_TLSv1_1</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01977">curl.h:1977</a></div></div>
<div class="ttc" id="curl_8h_html_a16af7b253440dadd46a80a4b9fddba4da724f1960f9dd1cfe462c0eca7f4e7da0"><div class="ttname"><a href="curl_8h.html#a16af7b253440dadd46a80a4b9fddba4da724f1960f9dd1cfe462c0eca7f4e7da0">CURL_SSLVERSION_MAX_DEFAULT</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01986">curl.h:1986</a></div></div>
<div class="ttc" id="structconnectdata_html_a57fed5d378439f0b8cbad7cc9e916604"><div class="ttname"><a href="structconnectdata.html#a57fed5d378439f0b8cbad7cc9e916604">connectdata::proxy_ssl</a></div><div class="ttdeci">struct ssl_connect_data proxy_ssl[2]</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00886">urldata.h:886</a></div></div>
<div class="ttc" id="curl_8h_html_a49d83160803f433b12209ed52aafc05f"><div class="ttname"><a href="curl_8h.html#a49d83160803f433b12209ed52aafc05f">CURL_HTTP_VERSION_2</a></div><div class="ttdeci">#define CURL_HTTP_VERSION_2</div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01938">curl.h:1938</a></div></div>
<div class="ttc" id="urldata_8h_html_ace0075850efad1d17ded7b56129fb3d1"><div class="ttname"><a href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1">ssl_connect_state</a></div><div class="ttdeci">ssl_connect_state</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00178">urldata.h:178</a></div></div>
<div class="ttc" id="llist_8c_html_a9fb691307db5bfd5d29315b96b56ad2b"><div class="ttname"><a href="llist_8c.html#a9fb691307db5bfd5d29315b96b56ad2b">Curl_llist_insert_next</a></div><div class="ttdeci">void Curl_llist_insert_next(struct curl_llist *list, struct curl_llist_element *e, const void *p, struct curl_llist_element *ne)</div><div class="ttdef"><b>Definition:</b> <a href="llist_8c_source.html#l00057">llist.c:57</a></div></div>
<div class="ttc" id="curl_8h_html_a05589fbab0657f08285ebdfe93f5ec9ea3a20a62139a18a0577154835dc642c0d"><div class="ttname"><a href="curl_8h.html#a05589fbab0657f08285ebdfe93f5ec9ea3a20a62139a18a0577154835dc642c0d">CURL_SSLVERSION_TLSv1_3</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l01979">curl.h:1979</a></div></div>
<div class="ttc" id="warnless_8h_html"><div class="ttname"><a href="warnless_8h.html">warnless.h</a></div></div>
<div class="ttc" id="urldata_8h_html"><div class="ttname"><a href="urldata_8h.html">urldata.h</a></div></div>
<div class="ttc" id="multi-debugcallback_8c_html_aa8cecfc5c5c054d2875c03e77b7be15d"><div class="ttname"><a href="multi-debugcallback_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a></div><div class="ttdeci">#define TRUE</div><div class="ttdef"><b>Definition:</b> <a href="multi-debugcallback_8c_source.html#l00038">multi-debugcallback.c:38</a></div></div>
<div class="ttc" id="structcurl__llist_html"><div class="ttname"><a href="structcurl__llist.html">curl_llist</a></div><div class="ttdef"><b>Definition:</b> <a href="llist_8h_source.html#l00036">llist.h:36</a></div></div>
<div class="ttc" id="mprintf_8h_html_a0d5de0d2e86ff46856dc5bc0ae371c2a"><div class="ttname"><a href="mprintf_8h.html#a0d5de0d2e86ff46856dc5bc0ae371c2a">curl_maprintf</a></div><div class="ttdeci">CURL_EXTERN char * curl_maprintf(const char *format,...)</div><div class="ttdef"><b>Definition:</b> <a href="mprintf_8c_source.html#l01066">mprintf.c:1066</a></div></div>
<div class="ttc" id="nssg_8h_html"><div class="ttname"><a href="nssg_8h.html">nssg.h</a></div></div>
<div class="ttc" id="memdebug_8h_html"><div class="ttname"><a href="memdebug_8h.html">memdebug.h</a></div></div>
<div class="ttc" id="curl_8h_html_adb5a46d02359d2379dc7e0904c987828"><div class="ttname"><a href="curl_8h.html#adb5a46d02359d2379dc7e0904c987828">curl_socket_t</a></div><div class="ttdeci">int curl_socket_t</div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00130">curl.h:130</a></div></div>
<div class="ttc" id="curl_8h_html_af0691941698240652e0a391394217951a567c864875b56a6fed90ca22bc89a5a2"><div class="ttname"><a href="curl_8h.html#af0691941698240652e0a391394217951a567c864875b56a6fed90ca22bc89a5a2">CURLE_SSL_ISSUER_ERROR</a></div><div class="ttdef"><b>Definition:</b> <a href="curl_8h_source.html#l00569">curl.h:569</a></div></div>
<div class="ttc" id="url_8h_html"><div class="ttname"><a href="url_8h.html">url.h</a></div></div>
<div class="ttc" id="get_8d_html_a38b0ef81b65f2aee282c8c217a123176"><div class="ttname"><a href="get_8d.html#a38b0ef81b65f2aee282c8c217a123176">data</a></div><div class="ttdeci">Long this option will make all data specified with data</div><div class="ttdef"><b>Definition:</b> <a href="get_8d_source.html#l00005">get.d:5</a></div></div>
<div class="ttc" id="structconnectdata_html"><div class="ttname"><a href="structconnectdata.html">connectdata</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00782">urldata.h:782</a></div></div>
<div class="ttc" id="urldata_8h_html_ace0075850efad1d17ded7b56129fb3d1aff18b454b42fb95d95e3fd93130a5508"><div class="ttname"><a href="urldata_8h.html#ace0075850efad1d17ded7b56129fb3d1aff18b454b42fb95d95e3fd93130a5508">ssl_connect_1</a></div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00179">urldata.h:179</a></div></div>
<div class="ttc" id="unit1602_8c_html_a35af0be900467fedbb610bd6ea65ed78"><div class="ttname"><a href="unit1602_8c.html#a35af0be900467fedbb610bd6ea65ed78">key</a></div><div class="ttdeci">int key</div><div class="ttdef"><b>Definition:</b> <a href="unit1602_8c_source.html#l00056">unit1602.c:56</a></div></div>
<div class="ttc" id="x509asn1_8h_html"><div class="ttname"><a href="x509asn1_8h.html">x509asn1.h</a></div></div>
<div class="ttc" id="struct_connect_bits_html_a0a00cd02ce442392e3836545ce356b6a"><div class="ttname"><a href="struct_connect_bits.html#a0a00cd02ce442392e3836545ce356b6a">ConnectBits::tls_enable_npn</a></div><div class="ttdeci">bool tls_enable_npn</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00439">urldata.h:439</a></div></div>
<div class="ttc" id="vtls_8h_html_a06f0fb1d7887e2395f579c430c55e9da"><div class="ttname"><a href="vtls_8h.html#a06f0fb1d7887e2395f579c430c55e9da">Curl_none_set_engine_default</a></div><div class="ttdeci">CURLcode Curl_none_set_engine_default(struct Curl_easy *data)</div></div>
<div class="ttc" id="structdata_html"><div class="ttname"><a href="structdata.html">data</a></div><div class="ttdef"><b>Definition:</b> <a href="debug_8c_source.html#l00029">debug.c:29</a></div></div>
<div class="ttc" id="vtls_8h_html_a054a6a646a0108d8f91a503d31a21671"><div class="ttname"><a href="vtls_8h.html#a054a6a646a0108d8f91a503d31a21671">Curl_none_close_all</a></div><div class="ttdeci">void Curl_none_close_all(struct Curl_easy *data)</div></div>
<div class="ttc" id="curl__setup_8h_html_a1c6e64692c9b7c6e7dc70adb398b3115"><div class="ttname"><a href="curl__setup_8h.html#a1c6e64692c9b7c6e7dc70adb398b3115">struct_stat</a></div><div class="ttdeci">#define struct_stat</div><div class="ttdef"><b>Definition:</b> <a href="curl__setup_8h_source.html#l00389">curl_setup.h:389</a></div></div>
<div class="ttc" id="vtls_8h_html_ad333981ba88648c413730d21d5418405"><div class="ttname"><a href="vtls_8h.html#ad333981ba88648c413730d21d5418405">SSL_IS_PROXY</a></div><div class="ttdeci">#define SSL_IS_PROXY()</div><div class="ttdef"><b>Definition:</b> <a href="vtls_8h_source.html#l00133">vtls.h:133</a></div></div>
<div class="ttc" id="structconnectdata_html_a3df7eee97914936f17a228eb2cf84eed"><div class="ttname"><a href="structconnectdata.html#a3df7eee97914936f17a228eb2cf84eed">connectdata::data</a></div><div class="ttdeci">struct Curl_easy * data</div><div class="ttdef"><b>Definition:</b> <a href="urldata_8h_source.html#l00786">urldata.h:786</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_409f97388efe006bc3438b95e9edef48.html">components</a></li><li class="navelem"><a class="el" href="dir_e9014474357f0c50c4c87dd9066e36b7.html">curl</a></li><li class="navelem"><a class="el" href="dir_efb6013f246e7f8b3181c5014844a411.html">lib</a></li><li class="navelem"><a class="el" href="dir_c8d0f45061db60a99b5caea59b58f693.html">vtls</a></li><li class="navelem"><a class="el" href="nss_8c.html">nss.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
