<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Plante: esp32-snippets/cpp_utils/WebSocketFileTransfer.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Plante
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_web_socket_file_transfer_8cpp_source.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">WebSocketFileTransfer.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_web_socket_file_transfer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * WebSocketFileTransfer.cpp</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *  Created on: Sep 9, 2017</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *      Author: kolban</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;esp_log.h&gt;</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_general_utils_8h.html">GeneralUtils.h</a>&quot;</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_j_s_o_n_8h.html">JSON.h</a>&quot;</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* LOG_TAG = <span class="stringliteral">&quot;WebSocketFileTransfer&quot;</span>;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="_web_socket_file_transfer_8h.html">WebSocketFileTransfer.h</a>&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#undef close</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno"><a class="line" href="class_web_socket_file_transfer.html#ae433a614d98adfb814f453de641092d9">   23</a></span>&#160;<a class="code" href="class_web_socket_file_transfer.html#ae433a614d98adfb814f453de641092d9">WebSocketFileTransfer::WebSocketFileTransfer</a>(<a class="code" href="connect-to_8d.html#a450c41f520f7661f0a48b8fd2597a74c">std::string</a> rootPath) {</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="comment">// If the root path doesn&#39;t end with a &#39;/&#39;, add one.</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="class_general_utils.html#ade237631b5595e2426f9e86fc6e38932">GeneralUtils::endsWith</a>(rootPath, <span class="charliteral">&#39;/&#39;</span>)) {</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        rootPath += <span class="charliteral">&#39;/&#39;</span>;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;    }</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    m_rootPath   = rootPath;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    m_pWebSocket = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="keywordflow">if</span> (rootPath.empty()) {</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        ESP_LOGE(LOG_TAG, <span class="stringliteral">&quot;Root path can not be empty&quot;</span>);</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_rootPath.substr(m_rootPath.size() - 1) != <span class="stringliteral">&quot;/&quot;</span>) {</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        ESP_LOGE(LOG_TAG, <span class="stringliteral">&quot;Root path must end with a \&quot;/\&quot;&quot;</span>);</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    }</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;} <span class="comment">// WebSocketFileTransfer</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">// Hide the class in an un-named namespace</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">namespace </span>{</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">class </span>FileTransferWebSocketHandler : <span class="keyword">public</span> <a class="code" href="class_web_socket_handler.html">WebSocketHandler</a> {</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    FileTransferWebSocketHandler(<a class="code" href="connect-to_8d.html#a450c41f520f7661f0a48b8fd2597a74c">std::string</a> rootPath) {</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        m_fileName     = <span class="stringliteral">&quot;&quot;</span>;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        m_fileLength   = 0;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        m_sizeReceived = 0;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        m_active       = <span class="keyword">false</span>;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        m_rootPath     = rootPath;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    } <span class="comment">// FileTransferWebSocketHandler</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="keyword">virtual</span> <span class="keywordtype">void</span> onMessage(<a class="code" href="class_web_socket_input_streambuf.html">WebSocketInputStreambuf</a>* pWebSocketInputStreambuf) {</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        ESP_LOGD(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; onMessage&quot;</span>);</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="comment">// Test to see if we are currently active.  If not, this is the start of a transfer.</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        <span class="keywordflow">if</span> (!m_active) {</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;            ESP_LOGD(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;Not yet active!&quot;</span>);</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;            <span class="comment">// Read a chunk of data into memory.</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;            std::stringstream <a class="code" href="unit1308_8c.html#a70a830d3039f37216dde9bcf2460aec2">buffer</a>;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;            <a class="code" href="unit1308_8c.html#a70a830d3039f37216dde9bcf2460aec2">buffer</a> &lt;&lt; pWebSocketInputStreambuf;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;            ESP_LOGD(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;Data read: %s&quot;</span>, <a class="code" href="unit1308_8c.html#a70a830d3039f37216dde9bcf2460aec2">buffer</a>.str().c_str());</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;            <span class="comment">// We expect the first chunk received to be a JSON object that contains</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;            <span class="comment">// {</span></div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;            <span class="comment">//    &quot;name&quot;:   &lt;fileName&gt;,      // Name of file to create.</span></div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;            <span class="comment">//    &quot;length&quot;: &lt;lengthOfFile&gt;   // Length of file. Optional.</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;            <span class="comment">// }</span></div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;            <a class="code" href="class_json_object.html">JsonObject</a> jo = <a class="code" href="class_j_s_o_n.html#af0f79af48a9d177bfbdebc1fbf5ef8c0">JSON::parseObject</a>(<a class="code" href="unit1308_8c.html#a70a830d3039f37216dde9bcf2460aec2">buffer</a>.str());</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;            m_fileName  = jo.<a class="code" href="class_json_object.html#a2d38de00713456e0c9f788c8b07b6506">getString</a>(<span class="stringliteral">&quot;name&quot;</span>);</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;            <a class="code" href="test1_8c.html#a74bb3debd3b0d3f9c3fe210442b4cacc">assert</a>(m_fileName.length() &gt; 0); <span class="comment">// Doesn&#39;t make any sense to receive a zero length file name.</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            <span class="keywordflow">if</span> (jo.hasItem(<span class="stringliteral">&quot;length&quot;</span>)) {</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                m_fileLength  = jo.getInt(<span class="stringliteral">&quot;length&quot;</span>);</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            }</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;            <a class="code" href="connect-to_8d.html#a450c41f520f7661f0a48b8fd2597a74c">std::string</a> fileName = m_rootPath + m_fileName;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            ESP_LOGD(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;Target file is %s&quot;</span>, fileName.c_str());</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;            <span class="comment">// If the file to create ends in a &quot;/&quot; then we are being asked to create a directory.</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            <span class="keywordflow">if</span> (m_fileName.substr(m_fileName.size() - 1) == <span class="stringliteral">&quot;/&quot;</span>) {</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                ESP_LOGD(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;Is a directory!!&quot;</span>);</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                fileName = fileName.substr(0, fileName.size() - 1);   <span class="comment">// Remove the trailing slash</span></div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                <span class="keyword">struct </span><a class="code" href="config-win32ce_8h.html#ad4ea824bd0fcae61733c900a5cab1e01">stat</a> statbuf;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="config-win32ce_8h.html#ad4ea824bd0fcae61733c900a5cab1e01">stat</a>(fileName.c_str(), &amp;statbuf) == 0) {</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;                    <span class="keywordflow">if</span> (S_ISREG(statbuf.st_mode)) {</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;                        ESP_LOGE(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;File already exists and is a file not a directory!&quot;</span>);</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;                    }</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;                } <span class="comment">// Stat the directory we are trying to create.</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;                <span class="keywordflow">else</span> { <span class="comment">// The stat on the path failed ... which is ok, as it likely means that the entry didn&#39;t exist.</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                    <span class="keywordflow">if</span> (mkdir(fileName.c_str(), 0) != 0) {</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;                        ESP_LOGE(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;Failed to make directory \&quot;%s\&quot;, error: %s&quot;</span>, fileName.c_str(), <a class="code" href="namespaceimpacket_1_1nmb.html#ae08ba7342be906ac4e49aa4746c2242d">strerror</a>(errno));</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;                    }</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;                }</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            }</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            <span class="comment">// We are NOT creating a directory but are instead creating a file.</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            <span class="keywordflow">else</span> {</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;                m_ofStream.open(fileName, std::ofstream::out | std::ofstream::binary | std::ofstream::trunc);</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;                <span class="keywordflow">if</span> (!m_ofStream.is_open()) {</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                    ESP_LOGE(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;Failed to open file %s for writing&quot;</span>, m_fileName.c_str());</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;                    <span class="keywordflow">return</span>;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                }</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            }</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            m_active = <span class="keyword">true</span>;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            ESP_LOGD(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;Filename: %s, length: %d&quot;</span>, fileName.c_str(), m_fileLength);</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        } <span class="comment">// !active --- Not active</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="keywordflow">else</span> {</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            <span class="comment">// We are about to receive a chunk of file</span></div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;            m_ofStream &lt;&lt; pWebSocketInputStreambuf;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            <span class="comment">/*</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">            std::stringstream bufferStream;</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">            bufferStream &lt;&lt; pWebSocketInputRecordStreambuf;</span></div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment">            m_sizeReceived += bufferStream.str().length();</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">            ESP_LOGD(&quot;FileTransferWebSocketHandler&quot;, &quot;Received %d bytes of file data&quot;, bufferStream.str().length());</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">            if (m_fileLength &gt; 0 &amp;&amp; m_sizeReceived &gt; m_fileLength) {</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">                ESP_LOGD(&quot;FileTransferWebSocketHandler&quot;,</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">                    &quot;ERROR: Received a total of %d bytes when only %d bytes expected!&quot;, m_sizeReceived, m_fileLength);</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">            }</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">            */</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        }</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    } <span class="comment">// onMessage</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="keyword">virtual</span> <span class="keywordtype">void</span> onClose() {</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        ESP_LOGD(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>, <span class="stringliteral">&quot;&gt;&gt; onClose: fileName: %s, sizeReceived: %d&quot;</span>, m_fileName.c_str(), m_sizeReceived);</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="keywordflow">if</span> (m_fileLength &gt; 0 &amp;&amp; m_sizeReceived != m_fileLength) {</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;            ESP_LOGD(<span class="stringliteral">&quot;FileTransferWebSocketHandler&quot;</span>,</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                <span class="stringliteral">&quot;ERROR: Transfer finished but we received total of %d bytes and expected %d bytes!&quot;</span>, m_sizeReceived, m_fileLength);</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        }</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        <span class="keywordflow">if</span> (m_ofStream.is_open()) {</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;            m_ofStream.close();   <span class="comment">// Close the file now that we have finished writing to it.</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        }</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;        <span class="keyword">delete</span> <span class="keyword">this</span>;   <span class="comment">// Delete ourselves.</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    } <span class="comment">// onClose</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="keyword">private</span>:</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <a class="code" href="connect-to_8d.html#a450c41f520f7661f0a48b8fd2597a74c">std::string</a>   m_fileName;     <span class="comment">// The name of the file we are receiving.</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    uint32_t      m_fileLength; <span class="comment">// We may optionally receive a file length.</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    uint32_t      m_sizeReceived;  <span class="comment">// The size of the data actually received so far.</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordtype">bool</span>          m_active;     <span class="comment">// Are we actively processing a file.</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    std::ofstream m_ofStream;     <span class="comment">// The file stream we are writing to when active.</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <a class="code" href="connect-to_8d.html#a450c41f520f7661f0a48b8fd2597a74c">std::string</a>   m_rootPath;     <span class="comment">// The root path for file names.</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;}; <span class="comment">// FileTransferWebSocketHandler</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;} <span class="comment">// End un-named namespace</span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;</div><div class="line"><a name="l00153"></a><span class="lineno"><a class="line" href="class_web_socket_file_transfer.html#a0b7ac22bf575de8bd0a6e45b9c1a0772">  153</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_web_socket_file_transfer.html#a0b7ac22bf575de8bd0a6e45b9c1a0772">WebSocketFileTransfer::start</a>(<a class="code" href="class_web_socket.html">WebSocket</a>* pWebSocket) {</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    ESP_LOGD(LOG_TAG, <span class="stringliteral">&quot;&gt;&gt; start&quot;</span>);</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    pWebSocket-&gt;<a class="code" href="class_web_socket.html#aad812ebe8eb8405006c0ed8c8e567239">setHandler</a>(<span class="keyword">new</span> FileTransferWebSocketHandler(m_rootPath));</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;} <span class="comment">// start</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="ttc" id="_general_utils_8h_html"><div class="ttname"><a href="_general_utils_8h.html">GeneralUtils.h</a></div></div>
<div class="ttc" id="class_web_socket_file_transfer_html_ae433a614d98adfb814f453de641092d9"><div class="ttname"><a href="class_web_socket_file_transfer.html#ae433a614d98adfb814f453de641092d9">WebSocketFileTransfer::WebSocketFileTransfer</a></div><div class="ttdeci">WebSocketFileTransfer(std::string rootPath)</div><div class="ttdoc">Constructor. </div><div class="ttdef"><b>Definition:</b> <a href="_web_socket_file_transfer_8cpp_source.html#l00023">WebSocketFileTransfer.cpp:23</a></div></div>
<div class="ttc" id="config-win32ce_8h_html_ad4ea824bd0fcae61733c900a5cab1e01"><div class="ttname"><a href="config-win32ce_8h.html#ad4ea824bd0fcae61733c900a5cab1e01">stat</a></div><div class="ttdeci">int stat(const char *path, struct stat *buffer)</div></div>
<div class="ttc" id="class_web_socket_file_transfer_html_a0b7ac22bf575de8bd0a6e45b9c1a0772"><div class="ttname"><a href="class_web_socket_file_transfer.html#a0b7ac22bf575de8bd0a6e45b9c1a0772">WebSocketFileTransfer::start</a></div><div class="ttdeci">void start(WebSocket *pWebSocket)</div><div class="ttdef"><b>Definition:</b> <a href="_web_socket_file_transfer_8cpp_source.html#l00153">WebSocketFileTransfer.cpp:153</a></div></div>
<div class="ttc" id="class_json_object_html_a2d38de00713456e0c9f788c8b07b6506"><div class="ttname"><a href="class_json_object.html#a2d38de00713456e0c9f788c8b07b6506">JsonObject::getString</a></div><div class="ttdeci">std::string getString(std::string name)</div><div class="ttdoc">Get the named string value from the object. </div><div class="ttdef"><b>Definition:</b> <a href="_j_s_o_n_8cpp_source.html#l00274">JSON.cpp:274</a></div></div>
<div class="ttc" id="connect-to_8d_html_a450c41f520f7661f0a48b8fd2597a74c"><div class="ttname"><a href="connect-to_8d.html#a450c41f520f7661f0a48b8fd2597a74c">string</a></div><div class="ttdeci">Long connect to e.g.at a specific cluster node in a cluster of servers.This option is only used to establish the network connection.It does NOT affect the hostname port that is used for TLS meaning any host port.HOST2 and PORT2 may also be the empty string</div><div class="ttdef"><b>Definition:</b> <a href="connect-to_8d_source.html#l00014">connect-to.d:14</a></div></div>
<div class="ttc" id="class_web_socket_html_aad812ebe8eb8405006c0ed8c8e567239"><div class="ttname"><a href="class_web_socket.html#aad812ebe8eb8405006c0ed8c8e567239">WebSocket::setHandler</a></div><div class="ttdeci">void setHandler(WebSocketHandler *handler)</div><div class="ttdoc">Set the Web socket handler associated with this Websocket. </div><div class="ttdef"><b>Definition:</b> <a href="_web_socket_8cpp_source.html#l00382">WebSocket.cpp:382</a></div></div>
<div class="ttc" id="namespaceimpacket_1_1nmb_html_ae08ba7342be906ac4e49aa4746c2242d"><div class="ttname"><a href="namespaceimpacket_1_1nmb.html#ae08ba7342be906ac4e49aa4746c2242d">impacket.nmb.strerror</a></div><div class="ttdeci">def strerror(errclass, errcode)</div><div class="ttdef"><b>Definition:</b> <a href="nmb_8py_source.html#l00140">nmb.py:140</a></div></div>
<div class="ttc" id="unit1308_8c_html_a70a830d3039f37216dde9bcf2460aec2"><div class="ttname"><a href="unit1308_8c.html#a70a830d3039f37216dde9bcf2460aec2">buffer</a></div><div class="ttdeci">char buffer[]</div><div class="ttdef"><b>Definition:</b> <a href="unit1308_8c_source.html#l00048">unit1308.c:48</a></div></div>
<div class="ttc" id="_j_s_o_n_8h_html"><div class="ttname"><a href="_j_s_o_n_8h.html">JSON.h</a></div></div>
<div class="ttc" id="class_web_socket_input_streambuf_html"><div class="ttname"><a href="class_web_socket_input_streambuf.html">WebSocketInputStreambuf</a></div><div class="ttdef"><b>Definition:</b> <a href="_web_socket_8h_source.html#l00021">WebSocket.h:21</a></div></div>
<div class="ttc" id="class_web_socket_handler_html"><div class="ttname"><a href="class_web_socket_handler.html">WebSocketHandler</a></div><div class="ttdef"><b>Definition:</b> <a href="_web_socket_8h_source.html#l00047">WebSocket.h:47</a></div></div>
<div class="ttc" id="_web_socket_file_transfer_8h_html"><div class="ttname"><a href="_web_socket_file_transfer_8h.html">WebSocketFileTransfer.h</a></div></div>
<div class="ttc" id="class_web_socket_html"><div class="ttname"><a href="class_web_socket.html">WebSocket</a></div><div class="ttdef"><b>Definition:</b> <a href="_web_socket_8h_source.html#l00060">WebSocket.h:60</a></div></div>
<div class="ttc" id="class_general_utils_html_ade237631b5595e2426f9e86fc6e38932"><div class="ttname"><a href="class_general_utils.html#ade237631b5595e2426f9e86fc6e38932">GeneralUtils::endsWith</a></div><div class="ttdeci">static bool endsWith(std::string str, char c)</div><div class="ttdoc">Does the string end with a specific character? </div><div class="ttdef"><b>Definition:</b> <a href="_general_utils_8cpp_source.html#l00126">GeneralUtils.cpp:126</a></div></div>
<div class="ttc" id="class_json_object_html"><div class="ttname"><a href="class_json_object.html">JsonObject</a></div><div class="ttdoc">A JSON object. </div><div class="ttdef"><b>Definition:</b> <a href="_j_s_o_n_8h_source.html#l00066">JSON.h:66</a></div></div>
<div class="ttc" id="class_j_s_o_n_html_af0f79af48a9d177bfbdebc1fbf5ef8c0"><div class="ttname"><a href="class_j_s_o_n.html#af0f79af48a9d177bfbdebc1fbf5ef8c0">JSON::parseObject</a></div><div class="ttdeci">static JsonObject parseObject(std::string text)</div><div class="ttdoc">Parse a string that contains a JSON object. </div><div class="ttdef"><b>Definition:</b> <a href="_j_s_o_n_8cpp_source.html#l00067">JSON.cpp:67</a></div></div>
<div class="ttc" id="test1_8c_html_a74bb3debd3b0d3f9c3fe210442b4cacc"><div class="ttname"><a href="test1_8c.html#a74bb3debd3b0d3f9c3fe210442b4cacc">assert</a></div><div class="ttdeci">#define assert(a, b, c, d)</div><div class="ttdef"><b>Definition:</b> <a href="test1_8c_source.html#l00202">test1.c:202</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_2b66d65f09a100230911d819a169d69c.html">esp32-snippets</a></li><li class="navelem"><a class="el" href="dir_e66062f3a4d2a5b6b6746a6b0f9c85ac.html">cpp_utils</a></li><li class="navelem"><a class="el" href="_web_socket_file_transfer_8cpp.html">WebSocketFileTransfer.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
