<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Plante: esp32-snippets/hardware/rtc/ds1307.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Plante
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ds1307_8c_source.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ds1307.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="ds1307_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &lt;apps/sntp/sntp.h&gt;</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &lt;driver/i2c.h&gt;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &lt;esp_log.h&gt;</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &lt;freertos/FreeRTOS.h&gt;</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;freertos/task.h&gt;</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;lwip/sockets.h&gt;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &quot;sdkconfig.h&quot;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno"><a class="line" href="ds1307_8c.html#a526d580d324bce60a3e964066fae77e3">   12</a></span>&#160;<span class="preprocessor">#define SDA_PIN 18</span></div><div class="line"><a name="l00013"></a><span class="lineno"><a class="line" href="ds1307_8c.html#a06c967e78bcedcee909a70764f879433">   13</a></span>&#160;<span class="preprocessor">#define SCL_PIN 19</span></div><div class="line"><a name="l00014"></a><span class="lineno"><a class="line" href="ds1307_8c.html#a647261f334080cbf95e4f8dd79f73769">   14</a></span>&#160;<span class="preprocessor">#define DS1307_ADDRESS 0x68</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>[] = <span class="stringliteral">&quot;ds1307&quot;</span>;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">static</span> uint8_t intToBCD(uint8_t num) {</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    <span class="keywordflow">return</span> ((num / 10) &lt;&lt; 4) | (num%10);</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;}</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">static</span> uint8_t bcdToInt(uint8_t bcd) {</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <span class="comment">// 0x10</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="keywordflow">return</span> ((bcd &gt;&gt; 4) * 10) + (bcd &amp; 0x0f);;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;}</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="sntp_8c.html#aaf9904cbe14cd29a0d4f37c14de16b51">startSNTP</a>() {</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    ip_addr_t addr;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    sntp_setoperatingmode(SNTP_OPMODE_POLL);</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <a class="code" href="connect__with__static__ip_8c.html#a4a705192be3844fa0fe58f6337391983">inet_pton</a>(AF_INET, <span class="stringliteral">&quot;129.6.15.28&quot;</span>, &amp;addr);</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    sntp_setserver(0, &amp;addr);</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    sntp_init();</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;}</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pcf8523_8c.html#abe298a3c1d98035cebe8b0535db549fa">initI2C</a>() {</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    i2c_config_t conf;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    conf.mode = I2C_MODE_MASTER;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    conf.sda_io_num = <a class="code" href="ds1307_8c.html#a526d580d324bce60a3e964066fae77e3">SDA_PIN</a>;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    conf.scl_io_num = <a class="code" href="ds1307_8c.html#a06c967e78bcedcee909a70764f879433">SCL_PIN</a>;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    conf.sda_pullup_en = GPIO_PULLUP_ENABLE;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    conf.scl_pullup_en = GPIO_PULLUP_ENABLE;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    conf.master.clk_speed = 100000;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_param_config(I2C_NUM_0, &amp;conf));</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_driver_install(I2C_NUM_0, I2C_MODE_MASTER, 0, 0, 0));</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;}</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment"> * The value read from the DS1307 is 7 bytes encoded in BCD:</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment"> * 0 - Seconds - 00-59</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment"> * 1 - Minutes - 00-59</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment"> * 2 - Hours   - 00-23</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment"> * 3 - Day     - 01-07</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment"> * 4 - Date    - 01-31</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment"> * 5 - Month   - 01-12</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment"> * 6 - Year    - 00-99</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment"> */</span></div><div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="ds1307_8c.html#ab5bb68d2d42f0ea5b4cfbdb83c151739">   59</a></span>&#160;time_t <a class="code" href="ds1307_8c.html#ab5bb68d2d42f0ea5b4cfbdb83c151739">readValue</a>() {</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    i2c_cmd_handle_t cmd = i2c_cmd_link_create();</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_start(cmd));</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, (<a class="code" href="ds1307_8c.html#a647261f334080cbf95e4f8dd79f73769">DS1307_ADDRESS</a> &lt;&lt; 1) | I2C_MASTER_WRITE, 1 <span class="comment">/* expect ack */</span>));</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, 0x0, 1));</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_start(cmd));</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, (<a class="code" href="ds1307_8c.html#a647261f334080cbf95e4f8dd79f73769">DS1307_ADDRESS</a> &lt;&lt; 1) | I2C_MASTER_READ, 1 <span class="comment">/* expect ack */</span>));</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    uint8_t <a class="code" href="structdata.html">data</a>[7];</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_read(cmd, <a class="code" href="structdata.html">data</a>, 7, 0));</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_stop(cmd));</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_cmd_begin(I2C_NUM_0, cmd, 1000/portTICK_PERIOD_MS));</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    i2c_cmd_link_delete(cmd);</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>=0; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>&lt;7; <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>++) {</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        ESP_LOGD(<a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>, <span class="stringliteral">&quot;%d: 0x%.2x&quot;</span>, <a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>, <a class="code" href="structdata.html">data</a>[<a class="code" href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a>]);</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    }</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    <span class="keyword">struct </span>tm tm;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    tm.tm_sec  = bcdToInt(<a class="code" href="structdata.html">data</a>[0]);</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    tm.tm_min  = bcdToInt(<a class="code" href="structdata.html">data</a>[1]);</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    tm.tm_hour = bcdToInt(<a class="code" href="structdata.html">data</a>[2]);</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    tm.tm_mday = bcdToInt(<a class="code" href="structdata.html">data</a>[4]);</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    tm.tm_mon  = bcdToInt(<a class="code" href="structdata.html">data</a>[5]) - 1; <span class="comment">// 0-11 - Note: The month on the DS1307 is 1-12.</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    tm.tm_year = bcdToInt(<a class="code" href="structdata.html">data</a>[6]) + 100; <span class="comment">// Years since 1900</span></div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    time_t readTime = mktime(&amp;tm);</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="keywordflow">return</span> readTime;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;}</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno"><a class="line" href="ds1307_8c.html#ab622fb835164fca5fa1156b195fe7148">   88</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="ds1307_8c.html#ab622fb835164fca5fa1156b195fe7148">writeValue</a>(time_t newTime) {</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    ESP_LOGD(<a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>, <span class="stringliteral">&quot;&gt;&gt; writeValue: %ld&quot;</span>, newTime);</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    <span class="keyword">struct </span>tm tm;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    gmtime_r(&amp;newTime, &amp;tm);</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keywordtype">char</span> <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>[30];</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    ESP_LOGD(<a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>, <span class="stringliteral">&quot; - %s&quot;</span>, asctime_r(&amp;tm, <a class="code" href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a>));</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    esp_err_t errRc;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    i2c_cmd_handle_t cmd = i2c_cmd_link_create();</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_start(cmd));</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, (<a class="code" href="ds1307_8c.html#a647261f334080cbf95e4f8dd79f73769">DS1307_ADDRESS</a> &lt;&lt; 1) | I2C_MASTER_WRITE, 1 <span class="comment">/* expect ack */</span>));</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, 0x0, 1));</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, intToBCD(tm.tm_sec), 1));      <span class="comment">// seconds</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, intToBCD(tm.tm_min), 1 ));     <span class="comment">// minutes</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, intToBCD(tm.tm_hour), 1 ));    <span class="comment">// hours</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, intToBCD(tm.tm_wday+1), 1 ));  <span class="comment">// week day</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, intToBCD(tm.tm_mday), 1));     <span class="comment">// date of month</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, intToBCD(tm.tm_mon+1), 1));    <span class="comment">// month</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_write_byte(cmd, intToBCD(tm.tm_year-100), 1)); <span class="comment">// year</span></div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <a class="code" href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a>(i2c_master_stop(cmd));</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    errRc = i2c_master_cmd_begin(I2C_NUM_0, cmd, 1000/portTICK_PERIOD_MS);</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    <span class="keywordflow">if</span> (errRc != 0) {</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        ESP_LOGE(<a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>, <span class="stringliteral">&quot;i2c_master_cmd_begin: %d&quot;</span>, errRc);</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    }</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    i2c_cmd_link_delete(cmd);</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;}</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="ds1307_8c.html#ac933fe41bc5ec4590e601279332f7642">  115</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="ds1307_8c.html#ac933fe41bc5ec4590e601279332f7642">task_ds1307</a>(<span class="keywordtype">void</span> *ignore) {</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keywordtype">int</span> doWrite = 1;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    ESP_LOGD(<a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>, <span class="stringliteral">&quot;&gt;&gt; ds1307&quot;</span>);</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <a class="code" href="pcf8523_8c.html#abe298a3c1d98035cebe8b0535db549fa">initI2C</a>();</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keywordflow">if</span> (doWrite) {</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        <a class="code" href="sntp_8c.html#aaf9904cbe14cd29a0d4f37c14de16b51">startSNTP</a>();</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        time_t <a class="code" href="config_8d.html#adcde1b7c7daa51633da6a8a48ef59bec">t</a>;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        <span class="keywordflow">while</span>(<a class="code" href="retry-max-time_8d.html#a612021c6b1f447b49053406818ef4ee6">time</a>(&amp;<a class="code" href="config_8d.html#adcde1b7c7daa51633da6a8a48ef59bec">t</a>) &lt; 1000) {</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            ESP_LOGD(<a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>, <span class="stringliteral">&quot;Waiting for SNTP ...&quot;</span>);</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;            vTaskDelay(1000/portTICK_PERIOD_MS);</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        }</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <a class="code" href="ds1307_8c.html#ab622fb835164fca5fa1156b195fe7148">writeValue</a>(<a class="code" href="config_8d.html#adcde1b7c7daa51633da6a8a48ef59bec">t</a>);</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    }</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordflow">while</span>(1) {</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        time_t <a class="code" href="config_8d.html#adcde1b7c7daa51633da6a8a48ef59bec">t</a> = <a class="code" href="retry-max-time_8d.html#a612021c6b1f447b49053406818ef4ee6">time</a>(NULL);</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        ESP_LOGD(<a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>, <span class="stringliteral">&quot;time: %ld&quot;</span>, <a class="code" href="config_8d.html#adcde1b7c7daa51633da6a8a48ef59bec">t</a>);</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <a class="code" href="config_8d.html#adcde1b7c7daa51633da6a8a48ef59bec">t</a> = <a class="code" href="ds1307_8c.html#ab5bb68d2d42f0ea5b4cfbdb83c151739">readValue</a>();</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        ESP_LOGD(<a class="code" href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a>, <span class="stringliteral">&quot;Read from DS1307: %ld&quot;</span>, <a class="code" href="config_8d.html#adcde1b7c7daa51633da6a8a48ef59bec">t</a>);</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;        vTaskDelay(1000/portTICK_PERIOD_MS);</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    }</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;}</div><div class="ttc" id="pcf8523_8c_html_abe298a3c1d98035cebe8b0535db549fa"><div class="ttname"><a href="pcf8523_8c.html#abe298a3c1d98035cebe8b0535db549fa">initI2C</a></div><div class="ttdeci">void initI2C()</div><div class="ttdef"><b>Definition:</b> <a href="pcf8523_8c_source.html#l00029">pcf8523.c:29</a></div></div>
<div class="ttc" id="mpu6050_8c_html_a7d1b7992aa421f10dc473db899dcff8b"><div class="ttname"><a href="mpu6050_8c.html#a7d1b7992aa421f10dc473db899dcff8b">ESP_ERROR_CHECK</a></div><div class="ttdeci">#define ESP_ERROR_CHECK(x)</div><div class="ttdef"><b>Definition:</b> <a href="mpu6050_8c_source.html#l00037">mpu6050.c:37</a></div></div>
<div class="ttc" id="retry-max-time_8d_html_a612021c6b1f447b49053406818ef4ee6"><div class="ttname"><a href="retry-max-time_8d.html#a612021c6b1f447b49053406818ef4ee6">time</a></div><div class="ttdeci">Long the request will be made and while it may take longer than this given time period.To limit a single request s maximum time</div><div class="ttdef"><b>Definition:</b> <a href="retry-max-time_8d_source.html#l00008">retry-max-time.d:8</a></div></div>
<div class="ttc" id="connect__with__static__ip_8c_html_a4a705192be3844fa0fe58f6337391983"><div class="ttname"><a href="connect__with__static__ip_8c.html#a4a705192be3844fa0fe58f6337391983">inet_pton</a></div><div class="ttdeci">inet_pton(AF_INET, DEVICE_IP, &amp;ipInfo.ip)</div></div>
<div class="ttc" id="ble1_8c_html_afec25c5f400b1e2ff79878c038385f0d"><div class="ttname"><a href="ble1_8c.html#afec25c5f400b1e2ff79878c038385f0d">tag</a></div><div class="ttdeci">#define tag</div><div class="ttdef"><b>Definition:</b> <a href="ble1_8c_source.html#l00027">ble1.c:27</a></div></div>
<div class="ttc" id="unit1303_8c_html_ac8936188af0c1d2f8b9d0cd25fde43b2"><div class="ttname"><a href="unit1303_8c.html#ac8936188af0c1d2f8b9d0cd25fde43b2">i</a></div><div class="ttdeci">unsigned int i</div><div class="ttdef"><b>Definition:</b> <a href="unit1303_8c_source.html#l00078">unit1303.c:78</a></div></div>
<div class="ttc" id="ds1307_8c_html_a06c967e78bcedcee909a70764f879433"><div class="ttname"><a href="ds1307_8c.html#a06c967e78bcedcee909a70764f879433">SCL_PIN</a></div><div class="ttdeci">#define SCL_PIN</div><div class="ttdef"><b>Definition:</b> <a href="ds1307_8c_source.html#l00013">ds1307.c:13</a></div></div>
<div class="ttc" id="ds1307_8c_html_ac933fe41bc5ec4590e601279332f7642"><div class="ttname"><a href="ds1307_8c.html#ac933fe41bc5ec4590e601279332f7642">task_ds1307</a></div><div class="ttdeci">void task_ds1307(void *ignore)</div><div class="ttdef"><b>Definition:</b> <a href="ds1307_8c_source.html#l00115">ds1307.c:115</a></div></div>
<div class="ttc" id="ds1307_8c_html_ab5bb68d2d42f0ea5b4cfbdb83c151739"><div class="ttname"><a href="ds1307_8c.html#ab5bb68d2d42f0ea5b4cfbdb83c151739">readValue</a></div><div class="ttdeci">time_t readValue()</div><div class="ttdef"><b>Definition:</b> <a href="ds1307_8c_source.html#l00059">ds1307.c:59</a></div></div>
<div class="ttc" id="ds1307_8c_html_a526d580d324bce60a3e964066fae77e3"><div class="ttname"><a href="ds1307_8c.html#a526d580d324bce60a3e964066fae77e3">SDA_PIN</a></div><div class="ttdeci">#define SDA_PIN</div><div class="ttdef"><b>Definition:</b> <a href="ds1307_8c_source.html#l00012">ds1307.c:12</a></div></div>
<div class="ttc" id="unit1398_8c_html_aee5a1edd73e85934dcbe27ccbb1ef1ad"><div class="ttname"><a href="unit1398_8c.html#aee5a1edd73e85934dcbe27ccbb1ef1ad">buf</a></div><div class="ttdeci">char buf[3]</div><div class="ttdef"><b>Definition:</b> <a href="unit1398_8c_source.html#l00032">unit1398.c:32</a></div></div>
<div class="ttc" id="config_8d_html_adcde1b7c7daa51633da6a8a48ef59bec"><div class="ttname"><a href="config_8d.html#adcde1b7c7daa51633da6a8a48ef59bec">t</a></div><div class="ttdeci">Long separated by or the equals sign.Long option names can optionally be given in the config file without the initial double dashes and if the colon or equals characters can be used as separators.If the option is specified with one or two there can be no colon or equals character between the option and its parameter.If the parameter is to contain the parameter must be enclosed within quotes.Within double the following escape sequences are t</div><div class="ttdef"><b>Definition:</b> <a href="config_8d_source.html#l00011">config.d:11</a></div></div>
<div class="ttc" id="ds1307_8c_html_ab622fb835164fca5fa1156b195fe7148"><div class="ttname"><a href="ds1307_8c.html#ab622fb835164fca5fa1156b195fe7148">writeValue</a></div><div class="ttdeci">void writeValue(time_t newTime)</div><div class="ttdef"><b>Definition:</b> <a href="ds1307_8c_source.html#l00088">ds1307.c:88</a></div></div>
<div class="ttc" id="sntp_8c_html_aaf9904cbe14cd29a0d4f37c14de16b51"><div class="ttname"><a href="sntp_8c.html#aaf9904cbe14cd29a0d4f37c14de16b51">startSNTP</a></div><div class="ttdeci">void startSNTP()</div><div class="ttdef"><b>Definition:</b> <a href="sntp_8c_source.html#l00014">sntp.c:14</a></div></div>
<div class="ttc" id="ds1307_8c_html_a647261f334080cbf95e4f8dd79f73769"><div class="ttname"><a href="ds1307_8c.html#a647261f334080cbf95e4f8dd79f73769">DS1307_ADDRESS</a></div><div class="ttdeci">#define DS1307_ADDRESS</div><div class="ttdef"><b>Definition:</b> <a href="ds1307_8c_source.html#l00014">ds1307.c:14</a></div></div>
<div class="ttc" id="structdata_html"><div class="ttname"><a href="structdata.html">data</a></div><div class="ttdef"><b>Definition:</b> <a href="debug_8c_source.html#l00029">debug.c:29</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_2b66d65f09a100230911d819a169d69c.html">esp32-snippets</a></li><li class="navelem"><a class="el" href="dir_3129719c13c172816610955a64eb5633.html">hardware</a></li><li class="navelem"><a class="el" href="dir_8ece05f80d37d1cbeb37de6c3dd398aa.html">rtc</a></li><li class="navelem"><a class="el" href="ds1307_8c.html">ds1307.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
